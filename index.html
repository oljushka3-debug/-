const API_URL = "https://script.google.com/macros/s/AKfycbyRW9aaMg2sIFWgvCeR_8B70f9_oPHYN0LP-u0Ky6w5m2VW0TSMRuQbXJNy_zp5cqjx/exec"; 
        let currentRate = 50.76;
        let mainData = [];

        function openModal(type) {
            document.getElementById('modal').classList.add('active');
            document.getElementById('txType').value = type;
            document.getElementById('merchantBlock').style.display = type === 'transfer' ? 'none' : 'block';
            document.getElementById('itemBlock').style.display = type === 'transfer' ? 'none' : 'block';
            
            if (type === 'transfer') {
                document.getElementById('modalTitle').innerText = '–ü–µ—Ä–µ–≤–æ–¥';
                document.getElementById('category').innerHTML = `
                    <option value="Sparkasse">–≤ Sparkasse</option>
                    <option value="–ü—Ä–∏–≤–∞—Ç">–≤ –ü—Ä–∏–≤–∞—Ç</option>
                    <option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–≤ –ù–∞–ª–∏—á–Ω—ã–µ EUR</option>
                    <option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–≤ –ù–∞–ª–∏—á–Ω—ã–µ UAH</option>
                `;
            } else {
                document.getElementById('modalTitle').innerText = type === 'expense' ? '–ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥' : '–ù–æ–≤—ã–π –¥–æ—Ö–æ–¥';
            }
        }

        function closeModal() { document.getElementById('modal').classList.remove('active'); document.getElementById('txForm').reset(); }

        async function loadData() {
            const script = document.createElement('script');
            script.src = `${API_URL}?callback=handleData`;
            document.body.appendChild(script);
        }

        function handleData(data) {
            mainData = data.rows;
            if (!localStorage.getItem('manualRate')) currentRate = data.rate;
            document.getElementById('manualRate').value = currentRate;
            updateBalance();
            renderHistory();
        }

        function updateBalance() {
            let balances = { "Sparkasse": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0 };
            mainData.forEach(r => {
                // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã: –±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–∫—É G (–∏–Ω–¥–µ–∫—Å 6)
                let val = parseFloat(r[6]);
                if (isNaN(val)) val = 0;
                const acc = r[9];
                if (balances.hasOwnProperty(acc)) {
                    if (r[8] === "üíé –î–æ—Ö–æ–¥") balances[acc] += val;
                    else balances[acc] -= val;
                }
            });
            document.getElementById('acc-sparkasse').innerText = `‚Ç¨ ${balances["Sparkasse"].toFixed(2)}`;
            document.getElementById('acc-privat').innerText = `‚Ç¥ ${balances["–ü—Ä–∏–≤–∞—Ç"].toFixed(2)}`;
            document.getElementById('acc-cash-eur').innerText = `‚Ç¨ ${balances["–ù–∞–ª–∏—á–Ω—ã–µ EUR"].toFixed(2)}`;
            document.getElementById('acc-cash-uah').innerText = `‚Ç¥ ${balances["–ù–∞–ª–∏—á–Ω—ã–µ UAH"].toFixed(2)}`;
            const totalEur = balances["Sparkasse"] + balances["–ù–∞–ª–∏—á–Ω—ã–µ EUR"] + (balances["–ü—Ä–∏–≤–∞—Ç"] + balances["–ù–∞–ª–∏—á–Ω—ã–µ UAH"]) / currentRate;
            document.getElementById('totalBalance').innerText = `‚Ç¨ ${totalEur.toFixed(2)}`;
        }

        function renderHistory() {
            const hist = document.getElementById('content-history');
            const del = document.getElementById('content-deleted');
            hist.innerHTML = ''; del.innerHTML = '';

            mainData.slice().reverse().forEach(r => {
                const isDel = String(r[2]).includes("[–£–î–ê–õ–ï–ù–û]");
                
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞—Ç—ã
                let d = String(r[0]);
                if (d.includes("T")) d = d.split("T")[0]; else d = d.substring(0, 10);

                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—É–º–º—ã (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ)
                let amt = parseFloat(r[6]);
                if (isNaN(amt)) amt = 0;

                const card = `
                    <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center mb-2 border border-gray-50">
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase font-black tracking-widest">${d}</p>
                            <p class="font-bold text-gray-800">${r[1]} <span class="text-gray-400 font-normal">x${r[4]}</span></p>
                            <p class="text-[11px] text-gray-500">${r[2]} | ${r[9]}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${r[8] === 'üíé –î–æ—Ö–æ–¥' ? 'text-green-500' : 'text-red-500'}">
                                ${r[8] === 'üíé –î–æ—Ö–æ–¥' ? '+' : '-'}${amt.toFixed(2)} ${r[7]}
                            </p>
                            ${!isDel ? `<button onclick="editRow(${r[10]}, '${String(r[1]).replace(/'/g, "\\'")}', '${String(r[2]).replace(/'/g, "\\'")}', '${amt}', '${r[4]}')" class="text-indigo-500 text-[10px] mt-2 font-black border-b border-indigo-100">‚úèÔ∏è –ü–†–ê–í–ö–ê</button>` : ''}
                        </div>
                    </div>
                `;
                if (isDel) del.innerHTML += card; else hist.innerHTML += card;
            });
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const payload = {
                amount: document.getElementById('amount').value,
                qty: document.getElementById('qty').value,
                merchant: document.getElementById('merchant').value || '–°–∞–π—Ç',
                item: document.getElementById('item').value || '‚Äî',
                account: document.getElementById('account').value,
                category: document.getElementById('category').value,
                action: 'add'
            };
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            location.reload();
        }

        async function editRow(idx, shop, item, price, qty) {
            if (confirm('–û–±–Ω—É–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?')) {
                // –ï—Å–ª–∏ –≤ —Ü–µ–Ω–µ –∑–∞—Ç–µ—Å–∞–ª–∞—Å—å –¥–∞—Ç–∞, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º 0 –∏–ª–∏ –ø—Ä–æ–±—É–µ–º –æ—á–∏—Å—Ç–∏—Ç—å
                let cleanPrice = parseFloat(price);
                if (isNaN(cleanPrice) || cleanPrice > 1000000) cleanPrice = 0;

                document.getElementById('amount').value = cleanPrice;
                document.getElementById('qty').value = qty;
                document.getElementById('merchant').value = shop;
                document.getElementById('item').value = item;
                window.scrollTo({top: 0, behavior: 'smooth'});
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', rowIndex: idx }) });
                openModal('expense');
            }
        }

        function saveManualRate() {
            currentRate = document.getElementById('manualRate').value;
            localStorage.setItem('manualRate', currentRate);
            updateBalance();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('content-' + tab).classList.add('active');
        }

        window.onload = loadData;
