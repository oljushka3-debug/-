<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartWallet Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: sans-serif; background: #f8fafc; padding-bottom: 40px; }
        .acc-card { border-radius: 24px; padding: 18px; color: white; transition: 0.3s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .trans-card { background: white; border-radius: 20px; padding: 14px; margin-bottom: 10px; display: flex; align-items: center; border: 1px solid #f1f5f9; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 100; align-items: flex-end; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; border-radius: 32px 32px 0 0; padding: 28px; }
        input, select { width: 100%; padding: 12px; border-radius: 14px; border: 2px solid #f1f5f9; margin-top: 4px; font-weight: 600; font-size: 16px; }
        .deleted { opacity: 0.3; filter: grayscale(1); }
        .deleted .amount-text { text-decoration: line-through; }
    </style>
</head>
<body>
    <div class="max-w-md mx-auto p-6">
        <div class="flex justify-between items-start mb-6">
            <div>
                <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</p>
                <h1 id="total" class="text-4xl font-[900] text-slate-900 tracking-tighter italic">0.00 ‚Ç¨</h1>
            </div>
            <div class="text-right">
                <p class="text-[9px] font-bold text-slate-400 mb-1 tracking-tighter">–†–£–ß–ù–û–ô –ö–£–†–°</p>
                <input type="number" id="manualRate" oninput="recalcAll()" placeholder="–ê–≤—Ç–æ" class="w-20 p-1 text-center text-xs border-slate-200">
            </div>
        </div>

        <div id="wallets" class="grid grid-cols-2 gap-4 mb-8"></div>

        <div class="grid grid-cols-3 gap-3 mb-10 text-center text-[10px] font-black uppercase italic tracking-tighter">
            <button onclick="openM('expense')" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-rose-100 text-rose-500">–†–∞—Å—Ö–æ–¥</button>
            <button onclick="openM('income')" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-emerald-100 text-emerald-500">–î–æ—Ö–æ–¥</button>
            <button onclick="openM('transfer')" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-blue-100 text-blue-500">–ü–µ—Ä–µ–≤–æ–¥</button>
        </div>

        <div id="hist" class="space-y-1"></div>
    </div>

    <div id="modal" class="modal" onclick="if(event.target==this) closeM()">
        <div class="modal-content">
            <h2 id="mTitle" class="text-xl font-black uppercase italic mb-4 tracking-tight">–ó–∞–ø–∏—Å—å</h2>
            <form id="txForm" class="space-y-3">
                <input type="hidden" id="mode">
                <input type="number" id="amt" step="0.01" placeholder="–°—É–º–º–∞" required>
                <input type="text" id="merch" placeholder="–ú–∞–≥–∞–∑–∏–Ω / –û–ø–∏—Å–∞–Ω–∏–µ" required>
                <input type="text" id="itemName" placeholder="–¢–æ–≤–∞—Ä (–Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º)">
                <select id="accF">
                    <option value="Sparkasse">Sparkasse (EUR)</option>
                    <option value="–ü—Ä–∏–≤–∞—Ç">–ü—Ä–∏–≤–∞—Ç (UAH)</option>
                    <option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞–ª–∏—á–Ω—ã–µ EUR</option>
                    <option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ù–∞–ª–∏—á–Ω—ã–µ UAH</option>
                </select>
                <div id="toGroup" class="hidden">
                    <select id="accT">
                        <option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞–ª–∏—á–Ω—ã–µ EUR</option>
                        <option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ù–∞–ª–∏—á–Ω—ã–µ UAH</option>
                        <option value="Sparkasse">Sparkasse</option>
                        <option value="–ü—Ä–∏–≤–∞—Ç">–ü—Ä–∏–≤–∞—Ç</option>
                    </select>
                </div>
                <button type="submit" id="sBtn" class="w-full p-4 bg-slate-900 text-white rounded-2xl font-black uppercase tracking-widest">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        // –°–°–´–õ–ö–ê –ù–ê –¢–í–û–ô –°–ö–†–ò–ü–¢ (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ—é, –µ—Å–ª–∏ –æ–Ω–∞ –∏–∑–º–µ–Ω–∏—Ç—Å—è)
        const URL_API = "https://script.google.com/macros/s/AKfycbwpEemEN5vcM396y6jD5mG-ghJK0LlHxTm4JhE2_GHvPiASGAWRTSDFRsXBbATDOd2K/exec";
        let rawData = [];
        let bankRate = 50.76;

        function openM(m, editData = null){
            document.getElementById('modal').classList.add('active');
            document.getElementById('mode').value = m;
            document.getElementById('toGroup').classList.toggle('hidden', m!=='transfer');
            if(editData) {
                document.getElementById('amt').value = editData.amt;
                document.getElementById('merch').value = editData.merch;
            }
        }
        function closeM(){ document.getElementById('modal').classList.remove('active'); }

        async function delRow(idx) {
            if(!confirm("–û–±–Ω—É–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å (–£–¥–∞–ª–∏—Ç—å)?")) return;
            await fetch(URL_API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({action: 'delete', rowIndex: idx}) });
            location.reload();
        }

        function recalcAll() { renderData({rows: rawData, rate: bankRate}); }

        function renderData(res) {
            rawData = res.rows; bankRate = res.rate;
            const userRate = parseFloat(document.getElementById('manualRate').value);
            const rate = userRate > 0 ? userRate : bankRate;
            let b = { "Sparkasse": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0 };
            let h = "";

            for (let i = rawData.length - 1; i >= 1; i--) {
                const r = rawData[i]; 
                const amt = parseFloat(r[6]) || 0;
                const curr = r[7] || "EUR";
                const isInc = r[8].includes("üíé") || r[8].includes("–î–æ—Ö–æ–¥");
                const isDel = r[2] && r[2].toString().includes("[–£–î–ê–õ–ï–ù–û]"); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–ª–æ–Ω–∫–µ C
                const rowIndex = r[10];

                if (!isDel && b.hasOwnProperty(r[9])) b[r[9]] += isInc ? amt : -amt;

                h += `
                <div class="trans-card ${isDel?'deleted':''}">
                    <div class="flex-1">
                        <div class="font-black text-[11px] uppercase tracking-tighter text-slate-800">${r[1]}</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">${r[3]||r[9]}</div>
                    </div>
                    <div class="text-right mr-4 amount-text">
                        <div class="font-black text-[12px] ${isInc?'text-emerald-500':'text-slate-900'}">${amt.toFixed(2)} ${curr=='EUR'?'‚Ç¨':'‚Ç¥'}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openM('expense', {amt:${amt}, merch:'${r[1]}'}); delRow(${rowIndex})" class="text-slate-200 hover:text-slate-400"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="delRow(${rowIndex})" class="text-rose-100 hover:text-rose-300"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`;
            }

            document.getElementById('wallets').innerHTML = `
                <div class="acc-card bg-indigo-600 shadow-indigo-100"><p class="text-[9px] font-black uppercase opacity-60">Sparkasse</p><p class="text-xl font-black">${b.Sparkasse.toFixed(2)}‚Ç¨</p></div>
                <div class="acc-card bg-violet-600 shadow-violet-100"><p class="text-[9px] font-black uppercase opacity-60">–ü—Ä–∏–≤–∞—Ç</p><p class="text-xl font-black">${b.–ü—Ä–∏–≤–∞—Ç.toFixed(2)}‚Ç¥</p><p class="text-[9px] opacity-60 mt-1 font-bold italic">‚âà ${(b.–ü—Ä–∏–≤–∞—Ç/rate).toFixed(2)}‚Ç¨</p></div>
                <div class="acc-card bg-emerald-600 shadow-emerald-100"><p class="text-[9px] font-black uppercase opacity-60">–ù–∞–ª EUR</p><p class="text-xl font-black">${b["–ù–∞–ª–∏—á–Ω—ã–µ EUR"].toFixed(2)}‚Ç¨</p></div>
                <div class="acc-card bg-slate-800 shadow-slate-100"><p class="text-[9px] font-black uppercase opacity-60">–ù–∞–ª UAH</p><p class="text-xl font-black">${b["–ù–∞–ª–∏—á–Ω—ã–µ UAH"].toFixed(2)}‚Ç¥</p><p class="text-[9px] opacity-60 mt-1 font-bold italic">‚âà ${(b["–ù–∞–ª–∏—á–Ω—ã–µ UAH"]/rate).toFixed(2)}‚Ç¨</p></div>
            `;
            const tot = b.Sparkasse + b["–ù–∞–ª–∏—á–Ω—ã–µ EUR"] + ((b.–ü—Ä–∏–≤–∞—Ç + b["–ù–∞–ª–∏—á–Ω—ã–µ UAH"])/rate);
            document.getElementById('total').innerText = tot.toFixed(2) + " ‚Ç¨";
            document.getElementById('hist').innerHTML = h;
            lucide.createIcons();
        }

        document.getElementById('txForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('sBtn'); btn.innerText = "–ó–∞–ø–∏—Å—å..."; btn.disabled = true;
            const data = {
                mode: document.getElementById('mode').value,
                amount: document.getElementById('amt').value,
                merchant: document.getElementById('merch').value,
                item: document.getElementById('itemName').value,
                account: document.getElementById('accF').value,
                accountTo: document.getElementById('accT').value
            };
            await fetch(URL_API, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            location.reload();
        };

        const s = document.createElement('script');
        s.src = URL_API + "?callback=renderData&t=" + Date.now();
        document.body.appendChild(s);
    </script>
</body>
</html>
