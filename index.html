<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Wallet Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-50 text-slate-900 pb-20">
    <div class="max-w-md mx-auto p-4 text-center">
        <div class="flex justify-between items-center mb-6 px-1">
            <div id="status-bar" class="text-[10px] font-bold text-blue-500 uppercase italic tracking-widest">Синхронизация...</div>
            <div class="text-[10px] font-bold text-slate-300 uppercase italic">Oljushka Wallet v2.0</div>
        </div>
        
        <div class="bg-slate-900 rounded-[35px] p-8 text-white shadow-2xl mb-6 relative overflow-hidden">
            <div class="relative z-10 text-left">
                <p class="text-[10px] uppercase font-black opacity-40 mb-1 tracking-[0.2em]">Общий капитал (EUR)</p>
                <div id="total-val" class="text-5xl font-black italic tracking-tighter">0.00 €</div>
            </div>
            <div class="absolute -right-6 -bottom-6 opacity-10 text-9xl rotate-12"><i class="fas fa-wallet"></i></div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-8">
            <div class="bg-white p-4 rounded-[24px] border border-slate-100 shadow-sm text-left">
                <p class="text-[8px] font-black text-slate-400 uppercase mb-1 tracking-wider">Sparkasse</p>
                <p id="bal-Sparkasse" class="font-bold text-sm text-slate-800">0.00 €</p>
            </div>
            <div class="bg-white p-4 rounded-[24px] border border-slate-100 shadow-sm text-left">
                <p class="text-[8px] font-black text-slate-400 uppercase mb-1 tracking-wider">ПриватБанк</p>
                <p id="bal-Приват" class="font-bold text-sm text-slate-800">0.00 ₴</p>
            </div>
            <div class="bg-white p-4 rounded-[24px] border border-slate-100 shadow-sm text-left">
                <p class="text-[8px] font-black text-slate-400 uppercase mb-1 tracking-wider">Наличные €</p>
                <p id="bal-CashEUR" class="font-bold text-sm text-slate-800">0.00 €</p>
            </div>
            <div class="bg-white p-4 rounded-[24px] border border-slate-100 shadow-sm text-left">
                <p class="text-[8px] font-black text-slate-400 uppercase mb-1 tracking-wider">Наличные ₴</p>
                <p id="bal-CashUAH" class="font-bold text-sm text-slate-800">0.00 ₴</p>
            </div>
        </div>

        <button onclick="loadData()" class="group w-full bg-blue-600 text-white py-5 rounded-[24px] font-black shadow-xl shadow-blue-100 uppercase mb-10 active:scale-95 transition-all flex items-center justify-center gap-3">
            <i class="fas fa-sync-alt transition-transform"></i> Обновить данные
        </button>

        <div class="text-left mb-4 flex justify-between items-center px-2">
            <span class="uppercase text-[11px] font-black text-slate-400 tracking-[0.15em]">История транзакций</span>
            <div class="flex gap-4 text-slate-300 text-xs text-right">
                <i class="fas fa-search"></i>
                <i class="fas fa-filter"></i>
            </div>
        </div>
        
        <div id="history" class="space-y-3"></div>
    </div>

    <script>
        const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbwjQUE8oIex8bt4fDcyRFxuxsHMPMm7RiLmBmZQ7AVoDfXIhkxS7F0sne1tqoAsoIY/exec";

        function renderData(rows) {
            const status = document.getElementById('status-bar');
            if (!rows || rows.length <= 1) {
                status.innerText = "ТАБЛИЦА ПУСТА";
                return;
            }

            try {
                let balances = {"Sparkasse": 0, "Приват": 0, "CashEUR": 0, "CashUAH": 0};
                let histHTML = "";

                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const date = row[0] ? row[0].toString().split('T')[0] : "";
                    const shop = row[1] || "Без названия";
                    const amount = parseFloat(row[6]) || 0;
                    const curr = row[7] || "EUR";
                    const cat = row[8] || "Прочее";
                    const acc = row[9] || "Sparkasse";

                    const isIncome = cat.includes("Зарплата") || cat.includes("Подарок") || cat.includes("вх.") || cat.includes("Доход");
                    
                    let key = acc;
                    if (acc.includes("Наличные") || acc.includes("Cash")) {
                        key = (curr === "EUR" || curr === "€") ? "CashEUR" : "CashUAH";
                    }

                    if (balances.hasOwnProperty(key)) {
                        balances[key] += isIncome ? amount : -amount;
                    }

                    let icon = "fa-shopping-cart";
                    if (cat.includes("Продукт")) icon = "fa-utensils";
                    if (cat.includes("Транспорт")) icon = "fa-car";
                    if (isIncome) icon = "fa-arrow-down text-green-500";

                    histHTML += `
                        <div class="bg-white p-5 rounded-[26px] border border-slate-100 shadow-sm mb-3 flex items-center gap-4 relative group active:bg-slate-50 transition-colors">
                            <div class="w-12 h-12 rounded-2xl ${isIncome ? 'bg-green-50' : 'bg-blue-50'} flex items-center justify-center text-lg">
                                <i class="fas ${icon} ${isIncome ? 'text-green-500' : 'text-blue-500'}"></i>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-bold text-[13px] text-slate-800 leading-none mb-1">${shop}</h4>
                                        <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter">${cat} • ${acc}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-black text-[14px] ${isIncome ? 'text-green-600' : 'text-slate-900'}">
                                            ${isIncome ? '+' : '-'}${amount.toFixed(2)} ${curr}
                                        </p>
                                        <p class="text-[8px] text-slate-300 font-bold uppercase">${date}</p>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }

                document.getElementById('bal-Sparkasse').innerText = balances["Sparkasse"].toFixed(2) + " €";
                document.getElementById('bal-Приват').innerText = balances["Приват"].toFixed(2) + " ₴";
                document.getElementById('bal-CashEUR').innerText = balances["CashEUR"].toFixed(2) + " €";
                document.getElementById('bal-CashUAH').innerText = balances["CashUAH"].toFixed(2) + " ₴";
                
                const totalEUR = balances["Sparkasse"] + balances["CashEUR"] + ((balances["Приват"] + balances["CashUAH"]) / 42);
                document.getElementById('total-val').innerText = totalEUR.toFixed(2) + " €";
                document.getElementById('history').innerHTML = histHTML;
                status.innerText = "ОБНОВЛЕНО";

            } catch (err) {
                console.error(err);
                status.innerText = "ОШИБКА ОБРАБОТКИ";
            }
        }

        function loadData() {
            document.getElementById('status-bar').innerText = "ЗАГРУЗКА...";
            const oldScript = document.getElementById('google-script');
            if (oldScript) oldScript.remove();
            
            const script = document.createElement('script');
            script.id = 'google-script';
            script.src = GOOGLE_URL + "?callback=renderData&t=" + Date.now();
            document.body.appendChild(script);
        }

        window.onload = loadData;
    </script>
</body>
</html>
