<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartWallet v21.1 (Direct Sum)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        input, select { text-align: center; text-align-last: center; border-radius: 12px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 p-3 pb-10 font-sans text-center hide-scroll">

<button onclick="location.reload()" class="fixed top-4 right-4 z-50 bg-slate-800/90 w-10 h-10 rounded-full border border-slate-700 flex items-center justify-center shadow-xl active:scale-90 transition-all">
    <i class="fa-solid fa-rotate text-blue-400 text-xs"></i>
</button>

<div class="bg-gradient-to-br from-slate-900 to-slate-800 p-4 rounded-[25px] border border-slate-700/50 mb-3 shadow-2xl">
    <div class="flex justify-between items-center mb-2 text-[9px] font-bold opacity-50 uppercase tracking-tighter">
        <span>–ö—É—Ä—Å: <input type="number" id="baseRate" value="50.76" step="0.01" oninput="drawBalance()" class="w-10 bg-transparent text-yellow-500 outline-none font-black text-center"></span>
        <span>–Ø–ù–í–ê–†–¨ 2026</span>
    </div>
    <h1 id="mainBalance" class="text-3xl font-black italic mb-3 tracking-tighter text-white">‚Ç¨ 0.00</h1>
    <div class="grid grid-cols-2 gap-2" id="walletContainer"></div>
</div>

<div id="limit-items" class="bg-slate-900/60 p-4 rounded-[25px] border border-slate-800 mb-4 space-y-3"></div>

<div class="flex gap-2 mb-4 font-black">
    <button onclick="openModal('expense')" class="flex-1 bg-rose-600 py-3 rounded-xl text-[10px] uppercase border-b-4 border-rose-900 shadow-lg text-white">–†–∞—Å—Ö–æ–¥</button>
    <button onclick="openModal('transfer')" class="flex-1 bg-slate-700 py-3 rounded-xl text-[10px] uppercase border-b-4 border-slate-900 shadow-lg text-white">–ü–µ—Ä–µ–≤–æ–¥</button>
    <button onclick="openModal('income')" class="flex-1 bg-emerald-600 py-3 rounded-xl text-[10px] uppercase border-b-4 border-emerald-900 shadow-lg text-white">–î–æ—Ö–æ–¥</button>
</div>

<div id="history" class="space-y-2 text-left"></div>

<div id="modal" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center p-4 z-50">
    <div class="bg-slate-900 w-full max-w-sm rounded-[35px] p-5 border border-slate-800 shadow-2xl overflow-y-auto max-h-[90vh]">
        <div class="flex gap-1 mb-4 bg-slate-800 p-1 rounded-xl font-bold">
            <button onclick="switchType('expense')" id="btnExp" class="flex-1 py-2 rounded-lg text-[8px] uppercase transition-all">–†–∞—Å—Ö–æ–¥</button>
            <button onclick="switchType('transfer')" id="btnTrf" class="flex-1 py-2 rounded-lg text-[8px] uppercase transition-all text-slate-500">–ü–µ—Ä–µ–≤–æ–¥</button>
            <button onclick="switchType('income')" id="btnInc" class="flex-1 py-2 rounded-lg text-[8px] uppercase transition-all text-slate-500">–î–æ—Ö–æ–¥</button>
        </div>
        <form onsubmit="save(event)" class="space-y-3 text-center">
            <input type="hidden" id="txType">
            <input type="hidden" id="editRowId">
            <input type="date" id="date" class="w-full bg-slate-800 p-3 text-white text-xs font-bold border border-slate-700 outline-none">
            <input id="merchant" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ / –ò—Å—Ç–æ—á–Ω–∏–∫" class="w-full bg-slate-800 p-3 text-white text-xs font-bold border border-slate-700 outline-none text-center">

            <div id="expenseFields" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-2 text-white text-xs font-bold italic">
                    <input type="text" id="nameDE" placeholder="Name (DE)" class="bg-slate-800 p-3 border border-slate-700 outline-none text-center">
                    <input type="text" id="nameRU" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–†–£)" class="bg-slate-800 p-3 border border-slate-700 outline-none text-blue-300 text-center">
                </div>
                <div class="grid grid-cols-2 gap-2 bg-slate-800/50 p-2 border border-slate-700 text-white text-xs">
                    <div><label class="text-[7px] text-slate-500 uppercase block">–ö–æ–ª-–≤–æ</label><input type="number" id="qty" value="1" step="0.01" class="w-full bg-transparent font-black outline-none text-center"></div>
                    <div class="border-l border-slate-700 pl-2"><label class="text-[7px] text-yellow-500 uppercase block">–¶–µ–Ω–∞ ‚Ç¨</label><input type="number" id="priceUnit" step="0.01" placeholder="0.00" class="w-full bg-transparent font-black outline-none text-center"></div>
                </div>
            </div>

            <div id="incomeFields" class="hidden space-y-3">
                <select id="accInc" class="w-full bg-slate-800 p-3 text-emerald-400 font-bold text-xs border border-slate-700 outline-none"><option value="Sparkasse">–ù–∞ Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ù–∞ –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞ –ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ù–∞ –ù–∞–ª ‚Ç¥</option><option value="–ö–û–ü–ò–õ–ö–ê">–í –ö–û–ü–ò–õ–ö–£</option><option value="–ö–û–ù–í–ï–†–¢">–í –ö–û–ù–í–ï–†–¢</option><option value="–°–í–ò–ù–ö–ê">–í –°–í–ò–ù–ö–£</option></select>
                <input type="number" id="simplePrice" step="0.01" placeholder="–°—É–º–º–∞" class="w-full bg-slate-800 p-3 text-xl font-black text-white border border-slate-700 outline-none text-center">
            </div>

            <div id="transferFields" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <select id="tFrom" class="bg-slate-800 p-3 text-white text-[10px] font-bold border border-slate-700 outline-none text-center"><option value="Sparkasse">–ò–∑ Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ò–∑ –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ò–∑ –ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ò–∑ –ù–∞–ª ‚Ç¥</option><option value="–ö–û–ü–ò–õ–ö–ê">–ò–∑ –ö–û–ü–ò–õ–ö–ò</option><option value="–ö–û–ù–í–ï–†–¢">–ò–∑ –ö–û–ù–í–ï–†–¢–ê</option><option value="–°–í–ò–ù–ö–ê">–ò–∑ –°–í–ò–ù–ö–ò</option></select>
                    <select id="tTo" class="bg-slate-800 p-3 text-yellow-500 text-[10px] font-bold border border-slate-700 outline-none text-center"><option value="–ö–û–ü–ò–õ–ö–ê">–í –ö–û–ü–ò–õ–ö–£</option><option value="–ö–û–ù–í–ï–†–¢">–í –ö–û–ù–í–ï–†–¢</option><option value="–°–í–ò–ù–ö–ê">–í –°–í–ò–ù–ö–£</option><option value="Sparkasse">–í Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–í –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–í –ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–í –ù–∞–ª ‚Ç¥</option></select>
                </div>
                <input type="number" id="tAmountFrom" step="0.01" class="w-full bg-slate-800 p-3 text-lg font-black text-white border border-slate-700 outline-none text-center" placeholder="–°—É–º–º–∞">
            </div>

            <div id="accCatGroup" class="grid grid-cols-2 gap-2">
                <select id="acc" class="bg-slate-800 p-3 text-white text-[10px] font-bold border border-slate-700 outline-none text-center"><option value="Sparkasse">Sparkasse</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞–ª ‚Ç¨</option><option value="–ö–û–ü–ò–õ–ö–ê">–ö–û–ü–ò–õ–ö–ê</option><option value="–ü—Ä–∏–≤–∞—Ç">–ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ù–∞–ª ‚Ç¥</option><option value="–ö–û–ù–í–ï–†–¢">–ö–û–ù–í–ï–†–¢</option><option value="–°–í–ò–ù–ö–ê">–°–í–ò–ù–ö–ê</option></select>
                <select id="cat" class="bg-slate-800 p-3 text-white text-[10px] font-bold border border-slate-700 outline-none text-center"><option>üçé –ü—Ä–æ–¥—É–∫—Ç—ã / –ë—ã—Ç</option><option>üö¨ –¢–∞–±–∞–∫ / –û—Ç–¥—ã—Ö</option><option>üè† –ñ–∏–ª—å–µ / –°—á–µ—Ç–∞</option><option>üíä –ó–¥–æ—Ä–æ–≤—å–µ</option><option>üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option>üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ</option></select>
            </div>
            <div class="flex gap-2 pt-2"><button type="button" onclick="closeModal()" class="flex-1 bg-slate-800 py-3 rounded-xl font-bold uppercase text-[9px] text-white text-center">–û—Ç–º–µ–Ω–∞</button><button id="saveBtn" class="flex-[2] bg-yellow-500 text-black py-3 rounded-xl font-black uppercase text-xs text-center text-center">–ó–∞–ø–∏—Å–∞—Ç—å</button></div>
        </form>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz4-b-RtsW9Gy1-H7E27APtoNL1GwTNRyZAANSe0L52ds31BwF89uydrxrzLgyHaFL9/exec";
const MY_LIMITS = { "üçé –ü—Ä–æ–¥—É–∫—Ç—ã / –ë—ã—Ç": 350, "üè† –ñ–∏–ª—å–µ / –°—á–µ—Ç–∞": 50, "üö¨ –¢–∞–±–∞–∫ / –û—Ç–¥—ã—Ö": 120, "üíä –ó–¥–æ—Ä–æ–≤—å–µ": 80, "üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç": 70, "üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ": 30 };
let walletData = { "Sparkasse": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ö–û–ü–ò–õ–ö–ê": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0, "–ö–û–ù–í–ï–†–¢": 0, "–°–í–ò–ù–ö–ê": 0 };
let spentThisMonth = {};
let allRows = [];

function isUah(acc) { return ["–ü—Ä–∏–≤–∞—Ç", "–ù–∞–ª–∏—á–Ω—ã–µ UAH", "–ö–û–ù–í–ï–†–¢", "–°–í–ò–ù–ö–ê"].includes(acc); }

function drawBalance() {
    const r = parseFloat(document.getElementById('baseRate').value) || 50.76;
    const container = document.getElementById('walletContainer'); container.innerHTML = "";
    let totalEur = 0;
    for(let k in walletData) {
        const val = walletData[k], isU = isUah(k), eurEq = isU ? val / r : val;
        totalEur += eurEq;
        container.innerHTML += `<div class="bg-slate-800/40 p-2 rounded-xl border border-slate-700/30 text-center"><div class="text-[7px] text-slate-500 uppercase font-black">${k}</div><div class="text-[10px] font-black text-white">${isU?'‚Ç¥':'‚Ç¨'} ${val.toFixed(2)}</div>${isU ? `<div class="text-[7px] text-slate-600 italic">‚Ç¨ ${eurEq.toFixed(2)}</div>` : ''}</div>`;
    }
    document.getElementById('mainBalance').innerText = '‚Ç¨ ' + totalEur.toFixed(2);
}

function draw(data) {
    if (!data || !data.rows) return;
    allRows = data.rows;
    walletData = { "Sparkasse": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ö–û–ü–ò–õ–ö–ê": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0, "–ö–û–ù–í–ï–†–¢": 0, "–°–í–ò–ù–ö–ê": 0 };
    spentThisMonth = {}; const now = new Date();
    
    allRows.forEach(r => {
        const cat = r[1], desc = r[2], accF = r[5], date = new Date(r[0]);
        const eurVal = parseFloat(r[8] || 0), uahVal = parseFloat(r[10] || 0);

        // –ü–†–Ø–ú–û–ï –°–£–ú–ú–ò–†–û–í–ê–ù–ò–ï –ü–û –ü–†–ê–í–ò–õ–£:
        // 1. –ö–æ—à–µ–ª–µ–∫ –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ F –í–°–ï–ì–î–ê –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ—é —Å—É–º–º—É (—Ä–∞—Å—Ö–æ–¥ –∏–ª–∏ –¥–æ—Ö–æ–¥)
        if (walletData.hasOwnProperty(accF)) {
            walletData[accF] += (isUah(accF) ? uahVal : eurVal);
        }

        // 2. –ï—Å–ª–∏ —ç—Ç–æ –ü–ï–†–ï–í–û–î (–µ—Å—Ç—å —Å—Ç—Ä–µ–ª–æ—á–∫–∞ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏), –ø—Ä–∏–±–∞–≤–ª—è–µ–º —Å—É–º–º—É –∫–æ—à–µ–ª—å–∫—É-—Ü–µ–ª–∏
        if (desc.includes("‚û°Ô∏è")) {
            const targetAcc = desc.replace("‚û°Ô∏è ", "").trim();
            if (walletData.hasOwnProperty(targetAcc)) {
                // –ë–µ—Ä–µ–º –ø–æ –º–æ–¥—É–ª—é, —Ç–∞–∫ –∫–∞–∫ –ø–µ—Ä–µ–≤–æ–¥ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —É—à–µ–ª —Å –º–∏–Ω—É—Å–æ–º, –∞ –≤ —Ü–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ —Å –ø–ª—é—Å–æ–º
                const absEur = Math.abs(eurVal), absUah = Math.abs(uahVal);
                walletData[targetAcc] += (isUah(targetAcc) ? absUah : absEur);
            }
        }

        // –°—á–∏—Ç–∞–µ–º –ª–∏–º–∏—Ç—ã (—Ç—Ä–∞—Ç—ã)
        if (date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear() && eurVal < 0 && !cat.includes("–ü–µ—Ä–µ–≤–æ–¥") && !cat.includes("–î–æ—Ö–æ–¥")) {
            const lCat = MY_LIMITS.hasOwnProperty(cat) ? cat : "üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ";
            spentThisMonth[lCat] = (spentThisMonth[lCat] || 0) + eurVal;
        }
    });
    
    filterHistory(); drawBalance();
}

function filterHistory() {
    const hist = document.getElementById('history'); hist.innerHTML = "";
    allRows.slice().reverse().slice(0, 30).forEach(r => {
        const acc = r[5], isU = isUah(acc), valMain = Math.abs(isU ? r[10] : r[8]), cat = r[1];
        const isInc = (isU ? r[10] : r[8]) > 0 || cat.includes("–î–æ—Ö–æ–¥");
        const rowId = r[r.length-1];
        
        let catIcon = cat.split(' ')[0];
        if(cat === "üîÑ –ü–µ—Ä–µ–≤–æ–¥") catIcon = "üîÑ"; if(cat === "üíé –î–æ—Ö–æ–¥") catIcon = "üí∞";

        hist.innerHTML += `<div class="bg-slate-900/40 p-2.5 rounded-xl border border-slate-800 mb-2 flex justify-between items-center">
            <div class="flex items-center gap-2 truncate text-left">
                <button onclick="deleteRow(${rowId})" class="text-slate-700 hover:text-rose-500"><i class="fa-solid fa-trash-can text-[9px]"></i></button>
                <div class="truncate">
                    <div class="text-[7px] text-slate-600 font-bold uppercase italic">${String(r[0]).split('T')[0].substring(5)} ‚Ä¢ ${acc}</div>
                    <div class="text-[10px] font-bold text-white truncate leading-tight">${catIcon} ${r[2]}</div>
                </div>
            </div>
            <div class="text-right min-w-fit font-black text-[11px] ${isInc?'text-emerald-500':'text-rose-500'} italic">
                ${isInc?'+':'-'}${valMain.toFixed(2)}${isU?'‚Ç¥':'‚Ç¨'}
            </div>
        </div>`;
    });
}

// –§—É–Ω–∫—Ü–∏–∏ Save –∏ Modal –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –≤ v21.0
async function save(e) {
    e.preventDefault(); const btn = document.getElementById('saveBtn'); btn.disabled = true; btn.innerText = "‚è≥";
    const type = document.getElementById('txType').value, rate = parseFloat(document.getElementById('baseRate').value);
    let payload = { action: 'add', date: document.getElementById('date').value, rate: rate };

    if(type === 'expense') {
        const q = parseFloat(document.getElementById('qty').value)||1, p = parseFloat(document.getElementById('priceUnit').value)||0;
        payload.merchant=document.getElementById('merchant').value; payload.category=document.getElementById('cat').value; payload.account=document.getElementById('acc').value; payload.nameDE=document.getElementById('nameDE').value; payload.nameRU=document.getElementById('nameRU').value; payload.qty=q; payload.priceUnit=p; payload.totalTran=-(q*p);
        if(isUah(payload.account)){ payload.totalCard=-(q*p*rate); payload.curCard="UAH"; }
    } else if(type === 'income') {
        const p = parseFloat(document.getElementById('simplePrice').value)||0;
        payload.merchant="‚û°Ô∏è "+document.getElementById('accInc').value; payload.category="üíé –î–æ—Ö–æ–¥"; payload.account=document.getElementById('merchant').value;
        if(isUah(document.getElementById('accInc').value)){ payload.totalCard=p; payload.curCard="UAH"; payload.totalTran=p/rate; } else payload.totalTran=p;
    } else if(type === 'transfer') {
        const f = document.getElementById('tFrom').value, t = document.getElementById('tTo').value, amF = parseFloat(document.getElementById('tAmountFrom').value)||0;
        payload.merchant="‚û°Ô∏è "+t; payload.category="üîÑ –ü–µ—Ä–µ–≤–æ–¥"; payload.account=f;
        if(isUah(f)&&isUah(t)){ payload.totalTran=0; payload.totalCard=-amF; payload.curCard="UAH"; }
        else if(isUah(f)){ payload.totalCard=-amF; payload.curCard="UAH"; payload.totalTran=-amF/rate; }
        else if(isUah(t)){ payload.totalTran=-amF; payload.totalCard=amF*rate; payload.curCard="UAH"; } else payload.totalTran=-amF;
    }
    await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }); location.reload();
}
// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏...
function openModal(type) { document.getElementById('modal').classList.remove('hidden'); switchType(type); }
function closeModal() { document.getElementById('modal').classList.add('hidden'); }
function switchType(type) {
    document.getElementById('txType').value = type;
    document.getElementById('expenseFields').classList.toggle('hidden', type !== 'expense');
    document.getElementById('incomeFields').classList.toggle('hidden', type !== 'income');
    document.getElementById('transferFields').classList.toggle('hidden', type !== 'transfer');
    document.getElementById('accCatGroup').classList.toggle('hidden', type !== 'expense');
}
async function deleteRow(id) { if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return; await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'delete', rowId: id}) }); location.reload(); }
window.onload = () => { const s = document.createElement('script'); s.src = API_URL + "?callback=draw&_t=" + new Date().getTime(); document.body.appendChild(s); };
</script>
</body>
</html>
