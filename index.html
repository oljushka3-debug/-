<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartWallet v6.0 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 pb-20 font-sans">
    <div class="bg-slate-800 text-white p-6 rounded-b-3xl shadow-xl sticky top-0 z-40">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-black italic tracking-tighter text-yellow-400">FINANCE PRO</h1>
            <div class="text-xs bg-slate-700 px-3 py-1 rounded-full border border-slate-600">
                –ö—É—Ä—Å ‚Ç¨: <input type="number" id="manualRate" value="50.76" step="0.01" class="w-12 bg-transparent outline-none font-bold text-yellow-400" oninput="updateRate()"> ‚Ç¥
            </div>
        </div>
        <div class="text-center">
            <p class="text-slate-400 text-[10px] uppercase tracking-widest mb-1">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å (‚Ç¨)</p>
            <h2 id="totalBalance" class="text-4xl font-black tracking-tight">‚Ç¨ 0.00</h2>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3 p-4">
        <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-blue-500 text-center">
            <p class="text-[9px] text-gray-400 font-bold uppercase">Sparkasse</p>
            <p id="acc-Sparkasse" class="text-lg font-black text-slate-700">‚Ç¨ 0.00</p>
        </div>
        <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-green-600 text-center">
            <p class="text-[9px] text-gray-400 font-bold uppercase">–ü—Ä–∏–≤–∞—Ç–ë–∞–Ω–∫</p>
            <p id="acc-–ü—Ä–∏–≤–∞—Ç" class="text-lg font-black text-slate-700">‚Ç¥ 0.00</p>
        </div>
    </div>

    <div class="flex px-4 gap-2 mb-6">
        <button onclick="openModal('expense')" class="flex-1 bg-rose-600 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition">–†–ê–°–•–û–î</button>
        <button onclick="openModal('income')" class="flex-1 bg-emerald-700 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition">–î–û–•–û–î</button>
    </div>

    <div id="content-history" class="px-4 space-y-3"></div>

    <div id="modal" class="modal">
        <div class="bg-white w-full max-w-sm m-4 p-6 rounded-3xl relative shadow-2xl overflow-y-auto max-h-[90vh]">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-3xl text-gray-300">&times;</button>
            <h3 id="modalTitle" class="text-xl font-black mb-6 text-slate-800 uppercase italic text-center underline decoration-yellow-400">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h3>
            
            <form onsubmit="handleSubmit(event)" class="space-y-4">
                <input type="hidden" id="txType">
                <input type="date" id="txDate" required class="w-full border-2 border-slate-100 rounded-xl p-3 font-bold text-slate-700 outline-none">

                <div class="grid grid-cols-3 gap-2 bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                    <div>
                        <label class="text-[9px] font-black text-slate-400 uppercase">–ö–æ–ª-–≤–æ</label>
                        <input type="number" id="qty" value="1" step="1" class="w-full bg-transparent text-lg font-black outline-none text-center" oninput="recalc()">
                    </div>
                    <div>
                        <label class="text-[9px] font-black text-blue-500 uppercase italic">–¶–µ–Ω–∞ –∑–∞ 1‚Ç¨</label>
                        <input type="number" id="amountEur" step="0.01" placeholder="0.00" class="w-full bg-transparent text-lg font-black outline-none text-center" oninput="recalc()">
                    </div>
                    <div class="bg-yellow-50 rounded-lg">
                        <label class="text-[9px] font-black text-amber-600 uppercase italic">–ò—Ç–æ–≥–æ ‚Ç¥</label>
                        <div id="displayUah" class="w-full text-sm font-black text-center pt-1 text-slate-700">0.00</div>
                    </div>
                </div>

                <div class="space-y-2">
                    <input type="text" id="merchant" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (Lidl, –ê–ó–°...)" class="w-full border-2 border-slate-100 rounded-xl p-3 outline-none focus:border-yellow-400">
                    <input type="text" id="itemDE" placeholder="–¢–æ–≤–∞—Ä DE (Milch)" class="w-full border-2 border-slate-100 rounded-xl p-3 outline-none">
                    <input type="text" id="itemRU" placeholder="–¢–æ–≤–∞—Ä –†–£ (–ú–æ–ª–æ–∫–æ)" class="w-full border-2 border-slate-100 rounded-xl p-3 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <select id="account" class="w-full border-2 border-slate-100 rounded-xl p-3 font-bold bg-white outline-none" onchange="recalc()"></select>
                    <select id="category" class="w-full border-2 border-slate-100 rounded-xl p-3 font-bold bg-white outline-none"></select>
                </div>

                <button type="submit" id="submitBtn" class="w-full bg-slate-800 text-yellow-400 py-4 rounded-2xl font-black text-xl shadow-lg uppercase tracking-widest">–ó–∞–ø–∏—Å–∞—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzXQwXmcTPOtzonuMXmJbqjOFGtneGziU13u8aqaHjWKFwTbk-IZHjBq3j3linJGPWd/exec"; 
        let currentRate = 50.76;

        function updateRate() { 
            currentRate = parseFloat(document.getElementById('manualRate').value) || 50.76; 
            recalc(); 
        }

        function recalc() {
            const q = parseFloat(document.getElementById('qty').value) || 0;
            const p = parseFloat(document.getElementById('amountEur').value) || 0;
            const acc = document.getElementById('account').value;
            const totalUah = (q * p * currentRate).toFixed(2);
            document.getElementById('displayUah').innerText = (acc.includes("–ü—Ä–∏–≤–∞—Ç") || acc.includes("UAH")) ? totalUah : "‚Äî";
        }

        function openModal(type) {
            document.getElementById('modal').classList.add('active');
            document.getElementById('txType').value = type;
            document.getElementById('txDate').value = new Date().toISOString().split('T')[0];
            const aS = document.getElementById('account'), cS = document.getElementById('category');
            aS.innerHTML = ""; cS.innerHTML = "";
            if (type === 'expense') {
                document.getElementById('modalTitle').innerText = "–ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥";
                ["Sparkasse", "–ü—Ä–∏–≤–∞—Ç", "–ù–∞–ª–∏—á–Ω—ã–µ EUR", "–ù–∞–ª–∏—á–Ω—ã–µ UAH"].forEach(a => aS.add(new Option(a, a)));
                ["üçé –ü—Ä–æ–¥—É–∫—Ç—ã", "üè† –î–æ–º", "üíä –ó–¥–æ—Ä–æ–≤—å–µ", "üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "üç∑ –ê–ª–∫–æ–≥–æ–ª—å", "üì¶ –ü—Ä–æ—á–µ–µ"].forEach(c => cS.add(new Option(c, c)));
            } else {
                document.getElementById('modalTitle').innerText = "–ù–æ–≤—ã–π –¥–æ—Ö–æ–¥";
                aS.add(new Option("üíé –î–æ—Ö–æ–¥", "üíé –î–æ—Ö–æ–¥"));
                ["Sparkasse", "–ü—Ä–∏–≤–∞—Ç", "–ù–∞–ª–∏—á–Ω—ã–µ EUR", "–ù–∞–ª–∏—á–Ω—ã–µ UAH"].forEach(a => cS.add(new Option(a, a)));
            }
            recalc();
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const q = parseFloat(document.getElementById('qty').value) || 1;
            const pEur = parseFloat(document.getElementById('amountEur').value) || 0;
            const acc = document.getElementById('account').value;
            const type = document.getElementById('txType').value;
            
            const isUahAcc = (acc.includes("–ü—Ä–∏–≤–∞—Ç") || acc.includes("UAH"));
            const sign = (type === 'expense') ? -1 : 1;

            const payload = {
                action: 'add',
                date: document.getElementById('txDate').value,
                category: document.getElementById('category').value,
                merchant: document.getElementById('merchant').value || '‚Äî',
                itemDE: document.getElementById('itemDE').value || '‚Äî',
                itemRU: document.getElementById('itemRU').value || '‚Äî',
                account: acc,
                qty: q,
                priceUnit: pEur,
                totalTran: (q * pEur).toFixed(2),
                curTran: "EUR",
                totalCard: isUahAcc ? (sign * q * pEur * currentRate).toFixed(2) : "",
                curCard: isUahAcc ? "UAH" : "",
                rate: currentRate
            };
            
            document.getElementById('submitBtn').innerText = "‚åõ –ñ–î–ò–¢–ï...";
            document.getElementById('submitBtn').disabled = true;
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            location.reload();
        }

        async function loadData() {
            const script = document.createElement('script');
            script.src = `${API_URL}?callback=handleData&t=${new Date().getTime()}`;
            document.body.appendChild(script);
        }

        function handleData(data) {
            const hist = document.getElementById('content-history'); hist.innerHTML = '';
            let b = { "Sparkasse": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0 };
            
            data.rows.slice().reverse().forEach(r => {
                const totalTr = parseFloat(r[8]) || 0, totalCr = parseFloat(r[10]) || 0;
                const acc = r[5], cat = r[1], isDel = String(r[3]).includes("[–£–î–ê–õ–ï–ù–û]");

                if (!isDel && b.hasOwnProperty(acc)) {
                    const val = (acc.includes("–ü—Ä–∏–≤–∞—Ç") || acc.includes("UAH")) ? Math.abs(totalCr) : totalTr;
                    if (cat === "üíé –î–æ—Ö–æ–¥") b[acc] += val; else b[acc] -= val;
                }
                if (!isDel) {
                    const cur = (acc.includes("–ü—Ä–∏–≤–∞—Ç") || acc.includes("UAH")) ? "‚Ç¥" : "‚Ç¨";
                    const displaySum = (cur === "‚Ç¥") ? Math.abs(totalCr) : totalTr;
                    hist.innerHTML += `<div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center mb-2">
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold">${String(r[0]).substring(0,10)} | ${cat}</p>
                            <p class="font-bold text-slate-800">${r[2]}</p>
                            <p class="text-[10px] text-slate-400 font-medium">${r[3]} (${r[4]}) | ${acc}</p>
                        </div>
                        <div class="text-right font-black ${cat==='üíé –î–æ—Ö–æ–¥'?'text-emerald-600':'text-rose-500'}">${displaySum.toFixed(2)} ${cur}</div>
                    </div>`;
                }
            });
            for(let k in b) if(document.getElementById('acc-'+k)) document.getElementById('acc-'+k).innerText = (k.includes("UAH")||k.includes("–ü—Ä–∏–≤–∞—Ç")?"‚Ç¥ ":"‚Ç¨ ")+b[k].toFixed(2);
            const total = b["Sparkasse"] + b["–ù–∞–ª–∏—á–Ω—ã–µ EUR"] + (b["–ü—Ä–∏–≤–∞—Ç"] + b["–ù–∞–ª–∏—á–Ω—ã–µ UAH"]) / currentRate;
            document.getElementById('totalBalance').innerText = "‚Ç¨ " + total.toFixed(2);
        }
        function closeModal() { document.getElementById('modal').classList.remove('active'); }
        window.onload = loadData;
    </script>
</body>
</html>
