async function save(e) {
    e.preventDefault();
    const btn = document.getElementById('saveBtn'); btn.disabled = true; btn.innerText = "‚è≥...";
    const type = document.getElementById('txType').value, rate = parseFloat(document.getElementById('baseRate').value);
    const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];
    let payload = { action: type, date: date, rate: rate, merchant: document.getElementById('merchant').value };
    
    if(type === 'transfer') {
        payload.fromAcc = document.getElementById('tFrom').value;
        payload.toAcc = document.getElementById('tTo').value;
        payload.amountFrom = parseFloat(document.getElementById('tAmountFrom').value) || 0;
        payload.amountTo = parseFloat(document.getElementById('tAmountTo').value) || 0;
        payload.category = "üîÑ –ü–µ—Ä–µ–≤–æ–¥";
        // –ü–ï–†–ï–í–û–î: –∫–æ–ª–æ–Ω–∫–∞ H –∏ I –≤—Å–µ–≥–¥–∞ –ø—É—Å—Ç—ã–µ
        payload.totalCard = ""; 
        payload.curCard = "";
    } else {
        const q = parseFloat(document.getElementById('qty').value) || 1, 
              p = parseFloat(document.getElementById('price').value) || 0, 
              acc = document.getElementById('acc').value, 
              cat = document.getElementById('cat').value;
        const isInc = (type === 'income' || cat.includes('–î–æ—Ö–æ–¥'));
        const amount = q * p;

        payload.action = 'add'; payload.category = cat; payload.account = acc;
        payload.qty = isInc ? "" : q; payload.priceUnit = isInc ? "" : p; payload.curTran = "EUR";

        if (isInc) {
            // –î–û–•–û–î: –°–æ–≥–ª–∞—Å–Ω–æ —Ç–≤–æ–µ–π –ª–æ–≥–∏–∫–µ, –¥–ª—è –ü—Ä–∏–≤–∞—Ç–∞ –∫–æ–ª–æ–Ω–∫—É H –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π
            if (isUah(acc)) { 
                payload.totalCard = ""; // –ü—É—Å—Ç–æ –≤ H
                payload.totalTran = Math.abs(amount / rate); 
                payload.curCard = "UAH"; 
                payload.uahAmount = Math.abs(amount); // –°—É–º–º–∞ –≤ –≥—Ä–∏–≤–Ω–∞—Ö –∏–¥–µ—Ç –≤ K
            } else { 
                payload.totalTran = Math.abs(amount); 
                payload.totalCard = ""; 
                payload.curCard = "EUR"; 
            }
        } else {
            // –†–ê–°–•–û–î: –ó–¥–µ—Å—å –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ (–Ω—É–∂–Ω–∞ —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É)
            payload.totalTran = -Math.abs(amount);
            if (isUah(acc)) { 
                payload.totalCard = -Math.abs(amount * rate); 
                payload.curCard = "UAH"; 
            } else { 
                payload.totalCard = ""; 
                payload.curCard = "EUR"; 
            }
        }
    }
    await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
    location.reload();
}
