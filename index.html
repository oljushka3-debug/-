<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartWallet v25.0 (Double Entry)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        input, select { text-align: center; text-align-last: center; border-radius: 12px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 p-3 pb-10 font-sans text-center hide-scroll">

<button onclick="location.reload()" class="fixed top-4 right-4 z-50 bg-slate-800/90 w-10 h-10 rounded-full border border-slate-700 flex items-center justify-center shadow-xl active:scale-90 transition-all">
    <i class="fa-solid fa-rotate text-blue-400 text-xs"></i>
</button>

<div class="bg-gradient-to-br from-slate-900 to-slate-800 p-4 rounded-[25px] border border-slate-700/50 mb-3 shadow-2xl">
    <div class="flex justify-between items-center mb-2 text-[9px] font-bold opacity-50 uppercase tracking-tighter">
        <span>–ö—É—Ä—Å: <input type="number" id="baseRate" value="50.76" step="0.01" oninput="drawBalance()" class="w-10 bg-transparent text-yellow-500 outline-none font-black text-center"></span>
        <span>–Ø–ù–í–ê–†–¨ 2026</span>
    </div>
    <h1 id="mainBalance" class="text-3xl font-black italic mb-3 tracking-tighter text-white">‚Ç¨ 0.00</h1>
    <div class="grid grid-cols-2 gap-2" id="walletContainer"></div>
</div>

<div id="limit-items" class="bg-slate-900/60 p-4 rounded-[25px] border border-slate-800 mb-4 space-y-3"></div>

<div class="flex gap-2 mb-4 font-black">
    <button onclick="openModal('expense')" class="flex-1 bg-rose-600 py-3 rounded-xl text-[10px] uppercase border-b-4 border-rose-900 shadow-lg text-white">–†–∞—Å—Ö–æ–¥</button>
    <button onclick="openModal('transfer')" class="flex-1 bg-slate-700 py-3 rounded-xl text-[10px] uppercase border-b-4 border-slate-900 shadow-lg text-white">–ü–µ—Ä–µ–≤–æ–¥</button>
    <button onclick="openModal('income')" class="flex-1 bg-emerald-600 py-3 rounded-xl text-[10px] uppercase border-b-4 border-emerald-900 shadow-lg text-white">–î–æ—Ö–æ–¥</button>
</div>

<div id="history" class="space-y-2 text-left"></div>

<div id="modal" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center p-4 z-50 text-center">
    <div class="bg-slate-900 w-full max-w-sm rounded-[35px] p-5 border border-slate-800 shadow-2xl overflow-y-auto max-h-[90vh]">
        <div class="flex gap-1 mb-4 bg-slate-800 p-1 rounded-xl font-bold">
            <button onclick="switchType('expense')" id="btnExp" class="flex-1 py-2 rounded-lg text-[8px] uppercase transition-all">–†–∞—Å—Ö–æ–¥</button>
            <button onclick="switchType('transfer')" id="btnTrf" class="flex-1 py-2 rounded-lg text-[8px] uppercase transition-all text-slate-500">–ü–µ—Ä–µ–≤–æ–¥</button>
            <button onclick="switchType('income')" id="btnInc" class="flex-1 py-2 rounded-lg text-[8px] uppercase transition-all text-slate-500">–î–æ—Ö–æ–¥</button>
        </div>
        <form onsubmit="save(event)" class="space-y-3">
            <input type="hidden" id="txType"><input type="hidden" id="editRowId">
            <input type="date" id="date" class="w-full bg-slate-800 p-3 text-white text-xs font-bold border border-slate-700 outline-none">
            <input id="merchant" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ / –ò—Å—Ç–æ—á–Ω–∏–∫" class="w-full bg-slate-800 p-3 text-white text-xs font-bold border border-slate-700 outline-none text-center">

            <div id="expenseFields" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-2 text-white text-xs font-bold italic">
                    <input type="text" id="nameDE" placeholder="Name (DE)" class="bg-slate-800 p-3 border border-slate-700 outline-none">
                    <input type="text" id="nameRU" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–†–£)" class="bg-slate-800 p-3 border border-slate-700 outline-none text-blue-300">
                </div>
                <div class="grid grid-cols-2 gap-2 bg-slate-800/50 p-2 border border-slate-700 text-white text-xs">
                    <div><label class="text-[7px] text-slate-500 uppercase block">–ö–æ–ª-–≤–æ</label><input type="number" id="qty" value="1" step="0.01" class="w-full bg-transparent font-black outline-none text-center"></div>
                    <div class="border-l border-slate-700 pl-2"><label class="text-[7px] text-yellow-500 uppercase block">–¶–µ–Ω–∞ ‚Ç¨</label><input type="number" id="priceUnit" step="0.01" placeholder="0.00" class="w-full bg-transparent font-black outline-none text-center"></div>
                </div>
            </div>

            <div id="incomeFields" class="hidden space-y-3">
                <select id="accInc" class="w-full bg-slate-800 p-3 text-emerald-400 font-bold text-xs border border-slate-700 outline-none"><option value="Sparkasse">–ù–∞ Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ù–∞ –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞ –ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ù–∞ –ù–∞–ª ‚Ç¥</option><option value="–ö–û–ü–ò–õ–ö–ê">–í –ö–û–ü–ò–õ–ö–£</option><option value="–ö–û–ù–í–ï–†–¢">–í –ö–û–ù–í–ï–†–¢</option><option value="–°–í–ò–ù–ö–ê">–í –°–í–ò–ù–ö–£</option></select>
                <input type="number" id="simplePrice" step="0.01" placeholder="–°—É–º–º–∞" class="w-full bg-slate-800 p-3 text-xl font-black text-white border border-slate-700 outline-none text-center">
            </div>

            <div id="transferFields" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <select id="tFrom" class="bg-slate-800 p-3 text-white text-[10px] font-bold border border-slate-700 outline-none"><option value="Sparkasse">–ò–∑ Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ò–∑ –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ò–∑ –ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ò–∑ –ù–∞–ª ‚Ç¥</option><option value="–ö–û–ü–ò–õ–ö–ê">–ò–∑ –ö–û–ü–ò–õ–ö–ò</option><option value="–ö–û–ù–í–ï–†–¢">–ò–∑ –ö–û–ù–í–ï–†–¢–ê</option><option value="–°–í–ò–ù–ö–ê">–ò–∑ –°–í–ò–ù–ö–ò</option></select>
                    <select id="tTo" class="bg-slate-800 p-3 text-yellow-500 text-[10px] font-bold border border-slate-700 outline-none"><option value="–ö–û–ü–ò–õ–ö–ê">–í –ö–û–ü–ò–õ–ö–£</option><option value="–ö–û–ù–í–ï–†–¢">–í –ö–û–ù–í–ï–†–¢</option><option value="–°–í–ò–ù–ö–ê">–í –°–í–ò–ù–ö–£</option><option value="Sparkasse">–í Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–í –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–í –ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–í –ù–∞–ª ‚Ç¥</option></select>
                </div>
                <input type="number" id="tAmountFrom" step="0.01" class="w-full bg-slate-800 p-3 text-lg font-black text-white border border-slate-700 outline-none text-center" placeholder="–°—É–º–º–∞">
            </div>

            <div id="accCatGroup" class="grid grid-cols-2 gap-2">
                <select id="acc" class="bg-slate-800 p-3 text-white text-[10px] font-bold border border-slate-700 outline-none"><option value="Sparkasse">Sparkasse</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞–ª ‚Ç¨</option><option value="–ö–û–ü–ò–õ–ö–ê">–ö–û–ü–ò–õ–ö–ê</option><option value="–ü—Ä–∏–≤–∞—Ç">–ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ù–∞–ª ‚Ç¥</option><option value="–ö–û–ù–í–ï–†–¢">–ö–û–ù–í–ï–†–¢</option><option value="–°–í–ò–ù–ö–ê">–°–í–ò–ù–ö–ê</option></select>
                <select id="cat" class="bg-slate-800 p-3 text-white text-[10px] font-bold border border-slate-700 outline-none"><option>üçé –ü—Ä–æ–¥—É–∫—Ç—ã / –ë—ã—Ç</option><option>üö¨ –¢–∞–±–∞–∫ / –û—Ç–¥—ã—Ö</option><option>üè† –ñ–∏–ª—å–µ / –°—á–µ—Ç–∞</option><option>üíä –ó–¥–æ—Ä–æ–≤—å–µ</option><option>üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option>üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ</option></select>
            </div>
            <div class="flex gap-2 pt-2"><button type="button" onclick="closeModal()" class="flex-1 bg-slate-800 py-3 rounded-xl font-bold uppercase text-[9px] text-white">–û—Ç–º–µ–Ω–∞</button><button id="saveBtn" class="flex-[2] bg-yellow-500 text-black py-3 rounded-xl font-black uppercase text-xs">–ó–∞–ø–∏—Å–∞—Ç—å</button></div>
        </form>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz4-b-RtsW9Gy1-H7E27APtoNL1GwTNRyZAANSe0L52ds31BwF89uydrxrzLgyHaFL9/exec";
const MY_LIMITS = { "üçé –ü—Ä–æ–¥—É–∫—Ç—ã / –ë—ã—Ç": 350, "üè† –ñ–∏–ª—å–µ / –°—á–µ—Ç–∞": 50, "üö¨ –¢–∞–±–∞–∫ / –û—Ç–¥—ã—Ö": 120, "üíä –ó–¥–æ—Ä–æ–≤—å–µ": 80, "üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç": 70, "üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ": 30 };
let walletData = { "Sparkasse": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ö–û–ü–ò–õ–ö–ê": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0, "–ö–û–ù–í–ï–†–¢": 0, "–°–í–ò–ù–ö–ê": 0 };
let spentThisMonth = {};
let allData = [];

function isUah(acc) { return ["–ü—Ä–∏–≤–∞—Ç", "–ù–∞–ª–∏—á–Ω—ã–µ UAH", "–ö–û–ù–í–ï–†–¢", "–°–í–ò–ù–ö–ê"].includes(acc); }

function drawBalance() {
    const r = parseFloat(document.getElementById('baseRate').value) || 50.76;
    const container = document.getElementById('walletContainer'); container.innerHTML = "";
    let totalEur = 0;
    for(let k in walletData) {
        const val = walletData[k], isU = isUah(k), eurEq = isU ? val / r : val;
        totalEur += eurEq;
        container.innerHTML += `<div class="bg-slate-800/40 p-2 rounded-xl border border-slate-700/30 text-center"><div class="text-[7px] text-slate-500 uppercase font-black text-center">${k}</div><div class="text-[10px] font-black text-white text-center">${isU?'‚Ç¥':'‚Ç¨'} ${val.toFixed(2)}</div>${isU ? `<div class="text-[7px] text-slate-600 italic text-center">‚Ç¨ ${eurEq.toFixed(2)}</div>` : ''}</div>`;
    }
    document.getElementById('mainBalance').innerText = '‚Ç¨ ' + totalEur.toFixed(2);
    drawLimits();
}

function drawLimits() {
    const container = document.getElementById('limit-items'); container.innerHTML = "";
    const today = new Date(), daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate(), daysLeft = daysInMonth - today.getDate() + 1;
    for (let cat in MY_LIMITS) {
        const spent = Math.abs(spentThisMonth[cat] || 0), limit = MY_LIMITS[cat], percent = Math.min((spent / limit) * 100, 100);
        let color = percent > 75 ? (percent >= 100 ? "bg-rose-500" : "bg-yellow-500") : "bg-emerald-500";
        container.innerHTML += `<div><div class="flex justify-between text-[8px] font-bold mb-1 uppercase italic tracking-tighter"><span>${cat}</span><span class="text-slate-500">${spent.toFixed(0)} / ${limit} ‚Ç¨</span></div><div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden border border-slate-700/30"><div class="${color} h-full transition-all" style="width: ${percent}%"></div></div></div>`;
    }
}

function draw(data) {
    if (!data || !data.rows) return;
    allData = data.rows;
    walletData = { "Sparkasse": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ö–û–ü–ò–õ–ö–ê": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0, "–ö–û–ù–í–ï–†–¢": 0, "–°–í–ò–ù–ö–ê": 0 };
    spentThisMonth = {}; const now = new Date();
    
    allData.forEach(r => {
        const cat = r[1], accF = r[5], date = new Date(r[0]);
        const eurVal = parseFloat(r[8] || 0), uahVal = parseFloat(r[10] || 0);

        // –ü–†–Ø–ú–û–ï –°–£–ú–ú–ò–†–û–í–ê–ù–ò–ï: –ö–æ—à–µ–ª–µ–∫ –∏–∑ F –ø—Ä–æ—Å—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
        if (walletData.hasOwnProperty(accF)) {
            walletData[accF] += (isUah(accF) ? uahVal : eurVal);
        }

        if (date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear() && eurVal < 0 && !cat.includes("–ü–µ—Ä–µ–≤–æ–¥") && !cat.includes("–î–æ—Ö–æ–¥")) {
            const lCat = MY_LIMITS.hasOwnProperty(cat) ? cat : "üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ";
            spentThisMonth[lCat] = (spentThisMonth[lCat] || 0) + eurVal;
        }
    });
    filterHistory(); drawBalance();
}

function filterHistory() {
    const hist = document.getElementById('history'); hist.innerHTML = "";
    allData.slice().reverse().slice(0, 30).forEach(r => {
        const acc = r[5], isU = isUah(acc), valMain = Math.abs(isU ? r[10] : r[8]), cat = r[1];
        const isInc = (isU ? r[10] : r[8]) > 0;
        const rowId = r[r.length-1];
        let catIcon = cat.split(' ')[0];
        if(cat === "üîÑ –ü–µ—Ä–µ–≤–æ–¥") catIcon = "üîÑ"; if(cat === "üíé –î–æ—Ö–æ–¥") catIcon = "üí∞";
        hist.innerHTML += `<div class="bg-slate-900/40 p-2.5 rounded-xl border border-slate-800 mb-2 flex justify-between items-center text-left">
            <div class="flex items-center gap-2 truncate text-left">
                <button onclick="deleteRow(${rowId})" class="text-slate-700 hover:text-rose-500"><i class="fa-solid fa-trash-can text-[9px]"></i></button>
                <div class="truncate text-left">
                    <div class="text-[7px] text-slate-600 font-bold uppercase italic text-left">${String(r[0]).split('T')[0].substring(5)} ‚Ä¢ ${acc}</div>
                    <div class="text-[10px] font-bold text-white truncate text-left">${catIcon} ${r[2]}</div>
                </div>
            </div>
            <div class="text-right min-w-fit font-black text-[11px] ${isInc?'text-emerald-500':'text-rose-500'} italic">
                ${isInc?'+':'-'}${valMain.toFixed(2)}${isU?'‚Ç¥':'‚Ç¨'}
            </div>
        </div>`;
    });
}

async function save(e) {
    e.preventDefault(); const btn = document.getElementById('saveBtn'); btn.disabled = true; btn.innerText = "‚è≥";
    const type = document.getElementById('txType').value, rate = parseFloat(document.getElementById('baseRate').value);
    const date = document.getElementById('date').value;

    if(type === 'transfer') {
        const f = document.getElementById('tFrom').value, t = document.getElementById('tTo').value, amF = parseFloat(document.getElementById('tAmountFrom').value)||0;
        
        // –°–¢–†–û–ö–ê 1: –£–º–µ–Ω—å—à–∞–µ–º –∫–æ—à–µ–ª–µ–∫-–∏—Å—Ç–æ—á–Ω–∏–∫
        let p1 = { action: 'add', date: date, rate: rate, category: "üîÑ –ü–µ—Ä–µ–≤–æ–¥", account: f, merchant: "‚û°Ô∏è " + t };
        if(isUah(f)) { p1.totalCard = -Math.abs(amF); p1.curCard = "UAH"; p1.totalTran = -(amF/rate); } 
        else { p1.totalTran = -Math.abs(amF); }
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(p1) });

        // –°–¢–†–û–ö–ê 2: –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ—à–µ–ª–µ–∫-—Ü–µ–ª—å
        let p2 = { action: 'add', date: date, rate: rate, category: "üîÑ –ü–µ—Ä–µ–≤–æ–¥", account: t, merchant: "‚¨ÖÔ∏è " + f };
        if(isUah(t)) { p2.totalCard = Math.abs(amF); p2.curCard = "UAH"; p2.totalTran = amF/rate; } 
        else { p2.totalTran = Math.abs(amF); }
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(p2) });

    } else if(type === 'expense') {
        const q = parseFloat(document.getElementById('qty').value)||1, p = parseFloat(document.getElementById('priceUnit').value)||0;
        let payload = { action: 'add', date: date, rate: rate, merchant: document.getElementById('merchant').value, category: document.getElementById('cat').value, account: document.getElementById('acc').value, nameDE: document.getElementById('nameDE').value, nameRU: document.getElementById('nameRU').value, qty: q, priceUnit: p, totalTran: -(q*p) };
        if(isUah(payload.account)){ payload.totalCard=-(q*p*rate); payload.curCard="UAH"; }
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
    } else if(type === 'income') {
        const p = parseFloat(document.getElementById('simplePrice').value)||0, target = document.getElementById('accInc').value;
        let payload = { action: 'add', date: date, rate: rate, merchant: "üíé " + document.getElementById('merchant').value, category: "üíé –î–æ—Ö–æ–¥", account: target };
        if(isUah(target)){ payload.totalCard=Math.abs(p); payload.curCard="UAH"; payload.totalTran=p/rate; } else payload.totalTran=Math.abs(p);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
    }
    location.reload();
}

function openModal(type) { document.getElementById('modal').classList.remove('hidden'); switchType(type); }
function closeModal() { document.getElementById('modal').classList.add('hidden'); }
function switchType(type) {
    document.getElementById('txType').value = type;
    document.getElementById('expenseFields').classList.toggle('hidden', type !== 'expense');
    document.getElementById('incomeFields').classList.toggle('hidden', type !== 'income');
    document.getElementById('transferFields').classList.toggle('hidden', type !== 'transfer');
    document.getElementById('accCatGroup').classList.toggle('hidden', type !== 'expense');
}
async function deleteRow(id) { if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return; await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'delete', rowId: id}) }); location.reload(); }
window.onload = () => { const s = document.createElement('script'); s.src = API_URL + "?callback=draw&_t=" + new Date().getTime(); document.body.appendChild(s); };
</script>
</body>
</html>
