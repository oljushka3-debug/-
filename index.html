<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartWallet Pro v16.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-950 text-slate-100 p-4 pb-10">

<button onclick="location.reload()" class="fixed top-6 right-6 z-50 bg-slate-800/80 w-10 h-10 rounded-full border border-slate-700 flex items-center justify-center active:rotate-180 transition-transform shadow-xl">
    <i class="fa-solid fa-rotate text-blue-400"></i>
</button>

<div class="bg-gradient-to-br from-slate-900 to-slate-800 p-5 rounded-[30px] border border-slate-700/50 mb-4 shadow-2xl">
    <div class="flex justify-between items-center mb-3 text-[10px] font-bold opacity-60 uppercase italic">
        <span>–ö—É—Ä—Å: <input type="number" id="baseRate" value="50.76" step="0.01" oninput="drawBalance()" class="w-10 bg-transparent text-yellow-500 outline-none font-black"></span>
        <span id="currentMonth">–Ø–ù–í–ê–†–¨</span>
    </div>
    <h1 id="mainBalance" class="text-center text-4xl font-black italic mb-4 tracking-tighter">‚Ç¨ 0.00</h1>
    <div class="grid grid-cols-2 gap-2 text-[9px] font-bold uppercase italic text-center text-white">
        <div class="bg-slate-800/40 p-2 rounded-xl border border-blue-500/10 text-blue-400">Sparkasse: <span id="acc-Sparkasse" class="block text-white text-xs mt-1 font-black italic">‚Ç¨ 0.00</span></div>
        <div class="bg-slate-800/40 p-2 rounded-xl border border-green-500/10 text-green-500">–ü—Ä–∏–≤–∞—Ç: <span id="acc-–ü—Ä–∏–≤–∞—Ç" class="block text-white text-xs mt-1 font-black italic">‚Ç¥ 0.00</span></div>
        <div class="bg-slate-800/40 p-2 rounded-xl border border-yellow-500/10 text-yellow-500">–ù–∞–ª ‚Ç¨: <span id="acc-–ù–∞–ª–∏—á–Ω—ã–µ EUR" class="block text-white text-xs mt-1 font-black italic">‚Ç¨ 0.00</span></div>
        <div class="bg-slate-800/40 p-2 rounded-xl border border-orange-500/10 text-orange-500">–ù–∞–ª ‚Ç¥: <span id="acc-–ù–∞–ª–∏—á–Ω—ã–µ UAH" class="block text-white text-xs mt-1 font-black italic">‚Ç¥ 0.00</span></div>
    </div>
</div>

<div class="flex gap-2 mb-8 font-black">
    <button onclick="openModal('expense')" class="flex-1 bg-rose-600 py-4 rounded-2xl text-[10px] uppercase border-b-4 border-rose-900 active:scale-95 shadow-lg shadow-rose-900/20">–†–∞—Å—Ö–æ–¥</button>
    <button onclick="openModal('transfer')" class="flex-1 bg-slate-700 py-4 rounded-2xl text-[10px] uppercase border-b-4 border-slate-900 text-white shadow-lg">–ü–µ—Ä–µ–≤–æ–¥</button>
    <button onclick="openModal('income')" class="flex-1 bg-emerald-600 py-4 rounded-2xl text-[10px] uppercase border-b-4 border-emerald-900 active:scale-95 shadow-lg shadow-emerald-900/20">–î–æ—Ö–æ–¥</button>
</div>

<div id="history" class="space-y-2 text-white font-medium"></div>

<div id="modal" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center p-4 z-50">
    <div class="bg-slate-900 w-full max-w-sm rounded-[45px] p-6 border border-slate-800 shadow-2xl overflow-y-auto max-h-[95vh]">
        <h2 id="modalTitle" class="text-xl font-black text-yellow-500 mb-4 italic uppercase text-center tracking-widest underline underline-offset-8 decoration-slate-800">–ó–∞–ø–∏—Å—å</h2>
        <form onsubmit="save(event)" class="space-y-3">
            <input type="hidden" id="txType">
            <input type="date" id="date" class="w-full bg-slate-800 p-3 rounded-xl font-bold border border-slate-700 text-white text-sm">
            
            <input type="text" id="merchant" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ / –ú–∞–≥–∞–∑–∏–Ω" class="w-full bg-slate-800 p-3 rounded-xl outline-none font-bold border border-slate-700 text-white text-sm">

            <div id="expenseFields" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="nameDE" placeholder="Name (DE)" class="bg-slate-800 p-3 rounded-xl border border-slate-700 text-xs text-white">
                    <input type="text" id="nameRU" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–†–£)" class="bg-slate-800 p-3 rounded-xl border border-slate-700 text-xs text-blue-300">
                </div>
                <div class="grid grid-cols-2 gap-2 bg-slate-800/50 p-3 rounded-2xl border border-slate-700">
                    <div>
                        <label class="text-[8px] text-slate-500 uppercase block ml-1 mb-1">–ö–æ–ª-–≤–æ</label>
                        <input type="number" id="qty" value="1" step="0.01" class="w-full bg-transparent text-lg font-black outline-none text-white">
                    </div>
                    <div class="text-right border-l border-slate-700 pl-2">
                        <label class="text-[8px] text-yellow-500 uppercase block mr-1 mb-1">–¶–µ–Ω–∞ –∑–∞ –µ–¥. ‚Ç¨</label>
                        <input type="number" id="priceUnit" step="0.01" placeholder="0.00" class="w-full bg-transparent text-lg font-black outline-none text-right text-white">
                    </div>
                </div>
            </div>

            <div id="incomeFields" class="hidden">
                <input type="number" id="simplePrice" step="0.01" placeholder="0.00" class="w-full bg-slate-800 p-4 rounded-xl text-center text-2xl font-black text-emerald-400 outline-none border border-slate-700">
            </div>

            <div id="transferFields" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <select id="tFrom" class="bg-slate-800 p-3 rounded-xl border border-slate-700 text-[10px] text-white font-bold"><option value="Sparkasse">–ò–∑ Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ò–∑ –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ò–∑ –ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ò–∑ –ù–∞–ª ‚Ç¥</option></select>
                    <select id="tTo" class="bg-slate-800 p-3 rounded-xl border border-slate-700 text-[10px] text-yellow-500 font-bold"><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–í –ù–∞–ª ‚Ç¨</option><option value="–ü—Ä–∏–≤–∞—Ç">–í –ü—Ä–∏–≤–∞—Ç</option><option value="Sparkasse">–í Sparkasse</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–í –ù–∞–ª ‚Ç¥</option></select>
                </div>
                <input type="number" id="tAmountFrom" step="0.01" class="w-full bg-slate-800 p-4 rounded-xl text-center text-xl font-black text-white outline-none border border-slate-700" placeholder="0.00">
            </div>

            <div id="accCatGroup" class="grid grid-cols-2 gap-2">
                <select id="acc" class="bg-slate-800 p-3 rounded-xl font-bold text-[10px] border border-slate-700 text-white"><option value="Sparkasse">Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ù–∞–ª ‚Ç¥</option></select>
                <select id="cat" class="bg-slate-800 p-3 rounded-xl font-bold text-[10px] border border-slate-700 text-white">
                    <option>üçé –ü—Ä–æ–¥—É–∫—Ç—ã / –ë—ã—Ç</option><option>üö¨ –¢–∞–±–∞–∫ / –û—Ç–¥—ã—Ö</option><option>üè† –ñ–∏–ª—å–µ / –°—á–µ—Ç–∞</option><option>üíä –ó–¥–æ—Ä–æ–≤—å–µ</option><option>üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option>üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ</option>
                </select>
            </div>

            <div class="flex gap-2 pt-2">
                <button type="button" onclick="closeModal()" class="flex-1 bg-slate-800 py-4 rounded-2xl font-bold uppercase text-[10px] border border-slate-700">–û—Ç–º–µ–Ω–∞</button>
                <button id="saveBtn" class="flex-[2] bg-yellow-500 text-black py-4 rounded-2xl font-black uppercase shadow-lg shadow-yellow-500/10">–ó–∞–ø–∏—Å–∞—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<script>
// –í–°–¢–ê–í–¨ –°–í–û–Æ –°–°–´–õ–ö–£ –ù–ò–ñ–ï
const API_URL = "https://script.google.com/macros/s/AKfycbxLKG4UDaHFNnYCfPaPvKRgrHtOilPK1gc8w0ScfdxwAyWgtNSHKlbZPCfyR-IxTztB/exec";

let walletData = { "Sparkasse": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0 };
function isUah(acc) { return acc && (acc.includes('–ü—Ä–∏–≤–∞—Ç') || acc.includes('UAH')); }

function drawBalance() {
    const r = parseFloat(document.getElementById('baseRate').value) || 50.76;
    for(let k in walletData) {
        const el = document.getElementById('acc-'+k);
        if(el) el.innerText = (isUah(k) ? '‚Ç¥ ' : '‚Ç¨ ') + walletData[k].toFixed(2);
    }
    const total = walletData["Sparkasse"] + walletData["–ù–∞–ª–∏—á–Ω—ã–µ EUR"] + (walletData["–ü—Ä–∏–≤–∞—Ç"] + walletData["–ù–∞–ª–∏—á–Ω—ã–µ UAH"]) / r;
    document.getElementById('mainBalance').innerText = '‚Ç¨ ' + total.toFixed(2);
}

function draw(data) {
    if (!data || !data.rows) return;
    const hist = document.getElementById('history'); hist.innerHTML = "";
    walletData = { "Sparkasse": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0 };
    
    data.rows.forEach(r => {
        const acc = r[5], eur = parseFloat(r[8] || 0), uahVal = parseFloat(r[10] || 0);
        if (walletData.hasOwnProperty(acc)) walletData[acc] += (isUah(acc) ? uahVal : eur);
    });

    data.rows.slice().reverse().slice(0, 20).forEach(r => {
        const acc = r[5], isU = isUah(acc), val = Math.abs(isU ? r[10] : r[8]), isInc = (isU ? r[10] : r[8]) > 0;
        const rowId = r[r.length-1];
        hist.innerHTML += `<div class="bg-slate-900/40 p-3 rounded-2xl flex justify-between items-center border border-slate-800 mb-2">
            <div class="flex items-center gap-3 overflow-hidden">
                <button onclick="deleteRow(${rowId})" class="text-slate-700 hover:text-rose-500 transition-colors"><i class="fa-solid fa-trash-can text-[10px]"></i></button>
                <div class="truncate">
                    <p class="text-[7px] text-slate-600 font-bold uppercase italic">${String(r[0]).split('T')[0].substring(5)} | ${acc}</p>
                    <p class="text-white text-[10px] font-bold truncate">${r[2] || '...'}</p>
                    ${r[4] ? `<p class="text-[9px] text-blue-400 italic font-medium truncate">${r[4]} (${r[6]} —à—Ç.)</p>` : ''}
                </div>
            </div>
            <div class="text-right ml-2">
                <div class="font-black text-[11px] ${isInc?'text-emerald-500':'text-rose-500'} italic whitespace-nowrap">${isInc?'+':'-'}${val.toFixed(2)} ${isU?'‚Ç¥':'‚Ç¨'}</div>
            </div>
        </div>`;
    });
    drawBalance();
}

async function deleteRow(id) {
    if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã?')) return;
    await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'delete', rowId: id}) });
    location.reload();
}

async function save(e) {
    e.preventDefault();
    const btn = document.getElementById('saveBtn'); btn.disabled = true; btn.innerText = "‚è≥";
    const type = document.getElementById('txType').value, rate = parseFloat(document.getElementById('baseRate').value), date = document.getElementById('date').value || new Date().toISOString().split('T')[0];
    let payload = { action: 'add', date: date, rate: rate, merchant: document.getElementById('merchant').value };

    if(type === 'expense') {
        const q = parseFloat(document.getElementById('qty').value) || 1;
        const p = parseFloat(document.getElementById('priceUnit').value) || 0;
        payload.category = document.getElementById('cat').value;
        payload.account = document.getElementById('acc').value;
        payload.nameDE = document.getElementById('nameDE').value;
        payload.nameRU = document.getElementById('nameRU').value;
        payload.qty = q;
        payload.priceUnit = p;
        payload.totalTran = -(q * p);
        if (isUah(payload.account)) { payload.totalCard = -(q * p * rate); payload.curCard = "UAH"; }
    } else if(type === 'income') {
        const p = parseFloat(document.getElementById('simplePrice').value) || 0;
        payload.category = "üíé –î–æ—Ö–æ–¥";
        payload.account = document.getElementById('acc').value;
        if (isUah(payload.account)) { payload.totalCard = p; payload.curCard = "UAH"; payload.totalTran = p / rate; }
        else { payload.totalTran = p; }
    } else if(type === 'transfer') {
        const fAcc = document.getElementById('tFrom').value, tAcc = document.getElementById('tTo').value, amF = parseFloat(document.getElementById('tAmountFrom').value) || 0;
        payload.category = "üîÑ –ü–µ—Ä–µ–≤–æ–¥"; payload.account = fAcc; payload.targetAcc = tAcc;
        if (isUah(fAcc)) { payload.totalCard = -amF; payload.curCard = "UAH"; payload.totalTran = -amF/rate; }
        else if (isUah(tAcc)) { payload.totalTran = -amF; payload.totalCard = amF*rate; payload.curCard = "UAH"; }
        else { payload.totalTran = -amF; }
    }
    
    await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
    location.reload();
}

function openModal(type) {
    document.getElementById('txType').value = type; document.getElementById('modal').classList.remove('hidden');
    document.getElementById('expenseFields').classList.toggle('hidden', type !== 'expense');
    document.getElementById('incomeFields').classList.toggle('hidden', type !== 'income');
    document.getElementById('transferFields').classList.toggle('hidden', type !== 'transfer');
    document.getElementById('accCatGroup').classList.toggle('hidden', type === 'transfer');
    document.getElementById('modalTitle').innerText = type === 'expense' ? '–†–ê–°–•–û–î' : (type === 'income' ? '–î–û–•–û–î' : '–ü–ï–†–ï–í–û–î');
}
function closeModal() { document.getElementById('modal').classList.add('hidden'); }

window.onload = () => {
    const t = new Date().getTime(); const s = document.createElement('script');
    s.src = API_URL + "?callback=draw&_t=" + t; document.body.appendChild(s);
};
</script>
</body>
</html>
