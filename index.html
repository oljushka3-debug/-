<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartWallet v9.1 Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-950 text-slate-100 p-4">

    <div class="bg-slate-900 p-6 rounded-[30px] shadow-2xl mb-6 border border-slate-800">
        <div class="flex justify-between items-center mb-4 text-[10px] font-bold text-slate-500">
            <span>–ö–£–†–°: <input type="number" id="rate" value="50.76" step="0.01" class="bg-transparent text-yellow-400 outline-none w-10"></span>
            <span>–ë–ê–õ–ê–ù–° (EUR)</span>
        </div>
        <h1 id="mainBalance" class="text-center text-4xl font-black italic mb-6">‚Ç¨ 0.00</h1>
        <div class="grid grid-cols-2 gap-2 text-[9px] uppercase font-bold text-slate-400">
            <div class="bg-slate-800 p-2 rounded-xl">Sparkasse: <span id="acc-Sparkasse" class="block text-white text-xs">‚Ç¨ 0.00</span></div>
            <div class="bg-slate-800 p-2 rounded-xl">–ü—Ä–∏–≤–∞—Ç: <span id="acc-–ü—Ä–∏–≤–∞—Ç" class="block text-white text-xs">‚Ç¥ 0.00</span></div>
            <div class="bg-slate-800 p-2 rounded-xl">–ù–∞–ª ‚Ç¨: <span id="acc-–ù–∞–ª–∏—á–Ω—ã–µ EUR" class="block text-white text-xs">‚Ç¨ 0.00</span></div>
            <div class="bg-slate-800 p-2 rounded-xl">–ù–∞–ª ‚Ç¥: <span id="acc-–ù–∞–ª–∏—á–Ω—ã–µ UAH" class="block text-white text-xs">‚Ç¥ 0.00</span></div>
        </div>
    </div>

    <div class="flex gap-2 mb-6">
        <button onclick="openModal('expense')" class="flex-1 bg-rose-600 py-4 rounded-xl font-bold text-xs uppercase shadow-lg">–†–∞—Å—Ö–æ–¥</button>
        <button onclick="openModal('transfer')" class="flex-1 bg-slate-700 py-4 rounded-xl font-bold text-xs uppercase shadow-lg">–ü–µ—Ä–µ–≤–æ–¥</button>
        <button onclick="openModal('income')" class="flex-1 bg-emerald-600 py-4 rounded-xl font-bold text-xs uppercase shadow-lg">–î–æ—Ö–æ–¥</button>
    </div>

    <div id="history" class="space-y-2 text-[10px]"></div>

    <div id="modal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-slate-900 w-full max-w-sm rounded-[30px] p-6 border border-slate-800">
            <h2 id="modalTitle" class="text-lg font-bold mb-4 text-yellow-500 uppercase">–ó–ê–ü–ò–°–¨</h2>
            <form onsubmit="save(event)" class="space-y-3">
                <input type="hidden" id="txType">
                <input type="date" id="date" class="w-full bg-slate-800 p-3 rounded-xl outline-none font-bold">
                
                <div id="standardFields" class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="qty" value="1" placeholder="–ö–æ–ª-–≤–æ" class="bg-slate-800 p-3 rounded-xl text-center outline-none">
                        <input type="number" id="price" step="0.01" placeholder="–¶–µ–Ω–∞" class="bg-slate-800 p-3 rounded-xl text-center outline-none font-bold text-yellow-400">
                    </div>
                    <input type="text" id="merchant" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ / –ú–∞–≥–∞–∑–∏–Ω" class="w-full bg-slate-800 p-3 rounded-xl outline-none">
                    <div id="itemsGroup" class="grid grid-cols-2 gap-2">
                        <input type="text" id="itemDE" placeholder="DE" class="bg-slate-800 p-3 rounded-xl text-xs outline-none">
                        <input type="text" id="itemRU" placeholder="RU" class="bg-slate-800 p-3 rounded-xl text-xs outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-2 font-bold">
                        <select id="acc" class="bg-slate-800 p-3 rounded-xl outline-none text-[10px]"><option value="Sparkasse">Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ù–∞–ª ‚Ç¥</option></select>
                        <select id="cat" class="bg-slate-800 p-3 rounded-xl outline-none text-[10px]"><option>üçé –ü—Ä–æ–¥—É–∫—Ç—ã</option><option>üè† –î–æ–º</option><option>üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option value="üíé –î–æ—Ö–æ–¥">üíé –î–æ—Ö–æ–¥</option></select>
                    </div>
                </div>

                <div id="transferFields" class="hidden space-y-3">
                    <select id="tFrom" class="w-full bg-slate-800 p-3 rounded-xl text-xs outline-none"><option value="Sparkasse">–û–¢–ö–£–î–ê: Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–û–¢–ö–£–î–ê: –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–û–¢–ö–£–î–ê: –ù–∞–ª ‚Ç¨</option></select>
                    <select id="tTo" class="w-full bg-slate-800 p-3 rounded-xl text-xs outline-none"><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ö–£–î–ê: –ù–∞–ª ‚Ç¨</option><option value="–ü—Ä–∏–≤–∞—Ç">–ö–£–î–ê: –ü—Ä–∏–≤–∞—Ç</option><option value="Sparkasse">–ö–£–î–ê: Sparkasse</option></select>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="tAmountFrom" placeholder="–°—É–º–º–∞ –û–¢" class="bg-slate-800 p-3 rounded-xl outline-none">
                        <input type="number" id="tAmountTo" placeholder="–°—É–º–º–∞ –í" class="bg-slate-800 p-3 rounded-xl outline-none text-yellow-400">
                    </div>
                </div>

                <button id="saveBtn" class="w-full bg-yellow-500 text-black py-4 rounded-xl font-black uppercase">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
                <button type="button" onclick="closeModal()" class="w-full text-slate-500 text-[10px] uppercase font-bold">–û–¢–ú–ï–ù–ê</button>
            </form>
        </div>
    </div>

    <script>
        // –í–ê–ñ–ù–û: –ó–ê–ú–ï–ù–ò –≠–¢–£ –°–°–´–õ–ö–£!
        const API_URL = "https://script.google.com/macros/s/AKfycbw04FM_3-iMMSwKvoan_uksC4uuZM1iHavNOT1sMOHMprDa7Zu1OdBEMOqHojS_bjVX/exec";

        function isUah(acc) { return acc.includes('–ü—Ä–∏–≤–∞—Ç') || acc.includes('UAH'); }

        function openModal(type) {
            document.getElementById('txType').value = type;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            const isT = type === 'transfer', isInc = type === 'income';
            document.getElementById('standardFields').classList.toggle('hidden', isT);
            document.getElementById('transferFields').classList.toggle('hidden', !isT);
            document.getElementById('itemsGroup').classList.toggle('hidden', isInc);
            if(isInc) document.getElementById('cat').value = "üíé –î–æ—Ö–æ–¥";
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function save(e) {
            e.preventDefault();
            const btn = document.getElementById('saveBtn'); btn.disabled = true; btn.innerText = "‚è≥...";
            const type = document.getElementById('txType').value, rate = document.getElementById('rate').value;
            let payload = { action: type, date: document.getElementById('date').value, rate: rate };

            if(type === 'transfer') {
                payload.fromAcc = document.getElementById('tFrom').value; payload.toAcc = document.getElementById('tTo').value;
                payload.amountFrom = document.getElementById('tAmountFrom').value; payload.amountTo = document.getElementById('tAmountTo').value;
                payload.fromCur = isUah(payload.fromAcc) ? "UAH" : "EUR"; payload.toCur = isUah(payload.toAcc) ? "UAH" : "EUR";
            } else {
                const q = document.getElementById('qty').value, p = document.getElementById('price').value, acc = document.getElementById('acc').value, cat = document.getElementById('cat').value;
                payload.action = 'add'; payload.category = cat; payload.merchant = document.getElementById('merchant').value;
                payload.itemDE = document.getElementById('itemDE').value; payload.itemRU = document.getElementById('itemRU').value;
                payload.account = acc; payload.qty = q; payload.priceUnit = p; payload.totalTran = (q*p).toFixed(2);
                payload.curTran = isUah(acc) ? "UAH" : "EUR";
                let val = isUah(acc) ? (q*p*rate).toFixed(2) : (q*p);
                payload.totalCard = (cat.includes('–î–æ—Ö–æ–¥') || cat.includes('üíé')) ? val : -val;
                payload.curCard = payload.curTran;
            }
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            location.reload();
        }

        function draw(data) {
            const hist = document.getElementById('history'); hist.innerHTML = "";
            let b = { "Sparkasse": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0 };
            if(!data.rows) return;
            data.rows.forEach(r => {
                const acc = r[5], cat = String(r[1]);
                if (b.hasOwnProperty(acc)) {
                    let val = Math.abs(isUah(acc) ? r[10] : r[8]);
                    b[acc] += (cat.includes('–î–æ—Ö–æ–¥') || cat.includes('üíé') || r[2].includes('–ò–∑ ')) ? val : -val;
                }
            });
            data.rows.slice().reverse().slice(0, 8).forEach(r => {
                const isInc = r[1].includes('–î–æ—Ö–æ–¥') || r[1].includes('üíé') || r[2].includes('–ò–∑ ');
                hist.innerHTML += `<div class="bg-slate-900/40 p-3 rounded-xl flex justify-between items-center border border-slate-800">
                    <div><p class="text-slate-600 uppercase font-black tracking-tighter">${r[0].split('T')[0].substring(5)} | ${r[5]}</p><p class="text-slate-200">${r[2]}</p></div>
                    <div class="font-black ${isInc?'text-emerald-500':'text-rose-500'}">${isInc?'+':'-'}${Math.abs(isUah(r[5])?r[10]:r[8]).toFixed(2)}</div>
                </div>`;
            });
            for(let k in b) if(document.getElementById('acc-'+k)) document.getElementById('acc-'+k).innerText = (isUah(k)?'‚Ç¥ ':'‚Ç¨ ')+b[k].toFixed(2);
            const total = b["Sparkasse"] + b["–ù–∞–ª–∏—á–Ω—ã–µ EUR"] + (b["–ü—Ä–∏–≤–∞—Ç"] + b["–ù–∞–ª–∏—á–Ω—ã–µ UAH"]) / parseFloat(document.getElementById('rate').value);
            document.getElementById('mainBalance').innerText = '‚Ç¨ ' + total.toFixed(2);
        }
        window.onload = () => { const s = document.createElement('script'); s.src = `${API_URL}?callback=draw&t=${Date.now()}`; document.body.appendChild(s); };
    </script>
</body>
</html>
