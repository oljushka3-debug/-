<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartWallet v35.1 (Slim Limits)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        input, select { text-align: center; text-align-last: center; border-radius: 12px; outline: none; background: transparent; }
        button { transition: all 0.2s ease; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 p-3 pb-10 font-sans text-center hide-scroll">

<button onclick="location.reload()" class="fixed top-4 right-4 z-50 bg-white/80 backdrop-blur-md w-10 h-10 rounded-full border border-slate-200 flex items-center justify-center shadow-lg active:scale-90 transition-all">
    <i class="fa-solid fa-rotate text-blue-500 text-xs"></i>
</button>

<div class="bg-white p-4 rounded-[25px] border border-slate-200 mb-3 shadow-xl shadow-slate-200/50">
    <div class="flex justify-between items-center mb-2 text-[9px] font-bold opacity-60 uppercase tracking-tighter">
        <span>–ö—É—Ä—Å: <input type="number" id="baseRate" value="50.76" step="0.01" oninput="drawBalance()" class="w-12 text-blue-600 font-black border-none focus:ring-0"></span>
        <span>–Ø–ù–í–ê–†–¨ 2026</span>
    </div>
    <h1 id="mainBalance" class="text-3xl font-black italic mb-3 tracking-tighter text-slate-900 text-center">‚Ç¨ 0.00</h1>
    <div class="grid grid-cols-2 gap-2" id="walletContainer"></div>
</div>

<div id="limit-items" class="px-2 mb-4 space-y-1.5 text-left"></div>

<div class="flex gap-2 mb-4 font-black">
    <button onclick="openModal('expense')" class="flex-1 bg-rose-500 py-3 rounded-xl text-[10px] uppercase border-b-4 border-rose-700 shadow-md text-white active:translate-y-1 active:border-b-0">–†–∞—Å—Ö–æ–¥</button>
    <button onclick="openModal('transfer')" class="flex-1 bg-slate-700 py-3 rounded-xl text-[10px] uppercase border-b-4 border-slate-900 shadow-md text-white active:translate-y-1 active:border-b-0">–ü–µ—Ä–µ–≤–æ–¥</button>
    <button onclick="openModal('income')" class="flex-1 bg-emerald-500 py-3 rounded-xl text-[10px] uppercase border-b-4 border-emerald-700 shadow-md text-white active:translate-y-1 active:border-b-0">–î–æ—Ö–æ–¥</button>
</div>

<div id="history" class="space-y-2 text-left"></div>

<div id="modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50">
    <div class="bg-white w-full max-w-sm rounded-[35px] p-5 border border-slate-100 shadow-2xl overflow-y-auto max-h-[90vh]">
        <div class="flex gap-1 mb-4 bg-slate-100 p-1 rounded-xl font-bold">
            <button onclick="switchType('expense')" id="btnExp" class="flex-1 py-2 rounded-lg text-[8px] uppercase transition-all">–†–∞—Å—Ö–æ–¥</button>
            <button onclick="switchType('transfer')" id="btnTrf" class="flex-1 py-2 rounded-lg text-[8px] uppercase transition-all text-slate-400">–ü–µ—Ä–µ–≤–æ–¥</button>
            <button onclick="switchType('income')" id="btnInc" class="flex-1 py-2 rounded-lg text-[8px] uppercase transition-all text-slate-400">–î–æ—Ö–æ–¥</button>
        </div>
        <form onsubmit="save(event)" class="space-y-3 text-center">
            <input type="hidden" id="txType"><input type="hidden" id="editRowId">
            <input type="date" id="date" class="w-full bg-slate-50 p-3 text-slate-800 text-xs font-bold border border-slate-200 rounded-xl">
            <input id="merchant" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ / –ò—Å—Ç–æ—á–Ω–∏–∫" class="w-full bg-slate-50 p-3 text-slate-800 text-xs font-bold border border-slate-200 rounded-xl text-center">

            <div id="expenseFields" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-2 font-bold italic">
                    <input type="text" id="nameDE" placeholder="Name (DE)" class="bg-slate-50 p-3 border border-slate-200 text-center rounded-xl">
                    <input type="text" id="nameRU" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–†–£)" class="bg-slate-50 p-3 border border-slate-200 text-blue-600 text-center rounded-xl">
                </div>
                <div class="grid grid-cols-3 gap-2 bg-slate-50 p-2 border border-slate-200 rounded-xl text-[9px]">
                    <div><label class="text-[7px] text-slate-400 uppercase block">–ö–æ–ª-–≤–æ</label><input type="number" id="qty" value="1" step="0.01" class="w-full font-black text-center text-slate-800"></div>
                    <div class="border-l border-slate-200"><label class="text-[7px] text-orange-500 uppercase block">–¶–µ–Ω–∞ ‚Ç¨</label><input type="number" id="pEur" step="0.01" placeholder="0.00" class="w-full font-black text-center text-slate-800" oninput="syncFX(this, 'eur')"></div>
                    <div class="border-l border-slate-200"><label class="text-[7px] text-blue-500 uppercase block">–¶–µ–Ω–∞ ‚Ç¥</label><input type="number" id="pUah" step="0.01" placeholder="0.00" class="w-full font-black text-center text-slate-800" oninput="syncFX(this, 'uah')"></div>
                </div>
            </div>

            <div id="transferFields" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <select id="tFrom" class="bg-slate-50 p-3 text-slate-800 text-[10px] font-bold border border-slate-200 rounded-xl"><option value="Sparkasse">–ò–∑ Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ò–∑ –ü—Ä–∏–≤–∞—Ç</option><option value="–í–∞–ª–µ—Ä–∞">–ò–∑ –í–∞–ª–µ—Ä–∞</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ò–∑ –ù–∞–ª ‚Ç¨</option><option value="–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH">–ò–∑ –ö—Ä–µ–¥–∏—Ç–∫–∏ ‚Ç¥</option><option value="–ö–û–ü–ò–õ–ö–ê">–ò–∑ –ö–û–ü–ò–õ–ö–ò</option><option value="–ö–û–ù–í–ï–†–¢">–ò–∑ –ö–û–ù–í–ï–†–¢–ê</option><option value="–°–í–ò–ù–ö–ê">–ò–∑ –°–í–ò–ù–ö–ò</option></select>
                    <select id="tTo" class="bg-slate-50 p-3 text-orange-600 text-[10px] font-bold border border-slate-200 rounded-xl"><option value="–ö–û–ü–ò–õ–ö–ê">–í –ö–û–ü–ò–õ–ö–£</option><option value="–ö–û–ù–í–ï–†–¢">–í –ö–û–ù–í–ï–†–¢</option><option value="–°–í–ò–ù–ö–ê">–í –°–í–ò–ù–ö–£</option><option value="Sparkasse">–í Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–í –ü—Ä–∏–≤–∞—Ç</option><option value="–í–∞–ª–µ—Ä–∞">–í –í–∞–ª–µ—Ä–∞</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–í –ù–∞–ª ‚Ç¨</option><option value="–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH">–í –ö—Ä–µ–¥–∏—Ç–∫—É ‚Ç¥</option></select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-slate-50 p-2 rounded-xl border border-slate-200"><label class="text-[7px] text-orange-500 uppercase block">–°—É–º–º–∞ ‚Ç¨</label><input type="number" id="tEur" step="0.01" class="w-full font-black text-slate-800 text-center" oninput="syncFX(this, 'eur', true)"></div>
                    <div class="bg-slate-50 p-2 rounded-xl border border-slate-200"><label class="text-[7px] text-blue-500 uppercase block">–°—É–º–º–∞ ‚Ç¥</label><input type="number" id="tUah" step="0.01" class="w-full font-black text-slate-800 text-center" oninput="syncFX(this, 'uah', true)"></div>
                </div>
            </div>

            <div id="incomeFields" class="hidden space-y-3">
                <select id="accInc" class="w-full bg-slate-50 p-3 text-emerald-600 font-bold text-xs border border-slate-200 rounded-xl"><option value="Sparkasse">–ù–∞ Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ù–∞ –ü—Ä–∏–≤–∞—Ç</option><option value="–í–∞–ª–µ—Ä–∞">–ù–∞ –í–∞–ª–µ—Ä–∞</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞ –ù–∞–ª ‚Ç¨</option><option value="–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH">–ù–∞ –ö—Ä–µ–¥–∏—Ç–∫—É ‚Ç¥</option><option value="–ö–û–ü–ò–õ–ö–ê">–í –ö–û–ü–ò–õ–ö–£</option><option value="–ö–û–ù–í–ï–†–¢">–í –ö–û–ù–í–ï–†–¢</option><option value="–°–í–ò–ù–ö–ê">–í –°–í–ò–ù–ö–£</option></select>
                <input type="number" id="simplePrice" step="0.01" placeholder="–°—É–º–º–∞" class="w-full bg-slate-50 p-3 text-xl font-black text-slate-800 border border-slate-200 rounded-xl text-center">
            </div>

            <div id="accCatGroup" class="grid grid-cols-2 gap-2 text-center">
                <select id="acc" class="bg-slate-50 p-3 text-slate-800 text-[10px] font-bold border border-slate-200 rounded-xl"><option value="Sparkasse">Sparkasse</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞–ª ‚Ç¨</option><option value="–ö–û–ü–ò–õ–ö–ê">–ö–û–ü–ò–õ–ö–ê</option><option value="–ü—Ä–∏–≤–∞—Ç">–ü—Ä–∏–≤–∞—Ç</option><option value="–í–∞–ª–µ—Ä–∞">–í–∞–ª–µ—Ä–∞</option><option value="–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH">–ö—Ä–µ–¥–∏—Ç–∫–∞ ‚Ç¥</option><option value="–ö–û–ù–í–ï–†–¢">–ö–û–ù–í–ï–†–¢</option><option value="–°–í–ò–ù–ö–ê">–°–í–ò–ù–ö–ê</option></select>
                <select id="cat" class="bg-slate-50 p-3 text-slate-800 text-[10px] font-bold border border-slate-200 rounded-xl"><option value="üçé –ü—Ä–æ–¥—É–∫—Ç—ã / –ë—ã—Ç">üçé –ü—Ä–æ–¥—É–∫—Ç—ã / –ë—ã—Ç</option><option value="üè† –ñ–∏–ª—å–µ / –°—á–µ—Ç–∞ / –ú–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å">üè† –ñ–∏–ª—å–µ / –°—á–µ—Ç–∞</option><option value="üö¨ –¢–∞–±–∞–∫ / –ê–ª–∫–æ–≥–æ–ª—å / –û—Ç–¥—ã—Ö">üö¨ –¢–∞–±–∞–∫ / –û—Ç–¥—ã—Ö</option><option value="üíä –ó–¥–æ—Ä–æ–≤—å–µ / üíá‚Äç‚ôÄÔ∏è–∫—Ä–∞—Å–æ—Ç–∞">üíä –ó–¥–æ—Ä–æ–≤—å–µ / –ö—Ä–∞—Å–æ—Ç–∞</option><option value="üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option value="üè¶ –ë–∞–Ω–∫">üè¶ –ë–∞–Ω–∫</option><option value="üôá‚Äç‚ôÄÔ∏è –£—á–µ–±–∞">üôá‚Äç‚ôÄÔ∏è –£—á–µ–±–∞</option><option value="üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ">üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ</option><option value="üí∞ –ö–û–ü–ò–õ–ö–ê">üí∞ –ö–û–ü–ò–õ–ö–ê</option><option value="üèñÔ∏è –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">üèñÔ∏è –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option></select>
            </div>
            <div class="flex gap-2 pt-2"><button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold uppercase text-[9px] text-slate-500">–û—Ç–º–µ–Ω–∞</button><button id="saveBtn" class="flex-[2] bg-blue-600 text-white py-3 rounded-xl font-black uppercase text-xs shadow-lg shadow-blue-200">–ó–∞–ø–∏—Å–∞—Ç—å</button></div>
        </form>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz4-b-RtsW9Gy1-H7E27APtoNL1GwTNRyZAANSe0L52ds31BwF89uydrxrzLgyHaFL9/exec";
const MY_LIMITS = { "üçé –ü—Ä–æ–¥—É–∫—Ç—ã / –ë—ã—Ç": 345, "üè† –ñ–∏–ª—å–µ / –°—á–µ—Ç–∞ / –ú–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å": 50, "üö¨ –¢–∞–±–∞–∫ / –ê–ª–∫–æ–≥–æ–ª—å / –û—Ç–¥—ã—Ö": 64, "üíä –ó–¥–æ—Ä–æ–≤—å–µ / üíá‚Äç‚ôÄÔ∏è–∫—Ä–∞—Å–æ—Ç–∞": 70, "üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç": 70, "üè¶ –ë–∞–Ω–∫": 25, "üôá‚Äç‚ôÄÔ∏è –£—á–µ–±–∞": 70, "üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ": 10, "üí∞ –ö–û–ü–ò–õ–ö–ê": 250, "üèñÔ∏è –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è": 10 };
const INCLUDED_IN_TOTAL = ["Sparkasse", "–í–∞–ª–µ—Ä–∞", "–ù–∞–ª–∏—á–Ω—ã–µ EUR", "–ü—Ä–∏–≤–∞—Ç"];

let walletData = { "Sparkasse": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ö–û–ü–ò–õ–ö–ê": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–í–∞–ª–µ—Ä–∞": 0, "–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH": 0, "–ö–û–ù–í–ï–†–¢": 0, "–°–í–ò–ù–ö–ê": 0 };
let spentThisMonth = {};
let allData = [];

function isUah(acc) { return ["–ü—Ä–∏–≤–∞—Ç", "–í–∞–ª–µ—Ä–∞", "–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH", "–ö–û–ù–í–ï–†–¢", "–°–í–ò–ù–ö–ê"].includes(acc); }

function syncFX(el, type, isTransfer = false) {
    const rate = parseFloat(document.getElementById('baseRate').value) || 50.76;
    const targetId = isTransfer ? (type === 'eur' ? 'tUah' : 'tEur') : (type === 'eur' ? 'pUah' : 'pEur');
    if (type === 'eur') { document.getElementById(targetId).value = (el.value * rate).toFixed(2); } 
    else { document.getElementById(targetId).value = (el.value / rate).toFixed(2); }
}

function drawBalance() {
    const r = parseFloat(document.getElementById('baseRate').value) || 50.76;
    const container = document.getElementById('walletContainer'); container.innerHTML = "";
    let totalEur = 0;
    for(let k in walletData) {
        const val = walletData[k], isU = isUah(k), eurEq = isU ? val / r : val;
        if (INCLUDED_IN_TOTAL.includes(k)) { totalEur += eurEq; }
        container.innerHTML += `<div class="bg-white p-2 rounded-xl border border-slate-100 text-center shadow-sm"><div class="text-[7px] text-slate-400 uppercase font-black text-center">${k}</div><div class="text-[10px] font-black text-slate-800 text-center">${isU?'‚Ç¥':'‚Ç¨'} ${val.toFixed(2)}</div>${isU ? `<div class="text-[7px] text-slate-400 italic text-center">‚Ç¨ ${eurEq.toFixed(2)}</div>` : ''}</div>`;
    }
    document.getElementById('mainBalance').innerText = '‚Ç¨ ' + totalEur.toFixed(2);
    drawLimits();
}

function drawLimits() {
    const container = document.getElementById('limit-items'); container.innerHTML = "";
    for (let cat in MY_LIMITS) {
        const spent = Math.abs(spentThisMonth[cat] || 0), limit = MY_LIMITS[cat], percent = Math.min((spent / limit) * 100, 100);
        let color = percent > 75 ? (percent >= 100 ? "bg-rose-500" : "bg-amber-500") : "bg-emerald-500";
        // –£–ª—å—Ç—Ä–∞-—Ç–æ–Ω–∫–∞—è –≤–µ—Ä—Å—Ç–∫–∞ –ª–∏–º–∏—Ç–æ–≤
        container.innerHTML += `
            <div class="mb-1">
                <div class="flex justify-between text-[7px] font-bold uppercase tracking-tighter italic text-slate-500">
                    <span>${cat}</span>
                    <span>${spent.toFixed(0)} / ${limit}</span>
                </div>
                <div class="w-full bg-slate-200 h-[2px] mt-0.5 rounded-full overflow-hidden">
                    <div class="${color} h-full transition-all" style="width: ${percent}%"></div>
                </div>
            </div>`;
    }
}

function draw(data) {
    if (!data || !data.rows) return;
    allData = data.rows;
    walletData = { "Sparkasse": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ö–û–ü–ò–õ–ö–ê": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–í–∞–ª–µ—Ä–∞": 0, "–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH": 0, "–ö–û–ù–í–ï–†–¢": 0, "–°–í–ò–ù–ö–ê": 0 };
    spentThisMonth = {}; const now = new Date();
    allData.forEach(r => {
        const accF = r[5], desc = r[2], cat = r[1], dateRaw = r[0];
        const date = (dateRaw && !isNaN(Date.parse(dateRaw))) ? new Date(dateRaw) : null;
        const eurVal = parseFloat(r[8] || 0), uahVal = parseFloat(r[10] || 0);
        if (walletData.hasOwnProperty(accF)) walletData[accF] += (isUah(accF) ? uahVal : eurVal);
        if (desc && desc.includes("‚û°Ô∏è")) {
            const target = desc.replace("‚û°Ô∏è ", "").trim();
            if (walletData.hasOwnProperty(target) && isUah(accF) !== isUah(target)) {
                walletData[target] += (isUah(target) ? Math.abs(uahVal) : Math.abs(eurVal));
            }
        }
        if (date && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear() && eurVal < 0 && !cat.includes("–ü–µ—Ä–µ–≤–æ–¥") && !cat.includes("–î–æ—Ö–æ–¥")) {
            const lCat = MY_LIMITS.hasOwnProperty(cat) ? cat : "üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ";
            spentThisMonth[lCat] = (spentThisMonth[lCat] || 0) + eurVal;
        }
    });
    filterHistory(); drawBalance();
}

function filterHistory() {
    const hist = document.getElementById('history'); hist.innerHTML = "";
    allData.slice().reverse().slice(0, 30).forEach(r => {
        const acc = r[5], isU = isUah(acc), cat = r[1], valMain = isU ? parseFloat(r[10] || 0) : parseFloat(r[8] || 0);
        const isInc = valMain > 0; const rowId = r[r.length-1];
        let catIcon = cat.split(' ')[0]; if(cat === "üîÑ –ü–µ—Ä–µ–≤–æ–¥") catIcon = "üîÑ"; if(cat === "üíé –î–æ—Ö–æ–¥") catIcon = "üí∞";
        hist.innerHTML += `<div class="bg-white p-3 rounded-2xl border border-slate-100 mb-2 flex justify-between items-center text-left shadow-sm">
            <div class="flex items-center gap-3 truncate text-left">
                <div class="flex flex-col gap-1">
                    <button onclick="deleteRow(${rowId})" class="text-slate-300 hover:text-rose-500"><i class="fa-solid fa-trash-can text-[10px]"></i></button>
                    <button onclick="editEntry(${rowId})" class="text-slate-300 hover:text-blue-500"><i class="fa-solid fa-pencil text-[10px]"></i></button>
                </div>
                <div class="truncate text-left">
                    <div class="text-[7px] text-slate-400 font-bold uppercase italic">${String(r[0]).split('T')[0].substring(5)} ‚Ä¢ ${acc}</div>
                    <div class="text-[11px] font-bold text-slate-800 truncate leading-tight">${catIcon} ${r[2]}</div>
                </div>
            </div>
            <div class="text-right min-w-fit font-black text-[12px] ${isInc?'text-emerald-500':'text-rose-500'} italic">
                ${isInc?'+':''}${Math.abs(valMain).toFixed(2)}${isU?'‚Ç¥':'‚Ç¨'}
            </div>
        </div>`;
    });
}

function editEntry(id) {
    const row = allData.find(r => r[r.length-1] === id); if(!row) return;
    const cat = row[1]; let type = 'expense';
    if(cat.includes('–ü–µ—Ä–µ–≤–æ–¥')) type = 'transfer'; else if(cat.includes('–î–æ—Ö–æ–¥')) type = 'income';
    openModal(type);
    document.getElementById('editRowId').value = id;
    document.getElementById('saveBtn').innerText = "–û–±–Ω–æ–≤–∏—Ç—å";
    document.getElementById('date').value = String(row[0]).split('T')[0];
    document.getElementById('merchant').value = row[2].replace('üíé ', '').replace('‚û°Ô∏è ', '').replace('‚¨ÖÔ∏è ', '');
    if(type === 'expense') {
        document.getElementById('acc').value = row[5]; document.getElementById('cat').value = cat;
        document.getElementById('nameDE').value = row[3] || ""; document.getElementById('nameRU').value = row[4] || "";
        document.getElementById('qty').value = row[6] || 1; document.getElementById('pEur').value = Math.abs(parseFloat(row[8] || 0));
        syncFX(document.getElementById('pEur'), 'eur');
    } else if(type === 'income') {
        document.getElementById('accInc').value = row[5]; document.getElementById('simplePrice').value = Math.abs(isUah(row[5]) ? row[10] : row[8]);
    } else if(type === 'transfer') {
        document.getElementById('tFrom').value = row[5]; document.getElementById('tEur').value = Math.abs(parseFloat(row[8] || 0));
        syncFX(document.getElementById('tEur'), 'eur', true);
    }
}

async function save(e) {
    e.preventDefault(); const btn = document.getElementById('saveBtn'); btn.disabled = true; btn.innerText = "‚è≥";
    const type = document.getElementById('txType').value, rate = parseFloat(document.getElementById('baseRate').value), date = document.getElementById('date').value;
    const editId = document.getElementById('editRowId').value;
    const action = editId ? 'update' : 'add';
    let payload = { action: action, rowId: editId, date: date, rate: rate };

    if(type === 'transfer') {
        const f = document.getElementById('tFrom').value, t = document.getElementById('tTo').value;
        const sumE = parseFloat(document.getElementById('tEur').value) || 0, sumU = parseFloat(document.getElementById('tUah').value) || 0;
        if(isUah(f) !== isUah(t)) {
            Object.assign(payload, { category: "üîÑ –ü–µ—Ä–µ–≤–æ–¥", account: f, merchant: "‚û°Ô∏è " + t, totalCard: isUah(f)?-sumU:sumU, totalTran: isUah(f)?sumE:-sumE, curCard: "UAH" });
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        } else {
            const main = isUah(f) ? sumU : sumE;
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ ...payload, category: "üîÑ –ü–µ—Ä–µ–≤–æ–¥", account: f, merchant: "‚û°Ô∏è " + t, totalCard: isUah(f)?-main:"", totalTran: isUah(f)?0:-main, curCard: isUah(f)?"UAH":"" }) });
            if(!editId) await fetch(API_URL, { method: 'POST', body: JSON.stringify({ ...payload, category: "üîÑ –ü–µ—Ä–µ–≤–æ–¥", account: t, merchant: "‚¨ÖÔ∏è " + f, totalCard: isUah(t)?main:"", totalTran: isUah(t)?0:main, curCard: isUah(t)?"UAH":"" }) });
        }
    } else if(type === 'expense') {
        const q = parseFloat(document.getElementById('qty').value)||1, eU = parseFloat(document.getElementById('pEur').value)||0, uU = parseFloat(document.getElementById('pUah').value)||0;
        const acc = document.getElementById('acc').value;
        Object.assign(payload, { merchant: document.getElementById('merchant').value, category: document.getElementById('cat').value, account: acc, nameDE: document.getElementById('nameDE').value, nameRU: document.getElementById('nameRU').value, qty: q, priceUnit: eU, totalTran: -Math.abs(q*eU) });
        if(isUah(acc)){ payload.totalCard = -Math.abs(q*uU); payload.curCard = "UAH"; }
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
    } else if(type === 'income') {
        const pV = parseFloat(document.getElementById('simplePrice').value)||0, target = document.getElementById('accInc').value;
        Object.assign(payload, { merchant: "üíé " + document.getElementById('merchant').value, category: "üíé –î–æ—Ö–æ–¥", account: target });
        if(isUah(target)){ payload.totalCard = Math.abs(pV); payload.curCard = "UAH"; payload.totalTran = ""; } else payload.totalTran = Math.abs(pV);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
    }
    location.reload();
}

function openModal(type) { document.getElementById('modal').classList.remove('hidden'); document.getElementById('editRowId').value = ""; document.getElementById('saveBtn').innerText = "–ó–∞–ø–∏—Å–∞—Ç—å"; switchType(type); }
function closeModal() { document.getElementById('modal').classList.add('hidden'); }
function switchType(type) { 
    document.getElementById('txType').value = type; 
    document.getElementById('expenseFields').classList.toggle('hidden', type !== 'expense'); 
    document.getElementById('incomeFields').classList.toggle('hidden', type !== 'income'); 
    document.getElementById('transferFields').classList.toggle('hidden', type !== 'transfer'); 
    document.getElementById('accCatGroup').classList.toggle('hidden', type !== 'expense');
    const btns = {expense:'btnExp', transfer:'btnTrf', income:'btnInc'}, active = "bg-white text-blue-600 shadow-sm border border-slate-100", inactive = "bg-transparent text-slate-400";
    for(let k in btns) { document.getElementById(btns[k]).className = "flex-1 py-2 rounded-lg text-[8px] uppercase transition-all " + (k===type ? active : inactive); }
}
async function deleteRow(id) { if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return; await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'delete', rowId: id}) }); location.reload(); }
window.onload = () => { const s = document.createElement('script'); s.src = API_URL + "?callback=draw&_t=" + new Date().getTime(); document.body.appendChild(s); };
</script>
</body>
</html>
