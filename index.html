<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartWallet v31.4 (X-Precision)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        input, select { text-align: center; text-align-last: center; border-radius: 12px; outline: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 p-3 pb-10 font-sans text-center hide-scroll">

<button onclick="location.reload()" class="fixed top-4 right-4 z-50 bg-slate-800/90 w-10 h-10 rounded-full border border-slate-700 flex items-center justify-center shadow-xl active:scale-90 transition-all">
    <i class="fa-solid fa-rotate text-blue-400 text-xs"></i>
</button>

<div class="bg-gradient-to-br from-slate-900 to-slate-800 p-4 rounded-[25px] border border-slate-700/50 mb-3 shadow-2xl">
    <div class="flex justify-between items-center mb-2 text-[9px] font-bold opacity-50 uppercase tracking-tighter">
        <span>–ö—É—Ä—Å: <input type="number" id="baseRate" value="50.76" step="0.01" oninput="drawBalance()" class="w-12 bg-transparent text-yellow-500 font-black border-none"></span>
        <span>–Ø–ù–í–ê–†–¨ 2026</span>
    </div>
    <h1 id="mainBalance" class="text-3xl font-black italic mb-3 tracking-tighter text-white">‚Ç¨ 0.00</h1>
    <div class="grid grid-cols-2 gap-2" id="walletContainer"></div>
</div>

<div id="limit-items" class="bg-slate-900/60 p-4 rounded-[25px] border border-slate-800 mb-4 space-y-3 text-left"></div>

<div class="flex gap-2 mb-4 font-black">
    <button onclick="openModal('expense')" class="flex-1 bg-rose-600 py-3 rounded-xl text-[10px] uppercase border-b-4 border-rose-900 shadow-lg text-white">–†–∞—Å—Ö–æ–¥</button>
    <button onclick="openModal('transfer')" class="flex-1 bg-slate-700 py-3 rounded-xl text-[10px] uppercase border-b-4 border-slate-900 shadow-lg text-white">–ü–µ—Ä–µ–≤–æ–¥</button>
    <button onclick="openModal('income')" class="flex-1 bg-emerald-600 py-3 rounded-xl text-[10px] uppercase border-b-4 border-emerald-900 shadow-lg text-white">–î–æ—Ö–æ–¥</button>
</div>

<div id="history" class="space-y-2 text-left"></div>

<div id="modal" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center p-4 z-50">
    <div class="bg-slate-900 w-full max-w-sm rounded-[35px] p-5 border border-slate-800 shadow-2xl overflow-y-auto max-h-[90vh]">
        <div class="flex gap-1 mb-4 bg-slate-800 p-1 rounded-xl font-bold">
            <button onclick="switchType('expense')" id="btnExp" class="flex-1 py-2 rounded-lg text-[8px] uppercase transition-all">–†–∞—Å—Ö–æ–¥</button>
            <button onclick="switchType('transfer')" id="btnTrf" class="flex-1 py-2 rounded-lg text-[8px] uppercase transition-all text-slate-500">–ü–µ—Ä–µ–≤–æ–¥</button>
            <button onclick="switchType('income')" id="btnInc" class="flex-1 py-2 rounded-lg text-[8px] uppercase transition-all text-slate-500">–î–æ—Ö–æ–¥</button>
        </div>
        <form onsubmit="save(event)" class="space-y-3 text-center">
            <input type="hidden" id="txType">
            <input type="date" id="date" class="w-full bg-slate-800 p-3 text-white text-xs font-bold border border-slate-700">
            <input id="merchant" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ / –ò—Å—Ç–æ—á–Ω–∏–∫" class="w-full bg-slate-800 p-3 text-white text-xs font-bold border border-slate-700 text-center text-white">

            <div id="expenseFields" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-2 text-white text-xs font-bold italic">
                    <input type="text" id="nameDE" placeholder="Name (DE)" class="bg-slate-800 p-3 border border-slate-700">
                    <input type="text" id="nameRU" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–†–£)" class="bg-slate-800 p-3 border border-slate-700 text-blue-300">
                </div>
                <div class="grid grid-cols-3 gap-2 bg-slate-800/50 p-2 border border-slate-700 text-white text-[9px]">
                    <div><label class="text-[7px] text-slate-500 uppercase block">–ö–æ–ª-–≤–æ</label><input type="number" id="qty" value="1" step="0.01" class="w-full bg-transparent font-black text-center text-white"></div>
                    <div class="border-l border-slate-700"><label class="text-[7px] text-yellow-500 uppercase block">–¶–µ–Ω–∞ ‚Ç¨</label><input type="number" id="pEur" step="0.01" placeholder="0.00" class="w-full bg-transparent font-black text-center text-white" oninput="syncFX(this, 'eur')"></div>
                    <div class="border-l border-slate-700"><label class="text-[7px] text-blue-400 uppercase block">–¶–µ–Ω–∞ ‚Ç¥</label><input type="number" id="pUah" step="0.01" placeholder="0.00" class="w-full bg-transparent font-black text-center text-white" oninput="syncFX(this, 'uah')"></div>
                </div>
            </div>

            <div id="transferFields" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <select id="tFrom" class="bg-slate-800 p-3 text-white text-[10px] font-bold border border-slate-700"><option value="Sparkasse">–ò–∑ Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ò–∑ –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ò–∑ –ù–∞–ª ‚Ç¨</option><option value="–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH">–ò–∑ –ö—Ä–µ–¥–∏—Ç–∫–∏ ‚Ç¥</option><option value="–ö–û–ü–ò–õ–ö–ê">–ò–∑ –ö–û–ü–ò–õ–ö–ò</option><option value="–ö–û–ù–í–ï–†–¢">–ò–∑ –ö–û–ù–í–ï–†–¢–ê</option><option value="–°–í–ò–ù–ö–ê">–ò–∑ –°–í–ò–ù–ö–ò</option></select>
                    <select id="tTo" class="bg-slate-800 p-3 text-yellow-500 text-[10px] font-bold border border-slate-700"><option value="–ö–û–ü–ò–õ–ö–ê">–í –ö–û–ü–ò–õ–ö–£</option><option value="–ö–û–ù–í–ï–†–¢">–í –ö–û–ù–í–ï–†–¢</option><option value="–°–í–ò–ù–ö–ê">–í –°–í–ò–ù–ö–£</option><option value="Sparkasse">–í Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–í –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–í –ù–∞–ª ‚Ç¨</option><option value="–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH">–í –ö—Ä–µ–¥–∏—Ç–∫—É ‚Ç¥</option></select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-slate-800 p-2 rounded-xl border border-slate-700">
                        <label class="text-[7px] text-yellow-500 uppercase block">–°—É–º–º–∞ ‚Ç¨</label>
                        <input type="number" id="tEur" step="0.01" class="w-full bg-transparent font-black text-white text-center" oninput="syncFX(this, 'eur', true)">
                    </div>
                    <div class="bg-slate-800 p-2 rounded-xl border border-slate-700">
                        <label class="text-[7px] text-blue-400 uppercase block">–°—É–º–º–∞ ‚Ç¥</label>
                        <input type="number" id="tUah" step="0.01" class="w-full bg-transparent font-black text-white text-center" oninput="syncFX(this, 'uah', true)">
                    </div>
                </div>
            </div>

            <div id="incomeFields" class="hidden space-y-3">
                <select id="accInc" class="w-full bg-slate-800 p-3 text-emerald-400 font-bold text-xs border border-slate-700"><option value="Sparkasse">–ù–∞ Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ù–∞ –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞ –ù–∞–ª ‚Ç¨</option><option value="–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH">–ù–∞ –ö—Ä–µ–¥–∏—Ç–∫—É ‚Ç¥</option><option value="–ö–û–ü–ò–õ–ö–ê">–í –ö–û–ü–ò–õ–ö–£</option><option value="–ö–û–ù–í–ï–†–¢">–í –ö–û–ù–í–ï–†–¢</option><option value="–°–í–ò–ù–ö–ê">–í –°–í–ò–ù–ö–£</option></select>
                <input type="number" id="simplePrice" step="0.01" placeholder="–°—É–º–º–∞" class="w-full bg-slate-800 p-3 text-xl font-black text-white border border-slate-700 text-center">
            </div>

            <div id="accCatGroup" class="grid grid-cols-2 gap-2 text-center">
                <select id="acc" class="bg-slate-800 p-3 text-white text-[10px] font-bold border border-slate-700"><option value="Sparkasse">Sparkasse</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞–ª ‚Ç¨</option><option value="–ö–û–ü–ò–õ–ö–ê">–ö–û–ü–ò–õ–ö–ê</option><option value="–ü—Ä–∏–≤–∞—Ç">–ü—Ä–∏–≤–∞—Ç</option><option value="–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH">–ö—Ä–µ–¥–∏—Ç–∫–∞ ‚Ç¥</option><option value="–ö–û–ù–í–ï–†–¢">–ö–û–ù–í–ï–†–¢</option><option value="–°–í–ò–ù–ö–ê">–°–í–ò–ù–ö–ê</option></select>
                <select id="cat" class="bg-slate-800 p-3 text-white text-[10px] font-bold border border-slate-700">
                    <option value="üçé –ü—Ä–æ–¥—É–∫—Ç—ã / –ë—ã—Ç">üçé –ü—Ä–æ–¥—É–∫—Ç—ã (–ï–¥–∞, —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç, —Ö–∏–º–∏—è)</option>
                    <option value="üè† –ñ–∏–ª—å–µ / –°—á–µ—Ç–∞ / –ú–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å">üè† –ñ–∏–ª—å–µ (–°—á–µ—Ç–∞, —Å–≤—è–∑—å, –ø–æ–¥–ø–∏—Å–∫–∏)</option>
                    <option value="üö¨ –¢–∞–±–∞–∫ / –ê–ª–∫–æ–≥–æ–ª—å / –û—Ç–¥—ã—Ö">üö¨ –¢–∞–±–∞–∫/–û—Ç–¥—ã—Ö (–°–∏–≥–∞—Ä–µ—Ç—ã, –∞–ª–∫–æ–≥–æ–ª—å, –∫–æ—Ñ–µ)</option>
                    <option value="üíä –ó–¥–æ—Ä–æ–≤—å–µ / üíá‚Äç‚ôÄÔ∏è–∫—Ä–∞—Å–æ—Ç–∞">üíä –ó–¥–æ—Ä–æ–≤—å–µ (–ê–ø—Ç–µ–∫–∞, –≤—Ä–∞—á, –∫—Ä–∞—Å–æ—Ç–∞)</option>
                    <option value="üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (–ë–∏–ª–µ—Ç—ã, –±–µ–Ω–∑–∏–Ω, –∞–≤—Ç–æ)</option>
                    <option value="üè¶ –ë–∞–Ω–∫">üè¶ –ë–∞–Ω–∫ (–ö–æ–Ω–≤–µ—Ä—Ç, –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ)</option>
                    <option value="üôá‚Äç‚ôÄÔ∏è –£—á–µ–±–∞">üôá‚Äç‚ôÄÔ∏è –£—á–µ–±–∞ (–ö–∞–Ω—Ü–µ–ª—è—Ä–∏—è, –£—Ä–æ–∫–∏, –ö–Ω–∏–≥–∏)</option>
                    <option value="üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ">üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ (–û–¥–µ–∂–¥–∞, –ø–æ–¥–∞—Ä–∫–∏)</option>
                    <option value="üí∞ –ö–û–ü–ò–õ–ö–ê">üí∞ –ö–û–ü–ò–õ–ö–ê (–ß–∏—Å—Ç—ã–π –∫–∞–ø–∏—Ç–∞–ª)</option>
                    <option value="üèñÔ∏è –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">üèñÔ∏è –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è (–û—Ç–ø—É—Å–∫, –æ—Ç–µ–ª–∏)</option>
                </select>
            </div>
            <div class="flex gap-2 pt-2"><button type="button" onclick="closeModal()" class="flex-1 bg-slate-800 py-3 rounded-xl font-bold uppercase text-[9px] text-white">–û—Ç–º–µ–Ω–∞</button><button id="saveBtn" class="flex-[2] bg-yellow-500 text-black py-3 rounded-xl font-black uppercase text-xs">–ó–∞–ø–∏—Å–∞—Ç—å</button></div>
        </form>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz4-b-RtsW9Gy1-H7E27APtoNL1GwTNRyZAANSe0L52ds31BwF89uydrxrzLgyHaFL9/exec";
const MY_LIMITS = { "üçé –ü—Ä–æ–¥—É–∫—Ç—ã / –ë—ã—Ç": 345, "üè† –ñ–∏–ª—å–µ / –°—á–µ—Ç–∞ / –ú–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å": 50, "üö¨ –¢–∞–±–∞–∫ / –ê–ª–∫–æ–≥–æ–ª—å / –û—Ç–¥—ã—Ö": 64, "üíä –ó–¥–æ—Ä–æ–≤—å–µ / üíá‚Äç‚ôÄÔ∏è–∫—Ä–∞—Å–æ—Ç–∞": 70, "üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç": 70, "üè¶ –ë–∞–Ω–∫": 25, "üôá‚Äç‚ôÄÔ∏è –£—á–µ–±–∞": 70, "üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ": 10, "üí∞ –ö–û–ü–ò–õ–ö–ê": 250, "üèñÔ∏è –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è": 10 };
let walletData = { "Sparkasse": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ö–û–ü–ò–õ–ö–ê": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH": 0, "–ö–û–ù–í–ï–†–¢": 0, "–°–í–ò–ù–ö–ê": 0 };
let spentThisMonth = {};
let allData = [];

function isUah(acc) { return ["–ü—Ä–∏–≤–∞—Ç", "–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH", "–ö–û–ù–í–ï–†–¢", "–°–í–ò–ù–ö–ê"].includes(acc); }

function syncFX(el, type, isTransfer = false) {
    const rate = parseFloat(document.getElementById('baseRate').value) || 50.76;
    const targetId = isTransfer ? (type === 'eur' ? 'tUah' : 'tEur') : (type === 'eur' ? 'pUah' : 'pEur');
    if (type === 'eur') {
        document.getElementById(targetId).value = (el.value * rate).toFixed(2);
    } else {
        document.getElementById(targetId).value = (el.value / rate).toFixed(2);
    }
}

function drawBalance() {
    const r = parseFloat(document.getElementById('baseRate').value) || 50.76;
    const container = document.getElementById('walletContainer'); container.innerHTML = "";
    let totalEur = 0;
    for(let k in walletData) {
        const val = walletData[k], isU = isUah(k), eurEq = isU ? val / r : val;
        totalEur += eurEq;
        container.innerHTML += `<div class="bg-slate-800/40 p-2 rounded-xl border border-slate-700/30 text-center"><div class="text-[7px] text-slate-500 uppercase font-black text-center">${k}</div><div class="text-[10px] font-black text-white text-center">${isU?'‚Ç¥':'‚Ç¨'} ${val.toFixed(2)}</div>${isU ? `<div class="text-[7px] text-slate-600 italic text-center">‚Ç¨ ${eurEq.toFixed(2)}</div>` : ''}</div>`;
    }
    document.getElementById('mainBalance').innerText = '‚Ç¨ ' + totalEur.toFixed(2);
    drawLimits();
}

function drawLimits() {
    const container = document.getElementById('limit-items'); container.innerHTML = "";
    for (let cat in MY_LIMITS) {
        const spent = Math.abs(spentThisMonth[cat] || 0), limit = MY_LIMITS[cat], percent = Math.min((spent / limit) * 100, 100);
        let color = percent > 75 ? (percent >= 100 ? "bg-rose-500" : "bg-yellow-500") : "bg-emerald-500";
        container.innerHTML += `<div><div class="flex justify-between text-[8px] font-bold mb-1 uppercase tracking-tighter italic text-left"><span>${cat}</span><span class="text-slate-500">${spent.toFixed(0)} / ${limit} ‚Ç¨</span></div><div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden border border-slate-700/30"><div class="${color} h-full transition-all" style="width: ${percent}%"></div></div></div>`;
    }
}

function draw(data) {
    if (!data || !data.rows) return;
    allData = data.rows;
    walletData = { "Sparkasse": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ö–û–ü–ò–õ–ö–ê": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ö—Ä–µ–¥–∏—Ç–∫–∞ UAH": 0, "–ö–û–ù–í–ï–†–¢": 0, "–°–í–ò–ù–ö–ê": 0 };
    spentThisMonth = {}; const now = new Date();
    allData.forEach(r => {
        const accF = r[5], desc = r[2], cat = r[1], dateRaw = r[0];
        const date = (dateRaw && !isNaN(Date.parse(dateRaw))) ? new Date(dateRaw) : null;
        const eurVal = parseFloat(r[8] || 0), uahVal = parseFloat(r[10] || 0);
        if (walletData.hasOwnProperty(accF)) walletData[accF] += (isUah(accF) ? uahVal : eurVal);
        if (desc && desc.includes("‚û°Ô∏è")) {
            const target = desc.replace("‚û°Ô∏è ", "").trim();
            if (walletData.hasOwnProperty(target) && isUah(accF) !== isUah(target)) {
                walletData[target] += (isUah(target) ? Math.abs(uahVal) : Math.abs(eurVal));
            }
        }
        if (date && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear() && eurVal < 0 && !cat.includes("–ü–µ—Ä–µ–≤–æ–¥") && !cat.includes("–î–æ—Ö–æ–¥")) {
            const lCat = MY_LIMITS.hasOwnProperty(cat) ? cat : "üõç –û—Å—Ç–∞–ª—å–Ω–æ–µ";
            spentThisMonth[lCat] = (spentThisMonth[lCat] || 0) + eurVal;
        }
    });
    filterHistory(); drawBalance();
}

function filterHistory() {
    const hist = document.getElementById('history'); hist.innerHTML = "";
    allData.slice().reverse().slice(0, 30).forEach(r => {
        const acc = r[5], isU = isUah(acc), cat = r[1], valMain = isU ? parseFloat(r[10] || 0) : parseFloat(r[8] || 0);
        const isInc = valMain > 0; const rowId = r[r.length-1];
        let catIcon = cat.split(' ')[0]; if(cat === "üîÑ –ü–µ—Ä–µ–≤–æ–¥") catIcon = "üîÑ"; if(cat === "üíé –î–æ—Ö–æ–¥") catIcon = "üí∞";
        hist.innerHTML += `<div class="bg-slate-900/40 p-2.5 rounded-xl border border-slate-800 mb-2 flex justify-between items-center text-left shadow-sm"><div class="flex items-center gap-2 truncate text-left text-white"><button onclick="deleteRow(${rowId})" class="text-slate-700 hover:text-rose-500"><i class="fa-solid fa-trash-can text-[9px]"></i></button><div class="truncate text-left text-white"><div class="text-[7px] text-slate-600 font-bold uppercase italic text-left">${String(r[0]).split('T')[0].substring(5)} ‚Ä¢ ${acc}</div><div class="text-[10px] font-bold text-white truncate leading-tight text-white">${catIcon} ${r[2]}</div></div></div><div class="text-right min-w-fit font-black text-[11px] ${isInc?'text-emerald-500':'text-rose-500'} italic">${isInc?'+':''}${Math.abs(valMain).toFixed(2)}${isU?'‚Ç¥':'‚Ç¨'}</div></div>`;
    });
}

async function save(e) {
    e.preventDefault(); const btn = document.getElementById('saveBtn'); btn.disabled = true; btn.innerText = "‚è≥";
    const type = document.getElementById('txType').value, rate = parseFloat(document.getElementById('baseRate').value), date = document.getElementById('date').value;

    if(type === 'transfer') {
        const f = document.getElementById('tFrom').value, t = document.getElementById('tTo').value;
        const sumE = parseFloat(document.getElementById('tEur').value) || 0, sumU = parseFloat(document.getElementById('tUah').value) || 0;
        if(isUah(f) !== isUah(t)) {
            let p = { action: 'add', date: date, rate: rate, category: "üîÑ –ü–µ—Ä–µ–≤–æ–¥", account: f, merchant: "‚û°Ô∏è " + t };
            if(isUah(f)) { p.totalCard = -sumU; p.totalTran = sumE; p.curCard = "UAH"; } 
            else { p.totalTran = -sumE; p.totalCard = sumU; p.curCard = "UAH"; }
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(p) });
        } else {
            const val = isUah(f) ? sumU : sumE;
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', date: date, rate: rate, category: "üîÑ –ü–µ—Ä–µ–≤–æ–¥", account: f, merchant: "‚û°Ô∏è " + t, totalCard: isUah(f)?-val:"", totalTran: isUah(f)?0:-val, curCard: isUah(f)?"UAH":"" }) });
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', date: date, rate: rate, category: "üîÑ –ü–µ—Ä–µ–≤–æ–¥", account: t, merchant: "‚¨ÖÔ∏è " + f, totalCard: isUah(t)?val:"", totalTran: isUah(t)?0:val, curCard: isUah(t)?"UAH":"" }) });
        }
    } else if(type === 'expense') {
        const q = parseFloat(document.getElementById('qty').value)||1, eUnit = parseFloat(document.getElementById('pEur').value)||0, uUnit = parseFloat(document.getElementById('pUah').value)||0;
        const acc = document.getElementById('acc').value;
        let p = { action: 'add', date: date, rate: rate, merchant: document.getElementById('merchant').value, category: document.getElementById('cat').value, account: acc, nameDE: document.getElementById('nameDE').value, nameRU: document.getElementById('nameRU').value, qty: q, priceUnit: eUnit, totalTran: -Math.abs(q*eUnit) };
        if(isUah(acc)){ p.totalCard = -Math.abs(q*uUnit); p.curCard = "UAH"; }
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(p) });
    } else if(type === 'income') {
        const pV = parseFloat(document.getElementById('simplePrice').value)||0, target = document.getElementById('accInc').value;
        let p = { action: 'add', date: date, rate: rate, merchant: "üíé " + document.getElementById('merchant').value, category: "üíé –î–æ—Ö–æ–¥", account: target };
        if(isUah(target)){ p.totalCard = Math.abs(pV); p.curCard = "UAH"; p.totalTran = ""; } else p.totalTran = Math.abs(pV);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(p) });
    }
    location.reload();
}

function openModal(type) { document.getElementById('modal').classList.remove('hidden'); switchType(type); }
function closeModal() { document.getElementById('modal').classList.add('hidden'); }
function switchType(type) {
    document.getElementById('txType').value = type;
    document.getElementById('expenseFields').classList.toggle('hidden', type !== 'expense');
    document.getElementById('incomeFields').classList.toggle('hidden', type !== 'income');
    document.getElementById('transferFields').classList.toggle('hidden', type !== 'transfer');
    document.getElementById('accCatGroup').classList.toggle('hidden', type !== 'expense');
}
async function deleteRow(id) { if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return; await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'delete', rowId: id}) }); location.reload(); }
window.onload = () => { const s = document.createElement('script'); s.src = API_URL + "?callback=draw&_t=" + new Date().getTime(); document.body.appendChild(s); };
</script>
</body>
</html>
