<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartWallet Pro v7.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-950 text-slate-100 font-sans p-4 pb-10">

    <div class="bg-gradient-to-br from-slate-900 to-slate-800 p-6 rounded-[35px] shadow-2xl mb-6 border border-slate-700/50 relative overflow-hidden">
        <div class="flex justify-between items-center mb-6">
            <span class="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em]">Total Assets</span>
            <div class="bg-slate-800 px-3 py-1 rounded-full border border-yellow-500/20">
                <span class="text-[10px] text-yellow-500 font-bold">‚Ç¨/‚Ç¥</span>
                <input type="number" id="rate" value="50.76" step="0.01" oninput="calc()" class="w-12 bg-transparent outline-none font-bold text-yellow-400 text-xs text-center">
            </div>
        </div>
        <div class="text-center mb-8">
            <h1 id="mainBalance" class="text-5xl font-black text-white tracking-tighter italic">‚Ç¨ 0.00</h1>
            <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mt-1">Global Balance</p>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div class="bg-slate-800/40 p-3 rounded-2xl border border-blue-500/10">
                <p class="text-[8px] text-blue-400 uppercase font-black mb-1">Sparkasse</p>
                <p id="acc-Sparkasse" class="text-sm font-bold tracking-tight">‚Ç¨ 0.00</p>
            </div>
            <div class="bg-slate-800/40 p-3 rounded-2xl border border-green-500/10">
                <p class="text-[8px] text-green-500 uppercase font-black mb-1">–ü—Ä–∏–≤–∞—Ç–ë–∞–Ω–∫</p>
                <p id="acc-–ü—Ä–∏–≤–∞—Ç" class="text-sm font-bold tracking-tight">‚Ç¥ 0.00</p>
            </div>
            <div class="bg-slate-800/40 p-3 rounded-2xl border border-yellow-500/10">
                <p class="text-[8px] text-yellow-500 uppercase font-black mb-1">–ù–∞–ª–∏—á–Ω—ã–µ ‚Ç¨</p>
                <p id="acc-–ù–∞–ª–∏—á–Ω—ã–µ EUR" class="text-sm font-bold tracking-tight">‚Ç¨ 0.00</p>
            </div>
            <div class="bg-slate-800/40 p-3 rounded-2xl border border-orange-500/10">
                <p class="text-[8px] text-orange-500 uppercase font-black mb-1">–ù–∞–ª–∏—á–Ω—ã–µ ‚Ç¥</p>
                <p id="acc-–ù–∞–ª–∏—á–Ω—ã–µ UAH" class="text-sm font-bold tracking-tight">‚Ç¥ 0.00</p>
            </div>
        </div>
    </div>

    <div class="flex gap-2 mb-8">
        <button onclick="openModal('expense')" class="flex-1 bg-rose-600/90 py-4 rounded-2xl font-black text-[10px] shadow-lg active:scale-95 transition-all uppercase border-b-4 border-rose-900">
            <i class="fas fa-minus mr-1"></i>–†–∞—Å—Ö–æ–¥
        </button>
        <button onclick="openModal('transfer')" class="flex-1 bg-slate-700 py-4 rounded-2xl font-black text-[10px] shadow-lg active:scale-95 transition-all uppercase border-b-4 border-slate-900">
            <i class="fas fa-exchange-alt mr-1"></i>–ü–µ—Ä–µ–≤–æ–¥
        </button>
        <button onclick="openModal('income')" class="flex-1 bg-emerald-600/90 py-4 rounded-2xl font-black text-[10px] shadow-lg active:scale-95 transition-all uppercase border-b-4 border-emerald-900">
            <i class="fas fa-plus mr-1"></i>–î–æ—Ö–æ–¥
        </button>
    </div>

    <div id="history" class="space-y-3"></div>

    <div id="modal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-md hidden flex items-center justify-center p-4 z-50 text-slate-200">
        <div class="bg-slate-900 w-full max-w-sm rounded-[45px] p-8 border border-slate-800 shadow-2xl relative">
            <button onclick="closeModal()" class="absolute top-8 right-8 text-slate-600 text-2xl"><i class="fas fa-times"></i></button>
            <h2 id="modalTitle" class="text-2xl font-black mb-8 italic text-yellow-500 tracking-tighter uppercase">–ó–∞–ø–∏—Å—å</h2>
            
            <form onsubmit="save(event)" class="space-y-4">
                <input type="hidden" id="txType">
                <input type="date" id="date" class="w-full bg-slate-800 border border-slate-700 rounded-2xl p-4 font-bold outline-none text-sm">
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-800 p-4 rounded-3xl border border-slate-700">
                        <label class="text-[9px] text-slate-500 block uppercase font-black mb-1">–ö–æ–ª-–≤–æ</label>
                        <input type="number" id="qty" value="1" oninput="calc()" class="w-full bg-transparent text-xl font-black outline-none">
                    </div>
                    <div class="bg-slate-800 p-4 rounded-3xl border border-slate-700">
                        <label class="text-[9px] text-blue-400 block uppercase font-black mb-1 italic text-center">–¶–µ–Ω–∞ ‚Ç¨/‚Ç¥</label>
                        <input type="number" id="price" step="0.01" oninput="calc()" class="w-full bg-transparent text-xl font-black text-center outline-none">
                    </div>
                </div>

                <div id="infoBox" class="bg-yellow-500/10 border border-yellow-500/20 p-4 rounded-3xl text-center hidden">
                    <p id="uahResult" class="text-2xl font-black text-yellow-500 tracking-tighter">0.00 ‚Ç¥</p>
                </div>

                <input type="text" id="merchant" placeholder="–ú–∞–≥–∞–∑–∏–Ω / –ö—É–¥–∞ / –û—Ç–∫—É–¥–∞" class="w-full bg-slate-800 border border-slate-700 rounded-2xl p-4 outline-none font-bold">
                
                <div id="itemBlock" class="grid grid-cols-2 gap-2">
                    <input type="text" id="itemDE" placeholder="–¢–æ–≤–∞—Ä DE" class="bg-slate-800 border border-slate-700 rounded-2xl p-4 text-xs outline-none">
                    <input type="text" id="itemRU" placeholder="–¢–æ–≤–∞—Ä RU" class="bg-slate-800 border border-slate-700 rounded-2xl p-4 text-xs outline-none">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <select id="acc" onchange="calc()" class="bg-slate-800 border border-slate-700 rounded-2xl p-4 font-bold text-[10px] outline-none">
                        <option value="Sparkasse">Sparkasse</option>
                        <option value="–ü—Ä–∏–≤–∞—Ç">–ü—Ä–∏–≤–∞—Ç</option>
                        <option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞–ª–∏—á–Ω—ã–µ ‚Ç¨</option>
                        <option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ù–∞–ª–∏—á–Ω—ã–µ ‚Ç¥</option>
                    </select>
                    <select id="cat" class="bg-slate-800 border border-slate-700 rounded-2xl p-4 font-bold text-[10px] outline-none">
                        <option>üçé –ü—Ä–æ–¥—É–∫—Ç—ã</option><option>üè† –î–æ–º</option><option>üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option>üç∑ –ê–ª–∫–æ–≥–æ–ª—å</option><option>üì¶ –ü—Ä–æ—á–µ–µ</option><option>üîÑ –ü–µ—Ä–µ–≤–æ–¥</option>
                    </select>
                </div>

                <button id="saveBtn" type="submit" class="w-full bg-yellow-500 text-slate-950 py-5 rounded-[28px] font-black text-xl shadow-lg active:scale-95 transition-all uppercase tracking-widest border-b-4 border-yellow-700">
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                </button>
            </form>
        </div>
    </div>

    <script>
        // –¢–í–û–Ø –°–°–´–õ–ö–ê EXEC
        const API_URL = "https://script.google.com/macros/s/AKfycbxEnssB37LRmWIaitZc0kLb1l0vMuiQQReskfE0bSurqTdt1HiuaDKT9WXirfPjlqrp/exec";

        function calc() {
            const q = parseFloat(document.getElementById('qty').value) || 0;
            const p = parseFloat(document.getElementById('price').value) || 0;
            const r = parseFloat(document.getElementById('rate').value) || 50.76;
            const acc = document.getElementById('acc').value;
            const uah = (q * p * r).toFixed(2);
            const box = document.getElementById('infoBox');
            if (acc.includes('–ü—Ä–∏–≤–∞—Ç') || acc.includes('UAH')) {
                box.classList.remove('hidden');
                document.getElementById('uahResult').innerText = uah + ' ‚Ç¥';
            } else { box.classList.add('hidden'); }
        }

        function openModal(type) {
            document.getElementById('txType').value = type;
            document.getElementById('modalTitle').innerText = type === 'expense' ? '–†–∞—Å—Ö–æ–¥' : (type === 'transfer' ? '–ü–µ—Ä–µ–≤–æ–¥' : '–î–æ—Ö–æ–¥');
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            if(type === 'transfer') {
                document.getElementById('itemBlock').classList.add('hidden');
                document.getElementById('cat').value = 'üîÑ –ü–µ—Ä–µ–≤–æ–¥';
            } else {
                document.getElementById('itemBlock').classList.remove('hidden');
            }
            calc();
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function save(e) {
            e.preventDefault();
            const btn = document.getElementById('saveBtn');
            const q = parseFloat(document.getElementById('qty').value) || 1;
            const p = parseFloat(document.getElementById('price').value) || 0;
            const rate = parseFloat(document.getElementById('rate').value) || 50.76;
            const acc = document.getElementById('acc').value;
            const type = document.getElementById('txType').value;
            const uah = (q * p * rate).toFixed(2);

            const payload = {
                action: 'add',
                date: document.getElementById('date').value,
                category: document.getElementById('cat').value,
                merchant: document.getElementById('merchant').value || '‚Äî',
                itemDE: document.getElementById('itemDE').value || '‚Äî',
                itemRU: document.getElementById('itemRU').value || '‚Äî',
                account: acc,
                qty: q,
                priceUnit: p,
                totalTran: (q * p).toFixed(2),
                curTran: (acc.includes('UAH') || acc.includes('–ü—Ä–∏–≤–∞—Ç')) ? "UAH" : "EUR",
                totalCard: (acc.includes('–ü—Ä–∏–≤–∞—Ç') || acc.includes('UAH')) ? (type==='expense'?'-'+uah:uah) : (type==='expense'?'-'+(q*p):(q*p)),
                curCard: (acc.includes('–ü—Ä–∏–≤–∞—Ç') || acc.includes('UAH')) ? "UAH" : "EUR",
                rate: rate
            };

            btn.innerText = "‚è≥ –ó–ê–ü–ò–°–¨...";
            btn.disabled = true;
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            location.reload();
        }

        async function load() {
            const script = document.createElement('script');
            script.src = `${API_URL}?callback=draw&t=${Date.now()}`;
            document.body.appendChild(script);
        }

        function draw(data) {
            const hist = document.getElementById('history');
            let b = { "Sparkasse": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0 };
            if(!data.rows) return;

            data.rows.slice().reverse().forEach((r, idx) => {
                const trAmt = parseFloat(r[8]) || 0;
                const crAmt = parseFloat(r[10]) || 0;
                const acc = r[5];
                const cat = r[1];
                const isDel = String(r[3]).includes("[–£–î–ê–õ–ï–ù–û]");

                if (!isDel && b.hasOwnProperty(acc)) {
                    if (cat.includes('–î–æ—Ö–æ–¥')) b[acc] += Math.abs(crAmt || trAmt);
                    else b[acc] -= Math.abs(crAmt || trAmt);
                }

                if (!isDel && idx < 15) {
                    const isUah = acc.includes('UAH') || acc.includes('–ü—Ä–∏–≤–∞—Ç');
                    hist.innerHTML += `
                        <div class="bg-slate-900/40 p-4 rounded-[25px] flex justify-between items-center border border-slate-800 mb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-[10px] text-slate-500">
                                    <i class="fas ${cat.includes('–ü–µ—Ä–µ–≤–æ–¥')?'fa-exchange-alt':(cat.includes('–î–æ—Ö–æ–¥')?'fa-arrow-up':'fa-arrow-down')}"></i>
                                </div>
                                <div>
                                    <p class="text-[8px] text-slate-600 font-black uppercase">${r[0].split('T')[0]} | ${acc}</p>
                                    <p class="font-bold text-slate-200 text-xs">${r[2]}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs font-black ${cat.includes('–î–æ—Ö–æ–¥')?'text-emerald-500':'text-rose-500'}">${cat.includes('–î–æ—Ö–æ–¥')?'+':'-'}${Math.abs(crAmt || trAmt).toFixed(2)} ${isUah?'‚Ç¥':'‚Ç¨'}</p>
                                <div class="flex gap-2 mt-1 justify-end text-slate-700 text-[8px]">
                                    <i class="fas fa-pen"></i><i class="fas fa-trash"></i>
                                </div>
                            </div>
                        </div>`;
            });
            
            document.getElementById('acc-Sparkasse').innerText = '‚Ç¨ ' + b["Sparkasse"].toFixed(2);
            document.getElementById('acc-–ü—Ä–∏–≤–∞—Ç').innerText = '‚Ç¥ ' + b["–ü—Ä–∏–≤–∞—Ç"].toFixed(2);
            document.getElementById('acc-–ù–∞–ª–∏—á–Ω—ã–µ EUR').innerText = '‚Ç¨ ' + b["–ù–∞–ª–∏—á–Ω—ã–µ EUR"].toFixed(2);
            document.getElementById('acc-–ù–∞–ª–∏—á–Ω—ã–µ UAH').innerText = '‚Ç¥ ' + b["–ù–∞–ª–∏—á–Ω—ã–µ UAH"].toFixed(2);
            
            const total = b["Sparkasse"] + b["–ù–∞–ª–∏—á–Ω—ã–µ EUR"] + (b["–ü—Ä–∏–≤–∞—Ç"] + b["–ù–∞–ª–∏—á–Ω—ã–µ UAH"]) / parseFloat(document.getElementById('rate').value);
            document.getElementById('mainBalance').innerText = '‚Ç¨ ' + total.toFixed(2);
        }
        window.onload = load;
    </script>
</body>
</html>
