<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartWallet Ultimate v9.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .limit-danger { color: #f43f5e; animation: pulse-red 1s infinite; }
        .limit-warning { color: #f59e0b; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 p-4 pb-10">

    <div class="bg-gradient-to-br from-slate-900 to-slate-800 p-6 rounded-[35px] shadow-2xl mb-6 border border-slate-700/50 relative">
        <div class="flex justify-between items-center mb-4">
            <div class="flex gap-2">
                <div class="bg-slate-800 px-2 py-1 rounded-lg border border-slate-700">
                    <span class="text-[8px] text-slate-500 block uppercase font-bold text-center">–ö—É—Ä—Å</span>
                    <input type="number" id="rate" value="50.76" step="0.01" oninput="calcInfo()" class="w-10 bg-transparent outline-none text-[10px] font-bold text-yellow-400 text-center">
                </div>
                <div class="bg-slate-800 px-2 py-1 rounded-lg border border-slate-700">
                    <span class="text-[8px] text-slate-500 block uppercase font-bold text-center">–õ–∏–º–∏—Ç ‚Ç¨</span>
                    <input type="number" id="limit" value="100" step="10" oninput="checkLimit()" class="w-10 bg-transparent outline-none text-[10px] font-bold text-rose-400 text-center">
                </div>
            </div>
            <span class="text-[10px] font-black text-slate-600 uppercase italic">Finance Bot v9</span>
        </div>
        
        <div class="text-center py-2">
            <h1 id="mainBalance" class="text-5xl font-black tracking-tighter italic transition-all duration-500">‚Ç¨ 0.00</h1>
            <p id="statusText" class="text-[9px] text-slate-500 uppercase font-black tracking-widest mt-2">Safe Zone</p>
        </div>

        <div class="grid grid-cols-2 gap-2 mt-4 text-[9px]">
            <div class="bg-slate-900/50 p-3 rounded-2xl border border-blue-500/10">Sparkasse: <span id="acc-Sparkasse" class="block text-xs font-bold text-white tracking-tighter">‚Ç¨ 0.00</span></div>
            <div class="bg-slate-900/50 p-3 rounded-2xl border border-green-500/10">–ü—Ä–∏–≤–∞—Ç: <span id="acc-–ü—Ä–∏–≤–∞—Ç" class="block text-xs font-bold text-white tracking-tighter">‚Ç¥ 0.00</span></div>
            <div class="bg-slate-900/50 p-3 rounded-2xl border border-yellow-500/10">–ù–∞–ª ‚Ç¨: <span id="acc-–ù–∞–ª–∏—á–Ω—ã–µ EUR" class="block text-xs font-bold text-white tracking-tighter">‚Ç¨ 0.00</span></div>
            <div class="bg-slate-900/50 p-3 rounded-2xl border border-orange-500/10">–ù–∞–ª ‚Ç¥: <span id="acc-–ù–∞–ª–∏—á–Ω—ã–µ UAH" class="block text-xs font-bold text-white tracking-tighter">‚Ç¥ 0.00</span></div>
        </div>
    </div>

    <div class="flex gap-2 mb-8">
        <button onclick="openModal('expense')" class="flex-1 bg-rose-600 py-4 rounded-2xl font-black text-[10px] uppercase border-b-4 border-rose-900 shadow-lg active:scale-95 transition-all">–†–∞—Å—Ö–æ–¥</button>
        <button onclick="openModal('transfer')" class="flex-1 bg-slate-700 py-4 rounded-2xl font-black text-[10px] uppercase border-b-4 border-slate-900 shadow-lg active:scale-95 transition-all">–ü–µ—Ä–µ–≤–æ–¥</button>
        <button onclick="openModal('income')" class="flex-1 bg-emerald-600 py-4 rounded-2xl font-black text-[10px] uppercase border-b-4 border-emerald-900 shadow-lg active:scale-95 transition-all">–î–æ—Ö–æ–¥</button>
    </div>

    <div id="history" class="space-y-2"></div>

    <div id="modal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-md hidden flex items-center justify-center p-4 z-50">
        <div class="bg-slate-900 w-full max-w-sm rounded-[45px] p-8 border border-slate-800 shadow-2xl overflow-y-auto max-h-[95vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-xl font-black italic text-yellow-500 uppercase">–ó–ê–ü–ò–°–¨</h2>
                <button onclick="closeModal()" class="text-slate-600 text-3xl">&times;</button>
            </div>
            
            <form onsubmit="save(event)" class="space-y-4">
                <input type="hidden" id="txType">
                <input type="date" id="date" class="w-full bg-slate-800 border border-slate-700 rounded-2xl p-4 font-bold text-white outline-none">

                <div id="standardFields" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3" id="qtyPriceBlock">
                        <div class="bg-slate-800 p-4 rounded-3xl border border-slate-700" id="qtyContainer">
                            <label class="text-[9px] text-slate-500 block uppercase font-black mb-1">–ö–æ–ª-–≤–æ</label>
                            <input type="number" id="qty" value="1" step="1" oninput="calcInfo()" class="w-full bg-transparent text-xl font-black outline-none text-white text-center">
                        </div>
                        <div class="bg-slate-800 p-4 rounded-3xl border border-slate-700">
                            <label id="priceLabel" class="text-[9px] text-blue-400 block uppercase font-black mb-1 italic text-center">–°—É–º–º–∞</label>
                            <input type="number" id="price" step="0.01" oninput="calcInfo()" class="w-full bg-transparent text-xl font-black text-center outline-none text-white">
                        </div>
                    </div>
                    <div id="infoBox" class="bg-yellow-500/5 border border-yellow-500/10 p-3 rounded-2xl text-center hidden font-black text-yellow-500 text-xl tracking-tighter"></div>
                    
                    <input type="text" id="merchant" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ / –ú–∞–≥–∞–∑–∏–Ω" class="w-full bg-slate-800 border border-slate-700 rounded-2xl p-4 outline-none font-bold text-white placeholder:text-slate-600">
                    
                    <div id="itemsGroup" class="grid grid-cols-2 gap-2">
                        <input type="text" id="itemDE" placeholder="–¢–æ–≤–∞—Ä DE" class="bg-slate-800 border border-slate-700 rounded-2xl p-4 text-xs outline-none text-white placeholder:text-slate-600 font-medium">
                        <input type="text" id="itemRU" placeholder="–¢–æ–≤–∞—Ä RU" class="bg-slate-800 border border-slate-700 rounded-2xl p-4 text-xs outline-none text-white placeholder:text-slate-600 font-medium">
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <select id="acc" onchange="calcInfo()" class="bg-slate-800 border border-slate-700 rounded-2xl p-4 font-bold text-[10px] outline-none text-white">
                            <option value="Sparkasse">Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ù–∞–ª ‚Ç¥</option>
                        </select>
                        <select id="cat" class="bg-slate-800 border border-slate-700 rounded-2xl p-4 font-bold text-[10px] outline-none text-white">
                            <option>üçé –ü—Ä–æ–¥—É–∫—Ç—ã</option><option>üè† –î–æ–º</option><option>üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option>üç∑ –ê–ª–∫–æ–≥–æ–ª—å</option><option>üì¶ –ü—Ä–æ—á–µ–µ</option><option value="üíé –î–æ—Ö–æ–¥">üíé –î–æ—Ö–æ–¥</option>
                        </select>
                    </div>
                </div>

                <div id="transferFields" class="space-y-4 hidden">
                    <div class="grid grid-cols-2 gap-2">
                        <select id="tFrom" onchange="syncT()" class="bg-slate-800 border border-slate-700 rounded-2xl p-4 font-bold text-[10px] text-white outline-none"><option value="Sparkasse">–ò–∑ Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ò–∑ –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ò–∑ –ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ò–∑ –ù–∞–ª ‚Ç¥</option></select>
                        <select id="tTo" onchange="syncT()" class="bg-slate-800 border border-slate-700 rounded-2xl p-4 font-bold text-[10px] text-white outline-none"><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–í –ù–∞–ª ‚Ç¨</option><option value="–ü—Ä–∏–≤–∞—Ç">–í –ü—Ä–∏–≤–∞—Ç</option><option value="Sparkasse">–í Sparkasse</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–í –ù–∞–ª ‚Ç¥</option></select>
                    </div>
                    <div class="bg-slate-800 p-5 rounded-3xl border border-yellow-500/20">
                        <input type="number" id="tAmountFrom" placeholder="–°–£–ú–ú–ê –û–¢–ö–£–î–ê" oninput="syncT('from')" class="w-full bg-transparent text-xl font-black outline-none text-white mb-2">
                        <div class="border-t border-slate-700 my-2"></div>
                        <input type="number" id="tAmountTo" placeholder="–°–£–ú–ú–ê –ö–£–î–ê" oninput="syncT('to')" class="w-full bg-transparent text-xl font-black outline-none text-yellow-500">
                    </div>
                </div>

                <button id="saveBtn" type="submit" class="w-full bg-yellow-500 text-slate-950 py-5 rounded-[28px] font-black text-xl shadow-lg border-b-4 border-yellow-700 active:scale-95 transition-all">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzrq1Oszl7tuOHIvahkjzu4lSN1fDDfwkynYVQUht98wpgS7Y2FufLAWUbuFJYIhodh/exec";
        let globalBalance = 0;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, dur, type) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.value = freq; osc.connect(gain); gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime); osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + dur); osc.stop(audioCtx.currentTime + dur);
        }

        function isUah(acc) { return acc.includes('–ü—Ä–∏–≤–∞—Ç') || acc.includes('UAH'); }

        function checkLimit() {
            const limit = parseFloat(document.getElementById('limit').value) || 0;
            const el = document.getElementById('mainBalance');
            el.classList.remove('limit-warning', 'limit-danger');
            if (globalBalance < 0) { el.classList.add('limit-danger'); playTone(150, 0.6, 'sawtooth'); }
            else if (globalBalance < limit) { el.classList.add('limit-warning'); playTone(880, 0.1, 'sine'); }
        }

        function calcInfo() {
            const q = parseFloat(document.getElementById('qty').value) || 0;
            const p = parseFloat(document.getElementById('price').value) || 0;
            const r = parseFloat(document.getElementById('rate').value) || 50.76;
            const acc = document.getElementById('acc').value;
            const box = document.getElementById('infoBox');
            if (isUah(acc) && document.getElementById('txType').value === 'expense') {
                box.classList.remove('hidden'); box.innerText = (q * p * r).toFixed(2) + ' ‚Ç¥';
            } else { box.classList.add('hidden'); }
        }

        function syncT(origin) {
            const from = document.getElementById('tFrom').value, to = document.getElementById('tTo').value;
            const r = parseFloat(document.getElementById('rate').value) || 50.76;
            let f = parseFloat(document.getElementById('tAmountFrom').value) || 0, t = parseFloat(document.getElementById('tAmountTo').value) || 0;
            if (origin === 'from' || !origin) {
                t = (!isUah(from) && isUah(to)) ? f * r : (isUah(from) && !isUah(to) ? f / r : f);
                document.getElementById('tAmountTo').value = t.toFixed(2);
            } else {
                f = (isUah(to) && !isUah(from)) ? t / r : (!isUah(to) && isUah(from) ? t * r : t);
                document.getElementById('tAmountFrom').value = f.toFixed(2);
            }
        }

        function openModal(type) {
            document.getElementById('txType').value = type;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            const isT = type === 'transfer', isInc = type === 'income';
            document.getElementById('modalTitle').innerText = isInc ? '–ü–û–ü–û–õ–ù–ï–ù–ò–ï' : (isT ? '–ü–ï–†–ï–í–û–î' : '–†–ê–°–•–û–î');
            
            document.getElementById('standardFields').classList.toggle('hidden', isT);
            document.getElementById('transferFields').classList.toggle('hidden', !isT);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ª–∏—à–Ω–µ–µ –¥–ª—è –¥–æ—Ö–æ–¥–∞
            document.getElementById('qtyContainer').classList.toggle('hidden', isInc);
            document.getElementById('itemsGroup').classList.toggle('hidden', isInc);
            if(isInc) {
                document.getElementById('cat').value = "üíé –î–æ—Ö–æ–¥";
                document.getElementById('priceLabel').innerText = "–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è";
            } else {
                document.getElementById('cat').value = "üçé –ü—Ä–æ–¥—É–∫—Ç—ã";
                document.getElementById('priceLabel').innerText = "–¶–µ–Ω–∞";
            }
            if(isT) syncT(); else calcInfo();
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function save(e) {
            e.preventDefault();
            const btn = document.getElementById('saveBtn');
            const type = document.getElementById('txType').value;
            const rate = document.getElementById('rate').value;
            let payload =
