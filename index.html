<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartWallet Pro v13.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-950 text-slate-100 p-4 pb-10">

    <div class="bg-gradient-to-br from-slate-900 to-slate-800 p-6 rounded-[35px] shadow-2xl mb-6 border border-slate-700/50 text-center">
        <div class="flex justify-between items-center mb-4 text-[10px] font-bold opacity-60">
            <span>–ö–£–†–° ‚Ç¥: <input type="number" id="baseRate" value="50.76" step="0.01" oninput="drawBalance()" class="bg-transparent text-yellow-500 w-12 outline-none"></span>
            <span class="italic uppercase">Capital EUR</span>
        </div>
        <h1 id="mainBalance" class="text-5xl font-black italic mb-6 tracking-tighter transition-all">‚Ç¨ 0.00</h1>
        
        <div class="grid grid-cols-2 gap-3 text-[10px] font-bold uppercase tracking-tighter">
            <div class="bg-slate-800/40 p-3 rounded-2xl border border-blue-500/20 text-blue-400">Sparkasse: <span id="acc-Sparkasse" class="block text-white text-sm">‚Ç¨ 0.00</span></div>
            <div class="bg-slate-800/40 p-3 rounded-2xl border border-green-500/20 text-green-500">–ü—Ä–∏–≤–∞—Ç–ë–∞–Ω–∫: <span id="acc-–ü—Ä–∏–≤–∞—Ç" class="block text-white text-sm">‚Ç¥ 0.00</span><span id="eq-–ü—Ä–∏–≤–∞—Ç" class="block text-[8px] text-slate-500 mt-1">‚Ç¨ 0.00</span></div>
            <div class="bg-slate-800/40 p-3 rounded-2xl border border-yellow-500/20 text-yellow-500 text-[8px]">–ù–∞–ª–∏—á–Ω—ã–µ ‚Ç¨: <span id="acc-–ù–∞–ª–∏—á–Ω—ã–µ EUR" class="block text-white text-sm">‚Ç¨ 0.00</span></div>
            <div class="bg-slate-800/40 p-3 rounded-2xl border border-orange-500/20 text-orange-500 text-[8px]">–ù–∞–ª–∏—á–Ω—ã–µ ‚Ç¥: <span id="acc-–ù–∞–ª–∏—á–Ω—ã–µ UAH" class="block text-white text-sm">‚Ç¥ 0.00</span><span id="eq-–ù–∞–ª–∏—á–Ω—ã–µ UAH" class="block text-[8px] text-slate-500 mt-1">‚Ç¨ 0.00</span></div>
        </div>
    </div>

    <div class="flex gap-2 mb-8 font-black">
        <button onclick="openModal('expense')" class="flex-1 bg-rose-600 py-5 rounded-2xl text-[10px] uppercase border-b-4 border-rose-900 shadow-lg active:scale-95 transition-all">–†–∞—Å—Ö–æ–¥</button>
        <button onclick="openModal('transfer')" class="flex-1 bg-slate-700 py-5 rounded-2xl text-[10px] uppercase border-b-4 border-slate-900 active:scale-95 transition-all">–ü–µ—Ä–µ–≤–æ–¥</button>
        <button onclick="openModal('income')" class="flex-1 bg-emerald-600 py-5 rounded-2xl text-[10px] uppercase border-b-4 border-emerald-900 active:scale-95 transition-all">–î–æ—Ö–æ–¥</button>
    </div>

    <div id="history" class="space-y-2"></div>

    <div id="modal" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-slate-900 w-full max-w-sm rounded-[45px] p-8 border border-slate-800 shadow-2xl overflow-y-auto max-h-[95vh]">
            <h2 id="modalTitle" class="text-2xl font-black text-yellow-500 mb-6 italic uppercase tracking-tighter text-center italic underline underline-offset-8 decoration-yellow-500/20">–ó–∞–ø–∏—Å—å</h2>
            <form onsubmit="save(event)" class="space-y-4">
                <input type="hidden" id="txType">
                <input type="date" id="date" class="w-full bg-slate-800 p-4 rounded-2xl font-bold text-white outline-none border border-slate-700">

                <div id="standardFields" class="space-y-4">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-slate-800 p-3 rounded-2xl"><label class="text-[8px] text-slate-500 block uppercase mb-1">–ö–æ–ª-–≤–æ</label><input type="number" id="qty" value="1" oninput="calcInfo()" class="w-full bg-transparent text-xl font-bold outline-none"></div>
                        <div class="bg-slate-800 p-3 rounded-2xl border-2 border-slate-700 text-center"><label class="text-[8px] text-blue-400 block uppercase mb-1 italic font-black">–¶–µ–Ω–∞ ‚Ç¨ –∑–∞ –µ–¥.</label><input type="number" id="price" step="0.01" oninput="calcInfo()" class="w-full bg-transparent text-xl font-bold outline-none text-center"></div>
                    </div>
                    <div id="infoBox" class="bg-yellow-500/5 p-3 rounded-2xl text-center hidden font-black text-yellow-500 text-[10px] italic tracking-widest uppercase"></div>
                </div>

                <div id="transferFields" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-2 font-bold italic text-[10px] uppercase">
                        <select id="tFrom" onchange="syncT()" class="bg-slate-800 p-3 rounded-xl border border-slate-700"><option value="Sparkasse">–ò–∑ Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ò–∑ –ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ò–∑ –ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ò–∑ –ù–∞–ª ‚Ç¥</option></select>
                        <select id="tTo" onchange="syncT()" class="bg-slate-800 p-3 rounded-xl border border-slate-700 text-yellow-500"><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–í –ù–∞–ª ‚Ç¨</option><option value="–ü—Ä–∏–≤–∞—Ç">–í –ü—Ä–∏–≤–∞—Ç</option><option value="Sparkasse">–í Sparkasse</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–í –ù–∞–ª ‚Ç¥</option></select>
                    </div>
                    <div class="bg-slate-800 p-5 rounded-3xl border border-yellow-500/20 text-center shadow-inner">
                        <input type="number" id="tAmountFrom" step="0.01" oninput="syncT('from')" class="w-full bg-transparent text-3xl font-black outline-none mb-3" placeholder="0.00">
                        <div class="border-t border-slate-700 my-2 opacity-30"></div>
                        <input type="number" id="tAmountTo" step="0.01" oninput="syncT('to')" class="w-full bg-transparent text-3xl font-black outline-none text-yellow-500 mt-2" placeholder="0.00">
                    </div>
                    <div class="bg-slate-800 p-4 rounded-2xl flex justify-between items-center border border-slate-700 text-[10px] font-black uppercase tracking-widest"><span>–ö—É—Ä—Å:</span><input type="number" id="tExRate" step="0.01" oninput="syncT('from')" class="w-20 bg-transparent text-right text-yellow-500 outline-none text-lg"></div>
                </div>

                <input type="text" id="merchant" placeholder="–ú–∞–≥–∞–∑–∏–Ω / –û–ø–∏—Å–∞–Ω–∏–µ" class="w-full bg-slate-800 p-4 rounded-2xl outline-none font-bold placeholder:text-slate-600 border border-slate-800 focus:border-yellow-500/50">
                
                <div id="itemsGroup" class="grid grid-cols-2 gap-2"><input type="text" id="itemDE" placeholder="–¢–æ–≤–∞—Ä DE" class="bg-slate-800 p-3 rounded-xl text-xs outline-none"><input type="text" id="itemRU" placeholder="–¢–æ–≤–∞—Ä RU" class="bg-slate-800 p-3 rounded-xl text-xs outline-none"></div>
                
                <div id="accCatGroup" class="grid grid-cols-2 gap-2">
                    <select id="acc" onchange="calcInfo()" class="bg-slate-800 p-4 rounded-2xl font-bold text-xs outline-none border border-slate-700"><option value="Sparkasse">Sparkasse</option><option value="–ü—Ä–∏–≤–∞—Ç">–ü—Ä–∏–≤–∞—Ç</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ EUR">–ù–∞–ª ‚Ç¨</option><option value="–ù–∞–ª–∏—á–Ω—ã–µ UAH">–ù–∞–ª ‚Ç¥</option></select>
                    <select id="cat" class="bg-slate-800 p-4 rounded-2xl font-bold text-xs outline-none border border-slate-700"><option>üçé –ü—Ä–æ–¥—É–∫—Ç—ã</option><option>üè† –î–æ–º</option><option>üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option value="üíé –î–æ—Ö–æ–¥">üíé –î–æ—Ö–æ–¥</option></select>
                </div>

                <button id="saveBtn" class="w-full bg-yellow-500 text-black py-5 rounded-3xl font-black uppercase text-xl shadow-lg border-b-4 border-yellow-700 active:scale-95 transition-all">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyNHpLQLlYCo0fLd7IHq3slMmmIpFB6JQm1a0gFTxlXOp5JHCrVvZ8B3fAI9yxcsns/exec";
        let walletData = { "Sparkasse": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0 };

        function isUah(acc) { return acc.includes('–ü—Ä–∏–≤–∞—Ç') || acc.includes('UAH'); }

        function calcInfo() {
            const acc = document.getElementById('acc').value;
            const rate = parseFloat(document.getElementById('baseRate').value) || 50.76;
            const q = parseFloat(document.getElementById('qty').value) || 1;
            const p = parseFloat(document.getElementById('price').value) || 0;
            const box = document.getElementById('infoBox'); box.classList.remove('hidden');
            
            if (isUah(acc)) {
                box.innerText = "–°–ø–∏—Å–∞–Ω–∏–µ —Å –∫–∞—Ä—Ç—ã: ‚Ç¥ " + (q * p * rate).toFixed(2);
            } else {
                box.innerText = "–í –≥—Ä–∏–≤–Ω–µ —ç—Ç–æ: ‚Ç¥ " + (q * p * rate).toFixed(2);
            }
        }

        async function save(e) {
            e.preventDefault();
            const btn = document.getElementById('saveBtn'); btn.disabled = true; btn.innerText = "‚è≥ –ó–ê–ü–ò–°–¨...";
            const type = document.getElementById('txType').value;
            const rate = parseFloat(document.getElementById('baseRate').value);
            const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];
            let payload = { action: type, date: date, rate: rate, merchant: document.getElementById('merchant').value };

            if(type === 'transfer') {
                payload.fromAcc = document.getElementById('tFrom').value; payload.toAcc = document.getElementById('tTo').value;
                payload.amountFrom = parseFloat(document.getElementById('tAmountFrom').value);
                payload.amountTo = parseFloat(document.getElementById('tAmountTo').value);
                payload.fromCur = isUah(payload.fromAcc) ? "UAH" : "EUR"; payload.toCur = isUah(payload.toAcc) ? "UAH" : "EUR";
                payload.rate = parseFloat(document.getElementById('tExRate').value);
            } else {
                const q = parseFloat(document.getElementById('qty').value) || 1;
                const p = parseFloat(document.getElementById('price').value) || 0;
                const acc = document.getElementById('acc').value;
                const cat = document.getElementById('cat').value;
                const isInc = cat.includes('–î–æ—Ö–æ–¥') || cat.includes('üíé');
                
                payload.action = 'add'; payload.category = cat;
                payload.itemDE = document.getElementById('itemDE').value || "‚Äî";
                payload.itemRU = document.getElementById('itemRU').value || "‚Äî";
                payload.account = acc; payload.qty = q; payload.priceUnit = p;
                payload.curTran = "EUR"; // –í–∞–ª—é—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –í–°–ï–ì–î–ê EUR –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ J
                
                const totalEur = q * p;
                payload.totalTran = isInc ? totalEur : -totalEur; // –≠—Ç–æ –ø–æ–π–¥–µ—Ç –≤ –∫–æ–ª–æ–Ω–∫—É I
                
                if (isUah(acc)) {
                    payload.totalCard = isInc ? (totalEur * rate) : -(totalEur * rate); // –≠—Ç–æ –ø–æ–π–¥–µ—Ç –≤ –∫–æ–ª–æ–Ω–∫—É K
                    payload.curCard = "UAH";
                } else {
                    payload.totalCard = ""; // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –≤ –µ–≤—Ä–æ, –∫–æ–ª–æ–Ω–∫–∞ K –ø—É—Å—Ç–∞—è (—Ö–≤–∞—Ç–∞–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ I)
                    payload.curCard = "EUR";
                }
            }
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            location.reload();
        }

        function draw(data) {
            const hist = document.getElementById('history'); hist.innerHTML = "";
            walletData = { "Sparkasse": 0, "–ü—Ä–∏–≤–∞—Ç": 0, "–ù–∞–ª–∏—á–Ω—ã–µ EUR": 0, "–ù–∞–ª–∏—á–Ω—ã–µ UAH": 0 };
            if(!data.rows) return;
            data.rows.forEach(r => {
                const acc = r[5];
                if (walletData.hasOwnProperty(acc)) walletData[acc] += (isUah(acc) ? parseFloat(r[10]) : parseFloat(r[8])) || 0;
            });
            data.rows.slice().reverse().slice(0, 15).forEach(r => {
                const acc = r[5], isU = isUah(acc), val = Math.abs(isU ? r[10] : r[8]), isInc = (isU ? r[10] : r[8]) > 0;
                hist.innerHTML += `<div class="bg-slate-900/40 p-4 rounded-3xl flex justify-between items-center border border-slate-800 mb-2">
                    <div><p class="text-[9px] text-slate-600 font-bold uppercase italic">${r[0].split('T')[0].substring(5)} | ${acc}</p><p class="text-slate-200 text-xs font-bold">${r[2]}</p></div>
                    <div class="text-right">
                        <div class="font-black text-xs ${isInc?'text-emerald-500':'text-rose-500'} italic">${isInc?'+':'-'}${val.toFixed(2)} ${isU?'‚Ç¥':'‚Ç¨'}</div>
                        <div class="flex gap-2 justify-end mt-1 text-slate-700 text-[8px]"><i class="fas fa-pen"></i><i class="fas fa-trash"></i></div>
                    </div>
                </div>`;
            });
            drawBalance();
        }

        function drawBalance() {
            const r = parseFloat(document.getElementById('baseRate').value) || 50.76;
            for(let k in walletData) {
                const el = document.getElementById('acc-'+k);
                if(el) el.innerText = (isUah(k) ? '‚Ç¥ ' : '‚Ç¨ ') + walletData[k].toFixed(2);
                const eq = document.getElementById('eq-'+k);
                if(eq) eq.innerText = '‚Ç¨ ' + (walletData[k] / r).toFixed(2);
            }
            const total = walletData["Sparkasse"] + walletData["–ù–∞–ª–∏—á–Ω—ã–µ EUR"] + (walletData["–ü—Ä–∏–≤–∞—Ç"] + walletData["–ù–∞–ª–∏—á–Ω—ã–µ UAH"]) / r;
            document.getElementById('mainBalance').innerText = '‚Ç¨ ' + total.toFixed(2);
        }

        function syncT(origin) {
            const from = document.getElementById('tFrom').value, to = document.getElementById('tTo').value;
            const r = parseFloat(document.getElementById('tExRate').value) || parseFloat(document.getElementById('baseRate').value);
            let f = parseFloat(document.getElementById('tAmountFrom').value) || 0, t = parseFloat(document.getElementById('tAmountTo').value) || 0;
            if (origin === 'from' || !origin) {
                t = (!isUah(from) && isUah(to)) ? f * r : (isUah(from) && !isUah(to) ? f / r : f);
                document.getElementById('tAmountTo').value = t.toFixed(2);
            } else {
                f = (!isUah(from) && isUah(to)) ? t / r : (isUah(from) && !isUah(to) ? t * r : t);
                document.getElementById('tAmountFrom').value = f.toFixed(2);
            }
        }
        function openModal(type) {
            document.getElementById('txType').value = type;
            document.getElementById('modal').classList.remove('hidden');
            const isT = type === 'transfer', isInc = type === 'income';
            document.getElementById('modalTitle').innerText = isInc ? '–î–û–•–û–î' : (isT ? '–ü–ï–†–ï–í–û–î' : '–†–ê–°–•–û–î');
            document.getElementById('standardFields').classList.toggle('hidden', isT);
            document.getElementById('transferFields').classList.toggle('hidden', !isT);
            document.getElementById('qtyBox').classList.toggle('hidden', isInc);
            document.getElementById('itemsGroup').classList.toggle('hidden', isInc || isT);
            if(isInc) document.getElementById('cat').value = "üíé –î–æ—Ö–æ–¥";
            if(isT) { document.getElementById('tExRate').value = document.getElementById('baseRate').value; syncT(); } else calcInfo();
        }
        window.onload = () => { const t = new Date().getTime(); const s = document.createElement('script'); s.src = `${API_URL}?callback=draw&_t=${t}`; document.body.appendChild(s); };
    </script>
</body>
</html>
