<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Wallet Pro 3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cat-btn { transition: 0.2s; border: 1px solid #f1f5f9; }
        .selected-cat { background-color: #2563eb !important; color: white !important; border-color: #2563eb !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-10">
    <div class="max-w-md mx-auto p-4">
        <div id="rates-header" class="text-center text-[10px] font-bold text-blue-500 mb-4 uppercase italic">–ö—É—Ä—Å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
        
        <div class="bg-slate-900 rounded-[32px] p-6 text-white shadow-xl mb-6 text-center relative overflow-hidden">
            <p class="text-[10px] uppercase font-bold opacity-50 mb-1 tracking-widest">–û–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª (EUR)</p>
            <div id="total-val" class="text-4xl font-black italic tracking-tighter">0.00 ‚Ç¨</div>
        </div>

        <div id="balance-grid" class="grid grid-cols-2 gap-2 mb-6 text-[11px]"></div>

        <div class="bg-white p-5 rounded-[32px] shadow-xl border border-slate-100 mb-8">
            <div class="flex gap-1 mb-4 bg-slate-100 p-1 rounded-2xl">
                <button onclick="setMode('expense')" id="m-expense" class="flex-1 py-2 rounded-xl text-[10px] font-bold uppercase bg-white shadow-sm">–†–∞—Å—Ö–æ–¥</button>
                <button onclick="setMode('income')" id="m-income" class="flex-1 py-2 rounded-xl text-[10px] font-bold uppercase text-slate-400">–î–æ—Ö–æ–¥</button>
                <button onclick="setMode('transfer')" id="m-transfer" class="flex-1 py-2 rounded-xl text-[10px] font-bold uppercase text-slate-400">–ü–µ—Ä–µ–≤–æ–¥</button>
            </div>

            <input id="sum" type="number" placeholder="0.00" class="w-full text-5xl font-black text-center outline-none mb-4 text-blue-600">
            
            <input id="desc" type="text" placeholder="–ú–∞–≥–∞–∑–∏–Ω –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ..." class="w-full p-3 mb-4 bg-slate-50 rounded-xl text-sm font-semibold border-none text-center outline-none">

            <div id="acc-box" class="space-y-2 mb-4">
                <select id="acc1" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center border-none text-sm appearance-none cursor-pointer"></select>
                <div id="to-arrow" class="hidden text-center text-blue-500 text-xs font-bold">‚¨áÔ∏è –ü–ï–†–ï–í–û–î –ù–ê ‚¨áÔ∏è</div>
                <select id="acc2" class="hidden w-full p-3 bg-slate-50 rounded-xl font-bold text-center border-none text-sm appearance-none cursor-pointer"></select>
            </div>

            <div id="cats" class="flex flex-wrap gap-1.5 justify-center mb-6"></div>
            
            <button onclick="save()" id="save-btn" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition-transform">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>

        <h3 class="text-[10px] font-black uppercase text-slate-400 mb-3 px-2 tracking-widest">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h3>
        <div id="history" class="space-y-3"></div>
    </div>

    <script>
        const GOOGLE_URL = "–í–ê–®–ê_–°–°–´–õ–ö–ê_–û–¢_GOOGLE"; 
        window.mode = 'expense'; window.cat = '–†–∞–∑–Ω–æ–µ'; window.currentRate = 42.0; window.editId = null;

        const accounts = {
            sparkasse: {n: 'Sparkasse', c: 'EUR'}, casheur: {n: '–ù–∞–ª EUR', c: 'EUR'},
            uahcard: {n: 'UAH Card', c: 'UAH'}, cashuah: {n: '–ù–∞–ª UAH', c: 'UAH'}
        };

        const catData = {
            expense: ['üõí –ü—Ä–æ–¥—É–∫—Ç—ã (Lidl/Rewe)', '‚òï –ö–∞—Ñ–µ/–ï–¥–∞', 'üöó –¢–æ–ø–ª–∏–≤–æ/–ê–≤—Ç–æ', 'üöå –û–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—Ä.', 'üè† –ê—Ä–µ–Ω–¥–∞/–î–æ–º', 'üíä –ó–¥–æ—Ä–æ–≤—å–µ', 'üõçÔ∏è –û–¥–µ–∂–¥–∞/–®–æ–ø–∏–Ω–≥', 'üì± –°–≤—è–∑—å/–ò–Ω—Ç–µ—Ä–Ω–µ—Ç', 'üéÅ –ü–æ–¥–∞—Ä–∫–∏', '‚ùì –†–∞–∑–Ω–æ–µ'],
            income: ['üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞', 'üéÅ –ü–æ–¥–∞—Ä–æ–∫', 'üìà –ü—Ä–æ—Ü–µ–Ω—Ç', 'üíµ –í–æ–∑–≤—Ä–∞—Ç'],
            transfer: ['‚ôªÔ∏è –ü–µ—Ä–µ–≤–æ–¥/–û–±–º–µ–Ω']
        };

        async function updateRate() {
            try {
                const r = await fetch('https://open.er-api.com/v6/latest/EUR');
                const d = await r.json(); window.currentRate = d.rates.UAH;
                document.getElementById('rates-header').innerText = `–ö—É—Ä—Å: 1 ‚Ç¨ = ${window.currentRate.toFixed(2)} ‚Ç¥`;
            } catch(e) {}
        }

        function setMode(m) {
            window.mode = m;
            ['expense', 'income', 'transfer'].forEach(k => {
                document.getElementById('m-'+k).className = m === k ? 'flex-1 py-2 rounded-xl text-[10px] font-bold uppercase bg-white shadow-sm' : 'flex-1 py-2 rounded-xl text-[10px] font-bold uppercase text-slate-400';
            });
            document.getElementById('acc2').classList.toggle('hidden', m!=='transfer');
            document.getElementById('to-arrow').classList.toggle('hidden', m!=='transfer');
            renderCats();
        }

        function renderCats() {
            document.getElementById('cats').innerHTML = catData[window.mode].map(c => `
                <button onclick="window.cat='${c}';renderCats()" class="px-3 py-2 rounded-xl text-[9px] font-bold border cat-btn ${window.cat===c?'selected-cat':'bg-white text-slate-500'}">${c}</button>
            `).join('');
        }

        async function save() {
            const amount = parseFloat(document.getElementById('sum').value);
            const desc = document.getElementById('desc').value;
            if(!amount) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
            
            document.getElementById('save-btn').innerText = "–û–ë–†–ê–ë–û–¢–ö–ê...";
            
            // –ï—Å–ª–∏ –º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º ‚Äî —Å–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å
            if(window.editId) {
                await fetch(GOOGLE_URL, {method:"POST", mode:"no-cors", body: JSON.stringify({action:"delete", id: window.editId})});
            }

            let ops = [];
            if(window.mode === 'transfer') {
                ops.push({type:'expense', amount, account: document.getElementById('acc1').value, category:'‚ôªÔ∏è –ü–µ—Ä–µ–≤–æ–¥', desc: desc, rate: window.currentRate});
                ops.push({type:'income', amount, account: document.getElementById('acc2').value, category:'‚ôªÔ∏è –ü–µ—Ä–µ–≤–æ–¥', desc: desc, rate: window.currentRate});
            } else {
                ops.push({type:window.mode, amount, account: document.getElementById('acc1').value, category:window.cat, desc: desc, rate: window.currentRate});
            }
            
            for(let op of ops) await fetch(GOOGLE_URL, {method:"POST", mode:"no-cors", body: JSON.stringify(op)});
            location.reload();
        }

        function startEdit(id, amt, acc, ct, ds, type) {
            window.editId = id;
            window.mode = type;
            document.getElementById('sum').value = amt;
            document.getElementById('desc').value = ds;
            document.getElementById('acc1').value = acc;
            window.cat = ct;
            setMode(type);
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('save-btn').innerText = "–û–ë–ù–û–í–ò–¢–¨ –ó–ê–ü–ò–°–¨";
            document.getElementById('save-btn').className = "w-full bg-orange-500 text-white py-4 rounded-2xl font-black shadow-lg";
        }

        async function deleteItem(id) {
            if(!confirm("–£–¥–∞–ª–∏—Ç—å –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?")) return;
            await fetch(GOOGLE_URL, {method:"POST", mode:"no-cors", body: JSON.stringify({action:"delete", id: id})});
            location.reload();
        }

        async function load() {
            const r = await fetch(GOOGLE_URL);
            const data = await r.json();
            let bals = {sparkasse:0, casheur:0, uahcard:0, cashuah:0}, hist = "";
            let runningTotalEur = 0;

            // –°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—á–∏—Ç–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
            const rows = data.slice(1);
            
            rows.forEach((row, index) => {
                const [type, date, title, desc, amt, cur, cat, acc, rate] = row;
                const val = parseFloat(amt);
                const currentOpRate = parseFloat(rate) || window.currentRate;

                if(bals.hasOwnProperty(acc)) bals[acc] += (type==='income' ? val : -val);
                
                // –°—á–∏—Ç–∞–µ–º –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –≤ EUR –Ω–∞ –¢–ï–ö–£–©–ò–ô –º–æ–º–µ–Ω—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                let instantTotal = bals.sparkasse + bals.casheur + (bals.uahcard / currentOpRate) + (bals.cashuah / currentOpRate);

                hist = `<div class="bg-white p-4 rounded-[24px] shadow-sm border border-slate-100 mb-3">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-black text-sm text-slate-800">${cat}</p>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tight">${desc || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-sm ${type==='income'?'text-green-500':'text-red-500'}">${type==='income'?'+':'-'}${val.toFixed(2)}</p>
                            <p class="text-[9px] text-slate-300 font-bold italic">–∫—É—Ä—Å ${currentOpRate.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-slate-50">
                        <div class="flex gap-3">
                            <button onclick="startEdit('${date}', ${val}, '${acc}', '${cat}', '${desc}', '${type}')" class="text-blue-400 text-xs">‚úèÔ∏è</button>
                            <button onclick="deleteItem('${date}')" class="text-slate-300 text-xs">üóëÔ∏è</button>
                        </div>
                        <div class="text-[9px] font-black text-slate-400 uppercase">
                            –í—Å–µ–≥–æ: <span class="text-slate-900">${instantTotal.toFixed(2)} ‚Ç¨</span>
                        </div>
                    </div>
                </div>` + hist;
            });

            const finalTotal = bals.sparkasse + bals.casheur + (bals.uahcard / window.currentRate) + (bals.cashuah / window.currentRate);
            document.getElementById('total-val').innerText = finalTotal.toLocaleString(undefined, {minimumFractionDigits:2}) + ' ‚Ç¨';

            document.getElementById('balance-grid').innerHTML = Object.entries(bals).map(([id, v]) => `
                <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm">
                    <p class="text-[8px] text-slate-400 uppercase font-black mb-1 leading-none">${accounts[id].n}</p>
                    <p class="font-bold ${v<0?'text-red-500':'text-slate-800'}">${v.toFixed(2)} ${accounts[id].c==='EUR'?'‚Ç¨':'‚Ç¥'}</p>
                </div>`).join('');
            document.getElementById('history').innerHTML = hist || '<p class="text-center text-slate-300 py-10">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
        }

        const accSelects = Object.entries(accounts).map(([id, a]) => `<option value="${id}">${a.n} (${a.c})</option>`).join('');
        document.getElementById('acc1').innerHTML = accSelects;
        document.getElementById('acc2').innerHTML = accSelects;

        updateRate().then(load);
        setMode('expense');
    </script>
</body>
</html>
