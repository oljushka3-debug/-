<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Wallet Privat Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cat-btn { transition: 0.2s; border: 1px solid #f1f5f9; white-space: nowrap; }
        .selected-cat { background-color: #2563eb !important; color: white !important; border-color: #2563eb !important; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-10">
    <div class="max-w-md mx-auto p-4">
        <div id="rates-header" class="text-center text-[10px] font-bold text-blue-500 mb-4 uppercase italic tracking-widest text-slate-400">–ö—É—Ä—Å –ü—Ä–∏–≤–∞—Ç–ë–∞–Ω–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è...</div>
        
        <div class="bg-slate-900 rounded-[32px] p-6 text-white shadow-xl mb-6 text-center">
            <p class="text-[10px] uppercase font-bold opacity-50 mb-1 tracking-tighter">–í–∞—à –∫–∞–ø–∏—Ç–∞–ª –≤ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–µ EUR</p>
            <div id="total-val" class="text-4xl font-black italic tracking-tighter">0.00 ‚Ç¨</div>
        </div>

        <div id="balance-grid" class="grid grid-cols-2 gap-2 mb-6"></div>

        <div class="bg-white p-5 rounded-[32px] shadow-xl border border-slate-100 mb-8">
            <div class="flex gap-1 mb-4 bg-slate-100 p-1 rounded-2xl">
                <button onclick="setMode('expense')" id="m-expense" class="flex-1 py-2 rounded-xl text-[10px] font-bold uppercase bg-white shadow-sm">–†–∞—Å—Ö–æ–¥</button>
                <button onclick="setMode('income')" id="m-income" class="flex-1 py-2 rounded-xl text-[10px] font-bold uppercase text-slate-400">–î–æ—Ö–æ–¥</button>
                <button onclick="setMode('transfer')" id="m-transfer" class="flex-1 py-2 rounded-xl text-[10px] font-bold uppercase text-slate-400">–ü–µ—Ä–µ–≤–æ–¥</button>
            </div>

            <div class="text-center mb-4">
                <input id="sum" type="number" placeholder="0.00" class="w-full text-5xl font-black text-center outline-none text-blue-600 mb-1">
                <p id="convert-hint" class="text-[10px] font-bold text-green-600 uppercase h-4"></p>
            </div>
            
            <div class="space-y-2 mb-4 text-center">
                <select id="acc1" onchange="updateHint()" class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none text-sm appearance-none"></select>
                <div id="to-arrow" class="hidden text-blue-500 text-xs font-bold">‚¨áÔ∏è –ü–ï–†–ï–í–û–î ‚¨áÔ∏è</div>
                <select id="acc2" class="hidden w-full p-3 bg-slate-50 rounded-xl font-bold border-none text-sm appearance-none"></select>
            </div>

            <div id="cats" class="flex overflow-x-auto gap-2 mb-4 pb-2 px-1"></div>
            <select id="subcat-select" class="w-full p-3 bg-blue-50 text-blue-700 rounded-xl font-bold text-center border-none text-sm appearance-none mb-4"></select>
            
            <input id="desc" type="text" placeholder="–ú–∞–≥–∞–∑–∏–Ω / –û–ø–∏—Å–∞–Ω–∏–µ" class="w-full p-3 mb-6 bg-slate-50 rounded-xl text-sm font-semibold border-none text-center outline-none">
            
            <button onclick="save()" id="save-btn" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg uppercase tracking-widest">–ó–∞–ø–∏—Å–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</button>
        </div>

        <h3 class="text-[10px] font-black uppercase text-slate-400 mb-3 px-2 tracking-widest font-bold">–ò—Å—Ç–æ—Ä–∏—è (—Å—á–µ—Ç–∞ –∏ –æ—Å—Ç–∞—Ç–∫–∏)</h3>
        <div id="history" class="space-y-3"></div>
    </div>

    <script>
        const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbzGJ9_5qateBOvSJCObuRaoqdj_DRDnoR7o7TPUoXpc80pkNwhSYNFh39e1W1MbtiHUKg/exec"; 
        window.mode = 'expense'; window.cat = '–ü—Ä–æ–¥—É–∫—Ç—ã'; window.currentRate = 43.5; window.editId = null;

        const accounts = {
            sparkasse: {n: 'Sparkasse', c: 'EUR'}, casheur: {n: '–ù–∞–ª–∏—á–Ω—ã–µ EUR', c: 'EUR'},
            uahcard: {n: '–ü—Ä–∏–≤–∞—Ç UAH', c: 'UAH'}, cashuah: {n: '–ù–∞–ª–∏—á–Ω—ã–µ UAH', c: 'UAH'}
        };

        const taxonomy = {
            expense: {
                '–ü—Ä–æ–¥—É–∫—Ç—ã': ['Lidl', 'Rewe', 'Aldi', 'Netto', 'Edeka', 'Kaufland', '–î—Ä—É–≥–æ–µ'],
                '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç': ['–ë–µ–Ω–∑–∏–Ω/–î–∏–∑–µ–ª—å', '–ü–∞—Ä–∫–æ–≤–∫–∞', '–ë–∏–ª–µ—Ç—ã (DB)', '–¢–∞–∫—Å–∏'],
                '–ï–¥–∞ –≤–Ω–µ –¥–æ–º–∞': ['–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω', 'D√∂ner/–§–∞—Å—Ç—Ñ—É–¥', '–ö–æ—Ñ–µ'],
                '–î–æ–º/–°–µ–º—å—è': ['–ê—Ä–µ–Ω–¥–∞', '–°–≤—è–∑—å/–ò–Ω—Ç–µ—Ä–Ω–µ—Ç', '–ê–ø—Ç–µ–∫–∞', '–®–æ–ø–∏–Ω–≥'],
                '–†–∞–∑–Ω–æ–µ': ['–ö–æ–º–∏—Å—Å–∏—è', '–°–Ω—è—Ç–∏–µ', '–î—Ä—É–≥–æ–µ']
            },
            income: { '–î–æ—Ö–æ–¥—ã': ['–ó–∞—Ä–ø–ª–∞—Ç–∞', '–ü–æ–º–æ—â—å', '–ü–æ–¥–∞—Ä–æ–∫'] },
            transfer: { '–û–±–º–µ–Ω': ['–ü–µ—Ä–µ–≤–æ–¥', '–û–±–º–µ–Ω –≤–∞–ª—é—Ç—ã'] }
        };

        async function updateRate() {
            try {
                const r = await fetch('https://open.er-api.com/v6/latest/EUR');
                const d = await r.json(); 
                // –ü—Ä–∏–≤–∞—Ç–±–∞–Ω–∫ –æ–±—ã—á–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç ~3-4% –∫ —Ä—ã–Ω–æ—á–Ω–æ–º—É –∫—É—Ä—Å—É –¥–ª—è –∫–∞—Ä—Ç
                window.currentRate = d.rates.UAH * 1.035; 
                document.getElementById('rates-header').innerText = `–ö—É—Ä—Å –ü—Ä–∏–≤–∞—Ç (–∫–∞—Ä—Ç–∞): ~${window.currentRate.toFixed(2)} ‚Ç¥`;
            } catch(e) {}
        }

        function updateHint() {
            const acc = document.getElementById('acc1').value;
            const hint = document.getElementById('convert-hint');
            if(acc === 'uahcard' && window.mode === 'expense') {
                hint.innerText = "–°—É–º–º–∞ –≤ ‚Ç¨ (—Å–ø–∏—à–µ–º —Å –ü—Ä–∏–≤–∞—Ç–∞ –≤ ‚Ç¥)";
            } else { hint.innerText = ""; }
        }

        function setMode(m) {
            window.mode = m; window.cat = Object.keys(taxonomy[m])[0];
            ['expense', 'income', 'transfer'].forEach(k => {
                document.getElementById('m-'+k).className = m === k ? 'flex-1 py-2 rounded-xl text-[10px] font-bold uppercase bg-white shadow-sm' : 'flex-1 py-2 rounded-xl text-[10px] font-bold uppercase text-slate-400';
            });
            document.getElementById('acc2').classList.toggle('hidden', m!=='transfer');
            document.getElementById('to-arrow').classList.toggle('hidden', m!=='transfer');
            updateHint(); renderCats();
        }

        function renderCats() {
            const catList = Object.keys(taxonomy[window.mode]);
            document.getElementById('cats').innerHTML = catList.map(c => `
                <button onclick="window.cat='${c}';renderCats()" class="px-4 py-2 rounded-xl text-[10px] font-bold border cat-btn ${window.cat===c?'selected-cat':'bg-white text-slate-500'}">${c}</button>
            `).join('');
            const subCats = taxonomy[window.mode][window.cat] || [];
            document.getElementById('subcat-select').innerHTML = subCats.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        async function save() {
            let amount = parseFloat(document.getElementById('sum').value);
            const acc = document.getElementById('acc1').value;
            const subcat = document.getElementById('subcat-select').value;
            const shop = document.getElementById('desc').value;
            if(!amount) return;
            
            document.getElementById('save-btn').innerText = "–°–û–•–†–ê–ù–Ø–Æ –í –¢–ê–ë–õ–ò–¶–£...";
            if(window.editId) await fetch(GOOGLE_URL, {method:"POST", mode:"no-cors", body: JSON.stringify({action:"delete", id: window.editId})});

            let finalAmount = amount;
            let comment = shop;
            
            // –°–ø–µ—Ü–∏—Ñ–∏–∫–∞ –ü–†–ò–í–ê–¢–ê: —Ä–∞—Å—á–µ—Ç –≤ –µ–≤—Ä–æ -> —Å–ø–∏—Å–∞–Ω–∏–µ –≤ –≥—Ä–∏–≤–Ω–∞—Ö
            if(acc === 'uahcard' && window.mode === 'expense') {
                finalAmount = amount * window.currentRate;
                comment = `[${amount}‚Ç¨ –ø–æ ${window.currentRate.toFixed(1)}] ${shop}`;
            }

            let ops = [];
            if(window.mode === 'transfer') {
                ops.push({type:'expense', amount: finalAmount, account: acc, category:'‚ôªÔ∏è –ü–µ—Ä–µ–≤–æ–¥', desc: comment, rate: window.currentRate});
                ops.push({type:'income', amount: finalAmount, account: document.getElementById('acc2').value, category:'‚ôªÔ∏è –ü–µ—Ä–µ–≤–æ–¥', desc: comment, rate: window.currentRate});
            } else {
                ops.push({type:window.mode, amount: finalAmount, account: acc, category: `${window.cat}: ${subcat}`, desc: comment, rate: window.currentRate});
            }
            
            for(let op of ops) await fetch(GOOGLE_URL, {method:"POST", mode:"no-cors", body: JSON.stringify(op)});
            location.reload();
        }

        async function deleteItem(id) {
            if(!confirm("–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é?")) return;
            await fetch(GOOGLE_URL, {method:"POST", mode:"no-cors", body: JSON.stringify({action:"delete", id: id})});
            location.reload();
        }

        function startEdit(id, amt, acc, ct, ds, type) {
            window.editId = id; window.mode = type;
            document.getElementById('sum').value = amt;
            document.getElementById('desc').value = ds;
            document.getElementById('acc1').value = acc;
            window.cat = ct.split(':')[0];
            setMode(type);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function load() {
            const r = await fetch(GOOGLE_URL);
            const data = await r.json();
            let bals = {sparkasse:0, casheur:0, uahcard:0, cashuah:0}, hist = "";
            data.slice(1).forEach((row) => {
                const [type, date, title, desc, amt, cur, cat, acc, rate] = row;
                const val = parseFloat(amt);
                const rVal = parseFloat(rate) || window.currentRate;
                if(bals.hasOwnProperty(acc)) bals[acc] += (type==='income' ? val : -val);
                let instantTotal = bals.sparkasse + bals.casheur + (bals.uahcard / rVal) + (bals.cashuah / rVal);

                hist = `<div class="bg-white p-4 rounded-[28px] shadow-sm border border-slate-100 mb-3">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-black text-xs text-slate-800">${cat}</p>
                            <p class="text-[9px] text-slate-400 font-bold uppercase">${desc || '-'}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-sm ${type==='income'?'text-green-500':'text-red-500'}">${type==='income'?'+':'-'}${val.toFixed(2)} ${accounts[acc].c==='EUR'?'‚Ç¨':'‚Ç¥'}</p>
                            <p class="text-[8px] text-slate-300 font-bold uppercase">${accounts[acc].n}</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-slate-50">
                        <div class="flex gap-4">
                            <button onclick="startEdit('${date}', ${val}, '${acc}', '${cat}', '${desc}', '${type}')" class="text-blue-400 font-bold text-[9px] uppercase">‚úèÔ∏è –ü—Ä–∞–≤–∫–∞</button>
                            <button onclick="deleteItem('${date}')" class="text-slate-300">üóëÔ∏è</button>
                        </div>
                        <div class="text-[9px] font-black text-slate-400 uppercase bg-slate-50 px-2 py-1 rounded-lg">
                            –ò—Ç–æ–≥: <span class="text-slate-900">${instantTotal.toFixed(2)} ‚Ç¨</span>
                        </div>
                    </div>
                </div>` + hist;
            });

            const finalTotal = bals.sparkasse + bals.casheur + (bals.uahcard / window.currentRate) + (bals.cashuah / window.currentRate);
            document.getElementById('total-val').innerText = finalTotal.toLocaleString(undefined, {minimumFractionDigits:2}) + ' ‚Ç¨';
            document.getElementById('balance-grid').innerHTML = Object.entries(bals).map(([id, v]) => `
                <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm text-center">
                    <p class="text-[8px] text-slate-400 uppercase font-black mb-1 leading-none">${accounts[id].n}</p>
                    <p class="font-bold text-[13px] tracking-tighter ${v<0?'text-red-500':'text-slate-800'}">${v.toFixed(2)} ${accounts[id].c==='EUR'?'‚Ç¨':'‚Ç¥'}</p>
                </div>`).join('');
            document.getElementById('history').innerHTML = hist;
        }

        const accSelects = Object.entries(accounts).map(([id, a]) => `<option value="${id}">${a.n} (${a.c})</option>`).join('');
        document.getElementById('acc1').innerHTML = accSelects;
        document.getElementById('acc2').innerHTML = accSelects;

        updateRate().then(load);
        setMode('expense');
    </script>
</body>
</html>
